<!-- O c√≥digo JavaScript deve estar apenas dentro das tags <script> no final do arquivo. Nenhuma fun√ß√£o deve aparecer fora do <script>. -->
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Controle de Atividades ‚Äî Dashboard & Anexos</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Chart.js DataLabels Plugin -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  <script>
    // Registrar o plugin globalmente para evitar erros
    window.addEventListener('DOMContentLoaded', function() {
      if (window.Chart && window.ChartDataLabels) {
        Chart.register(window.ChartDataLabels);
      }
    });
  </script>
  <!-- Supabase JS CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- jsPDF e autotable para exporta√ß√£o PDF profissional -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
  <!-- Google Fonts para melhor tipografia -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* Responsividade para rota√ß√£o horizontal em dispositivos m√≥veis */
    @media screen and (max-width: 900px) and (orientation: landscape) {
      /* Cards de KPI em linha √∫nica com rolagem horizontal */
      #kpiCards {
        display: flex !important;
        flex-direction: row !important;
        overflow-x: auto !important;
        gap: 0.5rem !important;
        padding-bottom: 0.5rem;
      }
      #kpiCards > div {
        min-width: 160px !important;
        max-width: 220px !important;
        flex: 0 0 auto !important;
        border-radius: 1rem !important;
        margin: 0 !important;
      }
      html, body {
        font-size: 0.95rem;
        padding: 0;
        margin: 0;
        overflow-x: auto;
      }
      .max-w-7xl {
        max-width: 100vw;
        padding: 0.5rem !important;
      }
      header, section, .bg-white, .rounded-2xl, .shadow, .p-4 {
        border-radius: 0 !important;
        box-shadow: none !important;
        padding-left: 0.5rem !important;
        padding-right: 0.5rem !important;
      }
      .grid, .grid-cols-2, .grid-cols-4, .grid-cols-6, .grid-cols-1, .lg\:grid-cols-2 {
        grid-template-columns: 1fr !important;
      }
      /* Filtros em coluna, n√£o em linha */
      form[role="search"], .filtros-mobile-col {
        flex-direction: column !important;
        align-items: stretch !important;
        gap: 0.5rem !important;
      }
      /* Tabela com rolagem horizontal */
      .tabela-responsive, table {
        display: block;
        width: 100vw !important;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
      th, td {
        white-space: nowrap;
        font-size: 0.95em;
        min-width: 110px;
      }
      #statusChart, #priorityChart {
        min-width: 320px !important;
        max-width: 100vw !important;
        height: 220px !important;
      }
      .offcanvasRelatorios, #offcanvasRelatorios {
        width: 100vw !important;
        max-width: 100vw !important;
      }
    }
    /* Paleta para gr√°ficos Chart.js (usada via getComputedStyle) */
    :root {
  --chart-bg: #fff;
  --chart-fg: #0f172a;
  --chart-emerald: #3ba97d;
  --chart-sky: #2586b6;
  --chart-amber: #bfa13b;
  --chart-rose: #b85c6b;
  --chart-slate: #6b7a8c;
    }
    * { scrollbar-width: thin; scrollbar-color: #CBD5E1 transparent; }
    ::-webkit-scrollbar { height: 8px; width: 8px; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 9999px; }
    ::-webkit-scrollbar-track { background: transparent; }
    .dropzone {
      border: 2px dashed #94a3b8; border-radius: 1rem; transition: all .15s ease;
    }
    .dropzone.dragover { border-color: #0ea5e9; background: #f0f9ff; }
    #statusChart, #priorityChart {
      height: 280px !important;
      max-height: 280px;
      min-height: 140px;
      width: 100% !important;
      max-width: 100%;
      display: block;
      margin: 0 auto;
    }
  </style>
</head>
<body class="bg-slate-50 text-slate-800" style="font-family: 'Inter', sans-serif;">
  
  <!-- TELA DE LOGIN -->
  <div id="loginScreen" class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-8">
      <!-- Logo/Header -->
      <div class="text-center mb-8">
        <div class="inline-flex items-center justify-center w-16 h-16 bg-blue-100 rounded-full mb-4">
          <svg width="32" height="32" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" class="text-blue-600">
            <circle cx="12" cy="12" r="10"/>
            <path d="M8 12h8M12 8v8"/>
          </svg>
        </div>
        <h1 class="text-2xl font-bold text-gray-900 mb-2">Plano de A√ß√£o</h1>
        <p class="text-gray-600">Sistema de Controle de Atividades</p>
      </div>

      <!-- Formul√°rio de Login com Email -->
      <form id="loginForm" class="space-y-4">
        <div>
          <label for="emailInput" class="block text-sm font-medium text-gray-700 mb-2">Email</label>
          <input type="email" id="emailInput" required 
                 class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                 placeholder="seu@email.com">
        </div>
        <button type="submit" class="w-full bg-blue-600 text-white rounded-lg px-4 py-3 hover:bg-blue-700 transition-colors duration-200 font-medium">
          üìß Enviar C√≥digo de Verifica√ß√£o
        </button>
      </form>

      <!-- Formul√°rio de C√≥digo de Verifica√ß√£o (inicialmente oculto) -->
      <form id="codeForm" class="space-y-4 hidden">
        <div class="text-center mb-4">
          <p class="text-sm text-gray-600">
            üìß C√≥digo enviado para <strong id="sentToEmail"></strong>
          </p>
        </div>
        <div>
          <label for="codeInput" class="block text-sm font-medium text-gray-700 mb-2">
            C√≥digo de Verifica√ß√£o 
            <span class="text-xs text-gray-500">(6 d√≠gitos recebidos por email)</span>
          </label>
          <input type="text" id="codeInput" maxlength="8" 
                 class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-center text-xl font-mono tracking-widest"
                 placeholder="123456">
        </div>
        <button type="submit" class="w-full bg-green-600 text-white rounded-lg px-4 py-3 hover:bg-green-700 transition-colors duration-200 font-medium">
          Verificar C√≥digo
        </button>
        <button type="button" id="backToEmail" class="w-full bg-gray-500 text-white rounded-lg px-4 py-2 hover:bg-gray-600 transition-colors duration-200 text-sm">
          ‚Üê Voltar ao Email
        </button>
      </form>

      <!-- Loading State -->
      <div id="loginLoading" class="hidden w-full bg-blue-600 rounded-lg px-4 py-3 flex items-center justify-center gap-3 text-white">
        <svg class="animate-spin h-5 w-5" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"/>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"/>
        </svg>
        <span>Conectando...</span>
      </div>

      <!-- Footer -->
      <div class="mt-8 text-center">
        <p class="text-sm text-gray-500">
          Acesso restrito a usu√°rios autorizados
        </p>
        <div class="mt-4 p-3 bg-blue-50 rounded-lg border-l-4 border-blue-400">
          <p class="text-xs text-blue-700">
            <strong>üîê Acesso Seguro</strong><br>
            Enviaremos um c√≥digo de 6 d√≠gitos<br>
            para seu email. Sem links, apenas c√≥digo!
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- APLICA√á√ÉO PRINCIPAL (inicialmente oculta) -->
  <div id="appContent" class="hidden max-w-7xl mx-auto p-4 md:p-6" role="main" aria-label="Painel de atividades">
    <!-- UI: Header aprimorado com barra de a√ß√µes, √≠cones SVG, toggle de tema -->
    <header class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
      <div class="flex items-center gap-3">
        <span class="inline-flex items-center justify-center rounded-full bg-sky-100 dark:bg-sky-900 p-2">
          <!-- UI: √çcone SVG do app -->
          <svg width="28" height="28" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" class="text-sky-600 dark:text-sky-400"><circle cx="12" cy="12" r="10"/><path d="M8 12h8M12 8v8"/></svg>
        </span>
        <div>
          <h1 class="text-2xl md:text-3xl font-bold tracking-tight text-black">Controle de Atividades</h1>
          <p class="text-slate-600 dark:text-slate-400 text-sm">Crie tarefas, anexe imagens, visualize em dashboard, lista ou Kanban.</p>
          <!-- Informa√ß√µes do usu√°rio logado -->
          <div id="userInfo" class="flex items-center gap-2 mt-2">
            <span class="text-xs text-slate-500">üë§</span>
            <span id="userName" class="text-xs text-slate-600 font-medium"></span>
            <span class="text-xs text-slate-400">‚Ä¢</span>
            <span id="userSetor" class="text-xs px-2 py-1 rounded-full"></span>
          </div>
          
          <!-- Filtro de Setores (s√≥ para admin) -->
          <div id="setorFilter" class="mt-3 hidden">
            <label for="setorSelect" class="block text-xs font-medium text-gray-700 mb-1">
              üîç Filtrar por Setor:
            </label>
            <select id="setorSelect" class="text-xs px-2 py-1 border border-gray-300 rounded-md bg-white focus:outline-none focus:ring-2 focus:ring-blue-500">
              <option value="">üåê Todos os Setores</option>
              <!-- Op√ß√µes ser√£o carregadas dinamicamente -->
            </select>
          </div>
        </div>
      </div>
      <nav class="flex flex-wrap items-center gap-2 mt-3 md:mt-0" aria-label="A√ß√µes r√°pidas">
        <button id="btnNew" class="group flex items-center gap-2 px-3 py-2 rounded-xl bg-sky-600 text-white hover:bg-sky-700 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 transition hidden" aria-label="Nova Atividade">
          <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg>
          <span class="hidden sm:inline">Nova</span>
        </button>
        <button id="btnExport" class="group flex items-center gap-2 px-3 py-2 rounded-xl bg-emerald-600 text-white hover:bg-emerald-700 focus:outline-none focus-visible:ring-2 focus-visible:ring-emerald-400 transition hidden" aria-label="Exportar">
          <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 5v14M19 12l-7 7-7-7"/></svg>
          <span class="hidden sm:inline">Exportar</span>
        </button>
        <label id="btnImport" class="group flex items-center gap-2 px-3 py-2 rounded-xl bg-amber-600 text-white hover:bg-amber-700 focus-within:ring-2 focus-within:ring-amber-400 cursor-pointer transition hidden" aria-label="Importar">
          <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 19V5M5 12l7 7 7-7"/></svg>
          <span class="hidden sm:inline">Importar</span>
          <input type="file" id="inputImport" accept="application/json" class="hidden" />
        </label>
  <!-- bot√£o PDF removido, s√≥ menu lateral de relat√≥rios permanece -->
        <button id="btnRelatorios" class="group flex items-center gap-2 px-3 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700 focus:outline-none focus-visible:ring-2 focus-visible:ring-indigo-400 transition" aria-label="Abrir menu de relat√≥rios" type="button">
          <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M3 6h18M3 12h18M3 18h18"/></svg>
          <span class="hidden sm:inline">Relat√≥rios</span>
        </button>
        <!-- Off-canvas menu lateral de relat√≥rios -->
        <div id="offcanvasRelatorios" class="fixed top-0 right-0 h-full w-80 max-w-full bg-white shadow-2xl border-l border-slate-200 z-50 transform translate-x-full transition-transform duration-300 ease-in-out flex flex-col" style="display:none;">
          <div class="flex items-center justify-between px-6 py-4 border-b">
            <h3 class="text-lg font-semibold">Relat√≥rios</h3>
            <button id="btnCloseRelatorios" class="text-slate-500 hover:text-slate-900 text-2xl font-bold" title="Fechar">&times;</button>
          </div>
          <div class="flex-1 p-6 flex flex-col gap-4">
            <button id="btnExportPDF" class="flex items-center gap-2 px-4 py-3 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700 transition w-full" type="button">
              <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 5v14M19 12l-7 7-7-7"/></svg>
              PDF Dashboard
            </button>
            <button id="btnExportListPDF" class="flex items-center gap-2 px-4 py-3 rounded-xl bg-emerald-600 text-white hover:bg-emerald-700 transition w-full" type="button">
              <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M3 6h18M3 12h18M3 18h18"/></svg>
              Lista PDF
            </button>
            <!-- Outras op√ß√µes de relat√≥rios podem ser adicionadas aqui -->
          </div>
        </div>
        <button id="btnManageStatus" class="group flex items-center gap-2 px-3 py-2 rounded-xl bg-purple-600 text-white hover:bg-purple-700 focus:outline-none focus-visible:ring-2 focus-visible:ring-purple-400 transition hidden" title="Gerenciar Status" aria-label="Gerenciar Status">
          <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg>
          <span class="hidden sm:inline">Status</span>
        </button>
        <!-- Bot√£o Administra√ß√£o (s√≥ para admin) -->
        <button id="btnAdmin" class="group flex items-center gap-2 px-3 py-2 rounded-xl bg-purple-600 text-white hover:bg-purple-700 focus:outline-none focus-visible:ring-2 focus-visible:ring-purple-400 transition hidden" title="Painel de Administra√ß√£o" aria-label="Admin">
          <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4"/></svg>
          <span class="hidden sm:inline">Admin</span>
        </button>
        
        <!-- Bot√£o Pend√™ncias de Aprova√ß√£o (s√≥ para admin) -->
        <button id="btnPendingApprovals" class="group flex items-center gap-2 px-3 py-2 rounded-xl bg-orange-600 text-white hover:bg-orange-700 focus:outline-none focus-visible:ring-2 focus-visible:ring-orange-400 transition hidden relative" title="Solicita√ß√µes Pendentes de Aprova√ß√£o" aria-label="Pend√™ncias">
          <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
          <span class="hidden sm:inline">Pend√™ncias</span>
          <span id="pendingBadge" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full min-w-[20px] h-5 flex items-center justify-center hidden">0</span>
        </button>
        
        <button id="btnLogout" class="group flex items-center gap-2 px-3 py-2 rounded-xl bg-gray-600 text-white hover:bg-gray-700 focus:outline-none focus-visible:ring-2 focus-visible:ring-gray-400 transition" title="Sair do sistema" aria-label="Logout">
          <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4m7 14l5-5-5-5m5 5H9"/></svg>
          <span class="hidden sm:inline">Sair</span>
        </button>
        <button id="btnReset" class="group flex items-center gap-2 px-3 py-2 rounded-xl bg-rose-600 text-white hover:bg-rose-700 focus:outline-none focus-visible:ring-2 focus-visible:ring-rose-400 transition hidden" title="Apagar todas as atividades" aria-label="Resetar">
          <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M3 6h18M8 6v12a2 2 0 0 0 2 2h4a2 2 0 0 0 2-2V6"/></svg>
          <span class="hidden sm:inline">Reset</span>
        </button>
      </nav>
    <script>
      // Off-canvas menu lateral de relat√≥rios
      const btnRelatorios = document.getElementById('btnRelatorios');
      const offcanvas = document.getElementById('offcanvasRelatorios');
      const btnCloseRelatorios = document.getElementById('btnCloseRelatorios');
      btnRelatorios.addEventListener('click', function() {
        offcanvas.style.display = 'flex';
        setTimeout(()=>{offcanvas.classList.remove('translate-x-full');}, 10);
      });
      btnCloseRelatorios.addEventListener('click', function() {
        offcanvas.classList.add('translate-x-full');
        setTimeout(()=>{offcanvas.style.display = 'none';}, 300);
      });
      // Fecha ao clicar fora do menu
      document.addEventListener('mousedown', function(e) {
        if (offcanvas.style.display === 'flex' && !offcanvas.contains(e.target) && e.target !== btnRelatorios) {
          offcanvas.classList.add('translate-x-full');
          setTimeout(()=>{offcanvas.style.display = 'none';}, 300);
        }
      });
    </script>
    </header>

    <!-- KPIs -->
    <section class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3 mb-6" id="kpiCards">
  <!-- UI: Cards de KPI aprimorados, grid responsiva, √≠cones, contraste, tend√™ncia -->
  <!-- Cards gerados via JS -->
    </section>

    <!-- Charts -->
    <section class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6">
      <div class="bg-white rounded-2xl shadow p-4">
        <h2 class="font-semibold mb-2">Status das Atividades</h2>
        <canvas id="statusChart" height="140"></canvas>
      </div>
      <div class="bg-white rounded-2xl shadow p-4">
        <h2 class="font-semibold mb-2">Prioridade</h2>
        <canvas id="priorityChart" height="140"></canvas>
      </div>
    </section>

    <!-- Filtros / Abas -->
    <section class="bg-white rounded-2xl shadow p-4 mb-4">
      <!-- UI: Filtros compactos, alinhamento, placeholders claros, bot√£o de reset, foco vis√≠vel, contraste -->
      <form class="flex flex-col md:flex-row md:items-end gap-3" role="search" aria-label="Filtros de atividades" onsubmit="return false;">
        <div class="flex-1 min-w-[180px]">
          <label class="block text-sm font-medium mb-1" for="search">Busca</label>
          <div class="flex gap-2 items-center">
            <input id="search" class="w-full rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 text-slate-800 dark:text-slate-100 px-3 py-2 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 transition" placeholder="ID, t√≠tulo, respons√°vel, tags..." autocomplete="off" />
            <label class="flex gap-1 items-center text-xs text-slate-600 dark:text-slate-400"><input type="checkbox" id="searchTagsOnly" class="accent-sky-600" /> Tags</label>
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1" for="filterStatus">Status</label>
          <select id="filterStatus" class="rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 text-slate-800 dark:text-slate-100 px-3 py-2 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 transition">
            <option value="">Todos</option>
            <option>Backlog</option>
            <option>Em andamento</option>
            <option>Bloqueado</option>
            <option>Conclu√≠do</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1" for="filterPriority">Prioridade</label>
          <select id="filterPriority" class="rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 text-slate-800 dark:text-slate-100 px-3 py-2 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 transition">
            <option value="">Todas</option>
            <option>Baixa</option>
            <option>M√©dia</option>
            <option>Alta</option>
            <option>Cr√≠tica</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1" for="filterAssignee">Respons√°vel</label>
          <input id="filterAssignee" class="rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 text-slate-800 dark:text-slate-100 px-3 py-2 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 transition" placeholder="Ex.: Ana" autocomplete="off" />
        </div>
        <div class="flex gap-2 mt-2 md:mt-0">
          <button id="tabList" class="px-4 py-2 rounded-2xl bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-100 hover:bg-sky-100 dark:hover:bg-sky-800 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 transition" type="button">Lista</button>
          <button id="tabKanban" class="px-4 py-2 rounded-2xl bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-100 hover:bg-sky-100 dark:hover:bg-sky-800 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 transition" type="button">Kanban</button>
          <button id="btnResetFilters" class="px-4 py-2 rounded-2xl bg-rose-100 dark:bg-rose-900 text-rose-700 dark:text-rose-200 hover:bg-rose-200 dark:hover:bg-rose-800 focus:outline-none focus-visible:ring-2 focus-visible:ring-rose-400 transition hidden" type="reset" title="Limpar filtros" aria-label="Limpar filtros">
            <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M18 6L6 18M6 6l12 12"/></svg>
          </button>
        </div>
      </form>
    </section>

    <!-- Conte√∫do: Lista -->
    <section id="viewList" class="bg-white rounded-2xl shadow overflow-x-auto">
      <!-- UI: Tabela aprimorada, cabe√ßalho sticky, zebra rows, chips, badges, foco vis√≠vel, contraste -->
      <div class="overflow-x-auto rounded-2xl">
        <table class="min-w-full text-sm border-separate border-spacing-0" aria-label="Lista de atividades">
          <thead class="bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-200 sticky top-0 z-10 shadow-sm">
            <tr>
              <th scope="col" class="text-left px-4 py-3 font-semibold">ID</th>
              <th scope="col" class="text-left px-4 py-3 font-semibold">T√≠tulo</th>
              <th scope="col" class="text-left px-4 py-3 font-semibold">Respons√°vel</th>
              <th scope="col" class="text-left px-4 py-3 font-semibold">Prazo</th>
              <th scope="col" class="text-left px-4 py-3 font-semibold">Prioridade</th>
              <th scope="col" class="text-left px-4 py-3 font-semibold">Status</th>
              <th scope="col" class="text-left px-4 py-3 font-semibold">Tags</th>
              <th scope="col" class="text-left px-4 py-3 font-semibold">Anexos</th>
              <th scope="col" class="px-4 py-3 font-semibold">A√ß√µes</th>
            </tr>
          </thead>
          <tbody id="taskTable" class="divide-y divide-slate-100 dark:divide-slate-800"></tbody>
        </table>
      </div>
  <div id="loadingList" class="hidden p-6 text-center text-slate-500 dark:text-slate-400 animate-pulse" aria-live="polite">Carregando atividades‚Ä¶</div>
  <div id="errorList" class="hidden p-6 text-center text-rose-600 dark:text-rose-400" aria-live="assertive">Erro ao carregar atividades. Tente novamente.</div>
  <div id="emptyList" class="hidden p-6 text-center text-slate-500 dark:text-slate-400" aria-live="polite">Nenhuma atividade encontrada‚Ä¶</div>
    </section>

    <!-- Conte√∫do: Kanban -->
    <section id="viewKanban" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
  <!-- UI: Kanban aprimorado, colunas distintas, cabe√ßalho com contagem, cart√µes leg√≠veis, tags, miniaturas, responsividade, acessibilidade -->
  <!-- Colunas geradas via JS -->
    </section>
  </div>

  <!-- Modal: Nova/Editar Atividade -->
  <dialog id="taskModal" class="rounded-2xl w-11/12 max-w-3xl p-0 shadow-2xl">
    <form id="taskForm" class="bg-white rounded-2xl" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="flex justify-between items-center px-5 py-4 border-b">
        <h3 id="modalTitle" class="text-lg font-semibold">Nova Atividade</h3>
        <button type="button" id="btnCloseModal" class="p-2 rounded-xl hover:bg-slate-100">‚úï</button>
      </div>
      <div class="p-5 grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="md:col-span-2">
          <label class="block text-sm font-medium mb-1" for="inputTitle">T√≠tulo *</label>
          <input required name="title" id="inputTitle" class="w-full rounded-xl border border-slate-300 px-3 py-2" placeholder="Ex.: Publicar especifica√ß√£o do m√≥dulo fiscal" />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1" for="inputAssignee">Respons√°vel</label>
          <input name="assignee" id="inputAssignee" class="w-full rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 text-slate-800 dark:text-slate-100 px-3 py-2 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 transition" placeholder="Ex.: Natanael" />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1" for="inputDue">Prazo</label>
          <input type="date" name="due" id="inputDue" class="w-full rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 text-slate-800 dark:text-slate-100 px-3 py-2 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 transition" />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1" for="inputPriority">Prioridade</label>
          <select name="priority" id="inputPriority" class="w-full rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 text-slate-800 dark:text-slate-100 px-3 py-2 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 transition">
            <option>Baixa</option>
            <option>M√©dia</option>
            <option selected>Alta</option>
            <option>Cr√≠tica</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1" for="inputStatus">Status</label>
          <select name="status" id="inputStatus" class="w-full rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 text-slate-800 dark:text-slate-100 px-3 py-2 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 transition">
            <option>Backlog</option>
            <option selected>Em andamento</option>
            <option>Bloqueado</option>
            <option>Conclu√≠do</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1" for="inputSetor">Setor</label>
          <select name="setor" id="inputSetor" class="w-full rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 text-slate-800 dark:text-slate-100 px-3 py-2 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 transition">
            <option value="">Carregando setores...</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1" for="inputTags">Tags (separe por v√≠rgula)</label>
          <input name="tags" id="inputTags" class="w-full rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 text-slate-800 dark:text-slate-100 px-3 py-2 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 transition" placeholder="ex.: fiscal, SAP, ICMS" />
        </div>
        <div class="md:col-span-2">
          <label class="block text-sm font-medium mb-1" for="inputDescription">Descri√ß√£o</label>
          <textarea name="description" id="inputDescription" rows="3" class="w-full rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 text-slate-800 dark:text-slate-100 px-3 py-2 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 transition" placeholder="Contexto, escopo, crit√©rios de aceite‚Ä¶"></textarea>
        </div>
        <!-- Anexos -->
        <div class="md:col-span-2">
          <label class="block text-sm font-medium mb-2">Anexos (imagens)</label>
          <div id="dropArea" class="dropzone p-4 text-sm text-slate-600 dark:text-slate-400 flex flex-col items-center justify-center gap-2 transition-all" aria-label="√Årea de anexos" tabindex="0">
            <p>Arraste e solte imagens aqui ou</p>
            <label class="px-3 py-2 rounded-xl bg-slate-800 dark:bg-slate-700 text-white cursor-pointer focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 transition">Selecionar imagens
              <input type="file" id="imageInput" accept="image/*" multiple class="hidden" />
            </label>
            <p class="text-xs text-slate-500 dark:text-slate-400">As imagens ficam salvas localmente no seu navegador.</p>
          </div>
          <div id="thumbs" class="mt-3 flex flex-wrap gap-2"></div>
        </div>
      </div>
      <div class="px-5 py-4 border-t border-slate-100 dark:border-slate-800 flex justify-end gap-2">
        <button type="button" id="btnClearAnexos" class="px-4 py-2 rounded-2xl bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-100 hover:bg-sky-100 dark:hover:bg-sky-800 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 transition">Limpar anexos</button>
        <button type="submit" class="px-4 py-2 rounded-2xl bg-sky-600 text-white hover:bg-sky-700 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 transition">Salvar</button>
      </div>
    </form>
  </dialog>

  <!-- Modal: Detalhes -->
  <dialog id="detailModal" class="rounded-2xl w-11/12 max-w-3xl p-0 shadow-2xl">
    <div class="bg-white rounded-2xl">
      <div class="flex justify-between items-center px-5 py-4 border-b">
        <h3 class="text-lg font-semibold">Detalhes da Atividade</h3>
        <button type="button" id="btnCloseDetail" class="p-2 rounded-xl hover:bg-slate-100">‚úï</button>
      </div>
      <div id="detailBody" class="p-5 space-y-3 text-sm"></div>
      <div class="px-5 py-4 border-t text-right">
        <button type="button" id="btnCloseDetail2" class="px-4 py-2 rounded-2xl bg-slate-200">Fechar</button>
      </div>
    </div>
  </dialog>

  <!-- Modal: Visualizar Imagem -->
  <dialog id="imageModal" class="rounded-2xl w-11/12 max-w-5xl p-0 shadow-2xl">
    <div class="relative bg-white rounded-2xl">
      <button type="button" id="btnCloseImage" class="absolute top-4 right-4 z-10 p-2 rounded-full bg-slate-100 hover:bg-slate-200 text-slate-600 hover:text-slate-800 transition shadow-lg">
        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path d="M18 6L6 18M6 6l12 12"/>
        </svg>
      </button>
      <div class="p-6">
        <div class="text-center mb-4">
          <h3 id="imageModalTitle" class="text-xl font-semibold text-slate-800"></h3>
        </div>
        <div class="flex justify-center bg-slate-50 rounded-xl p-4 border">
          <img id="imageModalImg" src="" alt="" class="max-w-full max-h-[70vh] object-contain rounded-lg shadow-sm" />
        </div>
        <div class="mt-6 flex justify-center gap-3">
          <button type="button" id="btnDownloadImage" class="px-6 py-3 rounded-xl bg-slate-600 text-white hover:bg-slate-700 transition shadow flex items-center gap-2">
            <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"/>
            </svg>
            Baixar Imagem
          </button>
          <button type="button" id="btnOpenImageNewTab" class="px-6 py-3 rounded-xl bg-blue-600 text-white hover:bg-blue-700 transition shadow flex items-center gap-2">
            <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6M15 3h6v6M10 14L21 3"/>
            </svg>
            Abrir em Nova Aba
          </button>
        </div>
      </div>
    </div>
  </dialog>

  <!-- Modal: Gerenciar Status -->
  <dialog id="statusModal" class="rounded-2xl w-11/12 max-w-2xl p-0 shadow-2xl">
    <div class="bg-white rounded-2xl">
      <div class="flex justify-between items-center px-5 py-4 border-b">
        <h3 class="text-lg font-semibold">Gerenciar Status</h3>
        <button type="button" id="btnCloseStatusModal" class="p-2 rounded-xl hover:bg-slate-100">‚úï</button>
      </div>
      <div class="p-5">
        <!-- Adicionar novo status -->
        <div class="mb-6 p-4 bg-slate-50 rounded-xl">
          <div class="flex items-center justify-between mb-3">
            <h4 class="font-medium">Adicionar Novo Status</h4>
            <div id="editModeIndicator" class="hidden px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full">
              Modo Edi√ß√£o
            </div>
          </div>
          <div class="flex gap-3 items-end">
            <div class="flex-1">
              <label class="block text-sm font-medium mb-1">Nome do Status</label>
              <input type="text" id="newStatusName" class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-400" placeholder="Ex: Aguardando Aprova√ß√£o">
            </div>
            <div class="flex-1">
              <label class="block text-sm font-medium mb-1">Cor (classe CSS)</label>
              <select id="newStatusColor" class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-400">
                <option value="bg-slate-200 text-slate-800">Cinza (Padr√£o)</option>
                <option value="bg-blue-100 text-blue-800">Azul</option>
                <option value="bg-indigo-100 text-indigo-800">√çndigo</option>
                <option value="bg-purple-100 text-purple-800">Roxo</option>
                <option value="bg-pink-100 text-pink-800">Rosa</option>
                <option value="bg-red-100 text-red-800">Vermelho</option>
                <option value="bg-orange-100 text-orange-800">Laranja</option>
                <option value="bg-amber-100 text-amber-800">√Çmbar</option>
                <option value="bg-yellow-100 text-yellow-800">Amarelo</option>
                <option value="bg-lime-100 text-lime-800">Lima</option>
                <option value="bg-green-100 text-green-800">Verde</option>
                <option value="bg-emerald-100 text-emerald-800">Esmeralda</option>
                <option value="bg-teal-100 text-teal-800">Verde-azulado</option>
                <option value="bg-cyan-100 text-cyan-800">Ciano</option>
              </select>
            </div>
            <div class="flex gap-2">
              <button type="button" id="btnAddStatus" class="px-4 py-2 rounded-xl bg-purple-600 text-white hover:bg-purple-700 transition">
                Adicionar
              </button>
            </div>
          </div>
        </div>

        <!-- Instru√ß√µes para Supabase -->
        <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-xl">
          <h4 class="font-medium text-blue-800 mb-2">üìù Primeira vez usando status personalizados?</h4>
          <p class="text-sm text-blue-700 mb-2">Para salvar no Supabase, √© necess√°rio criar a tabela <code class="bg-blue-100 px-1 rounded">custom_status</code>:</p>
          <details class="text-xs">
            <summary class="cursor-pointer text-blue-600 font-medium">Ver c√≥digo SQL</summary>
            <pre class="mt-2 p-2 bg-blue-100 rounded text-blue-800 overflow-x-auto">CREATE TABLE custom_status (
  id UUID PRIMARY KEY,
  name VARCHAR(255) NOT NULL,
  color VARCHAR(255) NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);</pre>
          </details>
        </div>

        <!-- Lista de status existentes -->
        <div>
          <h4 class="font-medium mb-3">Status Existentes</h4>
          <div id="statusList" class="space-y-2">
            <!-- Status ser√£o carregados dinamicamente aqui -->
          </div>
        </div>
      </div>
      <div class="px-5 py-4 border-t text-right">
        <button type="button" id="btnCloseStatusModal2" class="px-4 py-2 rounded-xl bg-slate-200 hover:bg-slate-300 transition mr-2">Fechar</button>
        <button type="button" id="btnSaveStatusToSupabase" class="px-4 py-2 rounded-xl bg-purple-600 text-white hover:bg-purple-700 transition">Salvar no Supabase</button>
      </div>
    </div>
  </dialog>

  <!-- Modal: Gerenciar Usu√°rios (Admin) -->
  <dialog id="userManagementModal" class="rounded-2xl w-11/12 max-w-6xl p-0 shadow-2xl">
    <div class="bg-white rounded-2xl max-h-[90vh] flex flex-col">
      <div class="flex justify-between items-center p-5 border-b">
        <h3 class="text-xl font-semibold text-purple-800">üë• Gerenciar Usu√°rios</h3>
        <button type="button" id="btnCloseUserModal" class="p-2 rounded-xl hover:bg-slate-100">‚úï</button>
      </div>
      
      <div class="flex-1 overflow-y-auto p-5">
        <!-- Bot√µes de A√ß√£o -->
        <div class="flex gap-3 mb-4">
          <button id="btnNewUser" class="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-xl hover:bg-green-700 transition">
            <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
              <circle cx="9" cy="7" r="4"/>
              <path d="M22 11l-3-3m0 0l-3 3m3-3v12"/>
            </svg>
            Novo Usu√°rio
          </button>
          <button id="btnRefreshUsers" class="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-xl hover:bg-blue-700 transition">
            <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/>
              <path d="M21 3v5h-5"/>
              <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/>
              <path d="M3 21v-5h5"/>
            </svg>
            Atualizar
          </button>
        </div>

        <!-- Lista de Usu√°rios -->
        <div id="usersList" class="space-y-3">
          <!-- Usu√°rios carregados dinamicamente -->
        </div>
      </div>

      <!-- Formul√°rio para Novo/Editar Usu√°rio -->
      <div id="userForm" class="hidden border-t p-5 bg-gray-50">
        <h4 class="text-lg font-semibold mb-3" id="userFormTitle">Novo Usu√°rio</h4>
        <form id="userFormData" class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <input type="hidden" id="editUserId" name="editUserId" value="">
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
            <input type="email" id="userEmail" name="userEmail" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-400 focus:border-purple-400">
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Nome</label>
            <input type="text" id="userNameInput" name="userName" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-400 focus:border-purple-400">
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Setor</label>
            <select id="userSetorSelect" name="userSetor" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-400 focus:border-purple-400">
              <option value="">Selecione um setor</option>
            </select>
          </div>
          
          <div>
            <label class="flex items-center gap-2 text-sm font-medium text-gray-700">
              <input type="checkbox" id="userIsAdmin" name="userIsAdmin" class="rounded focus:ring-purple-400">
              Administrador
            </label>
          </div>
          
          <div class="md:col-span-2 flex gap-3 pt-3">
            <button type="submit" class="px-4 py-2 bg-purple-600 text-white rounded-xl hover:bg-purple-700 transition">
              Salvar Usu√°rio
            </button>
            <button type="button" id="btnCancelUserForm" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-xl hover:bg-gray-400 transition">
              Cancelar
            </button>
          </div>
        </form>
      </div>
    </div>
  </dialog>

  <!-- Modal: Gerenciar Setores (Admin) -->
  <dialog id="setorManagementModal" class="rounded-2xl w-11/12 max-w-5xl p-0 shadow-2xl">
    <div class="bg-white rounded-2xl max-h-[90vh] flex flex-col">
      <div class="flex justify-between items-center p-5 border-b">
        <h3 class="text-xl font-semibold text-purple-800">üè¢ Gerenciar Setores</h3>
        <button type="button" id="btnCloseSetorModal" class="p-2 rounded-xl hover:bg-slate-100">‚úï</button>
      </div>
      
      <div class="flex-1 overflow-y-auto p-5">
        <!-- Bot√µes de A√ß√£o -->
        <div class="flex gap-3 mb-4">
          <button id="btnNewSetor" class="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-xl hover:bg-green-700 transition">
            <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="M3 21h18"/>
              <path d="M5 21V7l8-4v18"/>
              <path d="M19 21V11l-6-4"/>
            </svg>
            Novo Setor
          </button>
          <button id="btnRefreshSetores" class="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-xl hover:bg-blue-700 transition">
            <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/>
              <path d="M21 3v5h-5"/>
              <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/>
              <path d="M3 21v-5h5"/>
            </svg>
            Atualizar
          </button>
        </div>

        <!-- Lista de Setores -->
        <div id="setoresList" class="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
          <!-- Setores carregados dinamicamente -->
        </div>
      </div>

      <!-- Formul√°rio para Novo/Editar Setor -->
      <div id="setorForm" class="hidden border-t p-5 bg-gray-50">
        <h4 class="text-lg font-semibold mb-3" id="setorFormTitle">Novo Setor</h4>
        <form id="setorFormData" class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <input type="hidden" id="editSetorId" name="editSetorId" value="">
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Nome do Setor</label>
            <input type="text" id="setorNome" name="setorNome" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-400 focus:border-purple-400">
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Cor do Setor</label>
            <div class="flex gap-2">
              <input type="color" id="setorCor" name="setorCor" value="#3B82F6" class="h-10 w-16 border border-gray-300 rounded-lg cursor-pointer">
              <input type="text" id="setorCorText" value="#3B82F6" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-400 focus:border-purple-400">
            </div>
          </div>
          
          <div class="md:col-span-2">
            <label class="block text-sm font-medium text-gray-700 mb-1">Descri√ß√£o</label>
            <textarea id="setorDescricao" name="setorDescricao" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-400 focus:border-purple-400"></textarea>
          </div>
          
          <div class="md:col-span-2 flex gap-3 pt-3">
            <button type="submit" class="px-4 py-2 bg-purple-600 text-white rounded-xl hover:bg-purple-700 transition">
              Salvar Setor
            </button>
            <button type="button" id="btnCancelSetorForm" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-xl hover:bg-gray-400 transition">
              Cancelar
            </button>
          </div>
        </form>
      </div>
    </div>
  </dialog>

  <!-- Modal: Relat√≥rios Administrativos -->
  <dialog id="adminReportsModal" class="rounded-2xl w-11/12 max-w-6xl p-0 shadow-2xl">
    <div class="bg-white rounded-2xl max-h-[90vh] flex flex-col">
      <div class="flex justify-between items-center p-5 border-b">
        <h3 class="text-xl font-semibold text-purple-800">üìä Relat√≥rios Administrativos</h3>
        <button type="button" id="btnCloseReportsModal" class="p-2 rounded-xl hover:bg-slate-100">‚úï</button>
      </div>
      
      <div class="flex-1 overflow-y-auto p-5">
        <!-- Dashboard Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
          <div class="bg-blue-50 p-4 rounded-xl border-l-4 border-blue-500">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-blue-700 text-sm font-medium">Total de Usu√°rios</p>
                <p id="totalUsers" class="text-2xl font-bold text-blue-900">-</p>
              </div>
              <svg class="w-8 h-8 text-blue-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                <circle cx="9" cy="7" r="4"/>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
              </svg>
            </div>
          </div>

          <div class="bg-green-50 p-4 rounded-xl border-l-4 border-green-500">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-green-700 text-sm font-medium">Setores Ativos</p>
                <p id="totalSetores" class="text-2xl font-bold text-green-900">-</p>
              </div>
              <svg class="w-8 h-8 text-green-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path d="M3 21h18"/>
                <path d="M5 21V7l8-4v18"/>
                <path d="M19 21V11l-6-4"/>
              </svg>
            </div>
          </div>

          <div class="bg-yellow-50 p-4 rounded-xl border-l-4 border-yellow-500">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-yellow-700 text-sm font-medium">Total de Tarefas</p>
                <p id="totalTasks" class="text-2xl font-bold text-yellow-900">-</p>
              </div>
              <svg class="w-8 h-8 text-yellow-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path d="M9 11H5a2 2 0 0 0-2 2v7a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7a2 2 0 0 0-2-2h-4"/>
                <path d="M9 11V7a3 3 0 0 1 6 0v4"/>
              </svg>
            </div>
          </div>

          <div class="bg-purple-50 p-4 rounded-xl border-l-4 border-purple-500">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-purple-700 text-sm font-medium">Tarefas Conclu√≠das</p>
                <p id="completedTasks" class="text-2xl font-bold text-purple-900">-</p>
              </div>
              <svg class="w-8 h-8 text-purple-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                <path d="M22 4 12 14.01l-3-3"/>
              </svg>
            </div>
          </div>
        </div>

        <!-- Solicita√ß√µes de Conclus√£o Pendentes -->
        <div class="bg-white p-6 rounded-xl border shadow-sm mb-6">
          <div class="flex items-center justify-between mb-4">
            <h4 class="text-lg font-semibold text-gray-800 flex items-center gap-2">
              <span class="bg-orange-100 p-2 rounded-lg">
                <svg class="w-5 h-5 text-orange-600" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                  <path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
              </span>
              Solicita√ß√µes de Conclus√£o Pendentes
              <span id="pendingRequestsCount" class="bg-red-500 text-white text-xs px-2 py-1 rounded-full hidden">0</span>
            </h4>
            <button id="refreshPendingRequests" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition text-sm">
              <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
              </svg>
              Atualizar
            </button>
          </div>
          
          <div id="pendingRequestsContainer" class="space-y-3">
            <div class="text-center text-gray-500 py-8" id="noPendingRequests">
              <svg class="w-12 h-12 mx-auto text-gray-300 mb-3" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
              <p>Nenhuma solicita√ß√£o pendente</p>
            </div>
          </div>
        </div>

        <!-- Gr√°fico de Tarefas por Setor -->
        <div class="bg-white p-6 rounded-xl border shadow-sm mb-6">
          <h4 class="text-lg font-semibold text-gray-800 mb-4">Distribui√ß√£o de Tarefas por Setor</h4>
          <canvas id="tasksPerSetorChart" width="400" height="200"></canvas>
        </div>

        <!-- Tabela de Usu√°rios por Setor -->
        <div class="bg-white p-6 rounded-xl border shadow-sm">
          <h4 class="text-lg font-semibold text-gray-800 mb-4">Usu√°rios por Setor</h4>
          <div id="usersPerSetorTable" class="overflow-x-auto">
            <!-- Tabela carregada dinamicamente -->
          </div>
        </div>
      </div>

      <div class="px-5 py-4 border-t text-right">
        <button type="button" id="btnExportReports" class="px-4 py-2 rounded-xl bg-green-600 text-white hover:bg-green-700 transition mr-2">
          üì• Exportar Relat√≥rio
        </button>
        <button type="button" id="btnCloseReportsModal2" class="px-4 py-2 rounded-xl bg-slate-200 hover:bg-slate-300 transition">
          Fechar
        </button>
      </div>
    </div>
  </dialog>

  <!-- Modal: Solicitar Confirma√ß√£o de Conclus√£o -->
  <dialog id="confirmationRequestModal" class="rounded-2xl w-11/12 max-w-2xl p-0 shadow-2xl">
    <div class="bg-white rounded-2xl max-h-[90vh] flex flex-col">
      <div class="flex justify-between items-center p-5 border-b bg-green-50">
        <h3 class="text-xl font-semibold text-green-800">‚úÖ Solicitar Confirma√ß√£o de Conclus√£o</h3>
        <button type="button" id="btnCloseConfirmationModal" class="p-2 rounded-xl hover:bg-slate-100">‚úï</button>
      </div>
      
      <form id="confirmationForm" class="flex-1 overflow-y-auto p-5">
        <div class="mb-4">
          <p class="text-sm text-slate-600 mb-3">Voc√™ est√° solicitando a confirma√ß√£o de conclus√£o para a seguinte tarefa:</p>
          <div class="bg-slate-50 p-4 rounded-lg border">
            <h4 id="confirmationTaskTitle" class="font-medium text-slate-800 mb-2"></h4>
            <p id="confirmationTaskDescription" class="text-sm text-slate-600"></p>
          </div>
        </div>
        
        <div class="mb-6">
          <label for="confirmationNotes" class="block text-sm font-medium text-slate-700 mb-2">
            Observa√ß√µes sobre a conclus√£o <span class="text-slate-400">(opcional)</span>
          </label>
          <textarea 
            id="confirmationNotes" 
            rows="4" 
            class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 resize-none"
            placeholder="Descreva brevemente como a tarefa foi conclu√≠da ou adicione observa√ß√µes relevantes..."
          ></textarea>
          <p class="text-xs text-slate-500 mt-1">Estas observa√ß√µes ajudar√£o o administrador a avaliar a conclus√£o da tarefa.</p>
        </div>
        
        <div class="flex justify-end gap-3 pt-4 border-t">
          <button type="button" id="btnCancelConfirmationRequest" class="px-4 py-2 rounded-xl bg-slate-200 hover:bg-slate-300 transition">
            Cancelar
          </button>
          <button type="submit" class="px-6 py-2 rounded-xl bg-green-600 text-white hover:bg-green-700 transition font-medium">
            Enviar Solicita√ß√£o
          </button>
        </div>
      </form>
    </div>
  </dialog>

  <!-- Modal: Aprovar/Rejeitar Solicita√ß√£o de Conclus√£o -->
  <dialog id="approvalModal" class="rounded-2xl w-11/12 max-w-3xl p-0 shadow-2xl">
    <div class="bg-white rounded-2xl max-h-[90vh] flex flex-col">
      <div class="flex justify-between items-center p-5 border-b bg-blue-50">
        <h3 class="text-xl font-semibold text-blue-800">‚öñÔ∏è Avaliar Solicita√ß√£o de Conclus√£o</h3>
        <button type="button" id="btnCloseApprovalModal" class="p-2 rounded-xl hover:bg-slate-100">‚úï</button>
      </div>
      
      <div class="flex-1 overflow-y-auto p-5">
        <!-- Informa√ß√µes da Tarefa -->
        <div class="mb-6">
          <h4 class="font-semibold text-gray-800 mb-3">üìã Informa√ß√µes da Tarefa</h4>
          <div class="bg-slate-50 p-4 rounded-lg border">
            <h5 id="approvalTaskTitle" class="font-medium text-slate-800 mb-2"></h5>
            <p id="approvalTaskDescription" class="text-sm text-slate-600 mb-2"></p>
            <div class="flex gap-4 text-xs text-slate-500">
              <span>üë§ <span id="approvalTaskAssignee"></span></span>
              <span>üìÖ <span id="approvalTaskDue"></span></span>
              <span>üè∑Ô∏è <span id="approvalTaskStatus"></span></span>
            </div>
          </div>
        </div>
        
        <!-- Informa√ß√µes da Solicita√ß√£o -->
        <div class="mb-6">
          <h4 class="font-semibold text-gray-800 mb-3">üì§ Solicita√ß√£o de Conclus√£o</h4>
          <div class="bg-green-50 p-4 rounded-lg border border-green-200">
            <div class="flex gap-4 text-sm text-green-700 mb-2">
              <span>üë§ Solicitado por: <span id="approvalRequestedBy" class="font-medium"></span></span>
              <span>üìÖ Em: <span id="approvalRequestedAt" class="font-medium"></span></span>
            </div>
            <div>
              <p class="text-sm text-gray-700 font-medium mb-1">Observa√ß√µes do usu√°rio:</p>
              <p id="approvalUserNotes" class="text-sm text-gray-600 bg-white p-3 rounded border italic"></p>
            </div>
          </div>
        </div>
        
        <!-- Decis√£o do Administrador -->
        <div class="mb-6">
          <h4 class="font-semibold text-gray-800 mb-3">‚öñÔ∏è Sua Decis√£o</h4>
          <div class="flex gap-4 mb-4">
            <label class="flex items-center gap-2 cursor-pointer">
              <input type="radio" name="approvalDecision" value="approve" class="text-green-600">
              <span class="bg-green-100 text-green-800 px-3 py-2 rounded-lg font-medium">‚úÖ Aprovar Conclus√£o</span>
            </label>
            <label class="flex items-center gap-2 cursor-pointer">
              <input type="radio" name="approvalDecision" value="reject" class="text-red-600">
              <span class="bg-red-100 text-red-800 px-3 py-2 rounded-lg font-medium">‚ùå Rejeitar Solicita√ß√£o</span>
            </label>
          </div>
          
          <div>
            <label for="adminNotes" class="block text-sm font-medium text-slate-700 mb-2">
              Observa√ß√µes administrativas <span class="text-slate-400">(opcional)</span>
            </label>
            <textarea 
              id="adminNotes" 
              rows="3" 
              class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-none"
              placeholder="Adicione observa√ß√µes sobre sua decis√£o..."
            ></textarea>
          </div>
        </div>
      </div>
      
      <div class="flex justify-end gap-3 p-5 border-t bg-gray-50">
        <button type="button" id="btnCancelApproval" class="px-4 py-2 rounded-xl bg-slate-200 hover:bg-slate-300 transition">
          Cancelar
        </button>
        <button type="button" id="btnConfirmApproval" class="px-6 py-2 rounded-xl bg-blue-600 text-white hover:bg-blue-700 transition font-medium">
          Confirmar Decis√£o
        </button>
      </div>
    </div>
  </dialog>

  <!-- Modal: Lista de Pend√™ncias de Aprova√ß√£o -->
  <dialog id="pendingApprovalsModal" class="rounded-2xl w-11/12 max-w-5xl p-0 shadow-2xl">
    <div class="bg-white rounded-2xl max-h-[90vh] flex flex-col">
      <div class="flex justify-between items-center p-5 border-b bg-orange-50">
        <h3 class="text-xl font-semibold text-orange-800 flex items-center gap-3">
          <span class="bg-orange-100 p-2 rounded-lg">
            <svg class="w-6 h-6 text-orange-600" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
          </span>
          Solicita√ß√µes de Conclus√£o Pendentes
          <span id="pendingModalCount" class="bg-red-500 text-white text-sm px-3 py-1 rounded-full hidden">0</span>
        </h3>
        <div class="flex items-center gap-3">
          <button id="btnRefreshPending" class="px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition text-sm">
            <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
            </svg>
            Atualizar
          </button>
          <button type="button" id="btnClosePendingModal" class="p-2 rounded-xl hover:bg-slate-100">‚úï</button>
        </div>
      </div>
      
      <div class="flex-1 overflow-y-auto p-5">
        <div id="pendingListContainer" class="space-y-4">
          <div class="text-center text-gray-500 py-12" id="noPendingMessage">
            <svg class="w-16 h-16 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <h4 class="text-lg font-medium text-gray-900 mb-2">Nenhuma solicita√ß√£o pendente</h4>
            <p class="text-gray-600">Todas as solicita√ß√µes de conclus√£o foram processadas.</p>
          </div>
        </div>
      </div>
      
      <div class="flex justify-between items-center p-5 border-t bg-gray-50">
        <div class="text-sm text-gray-600">
          <span>üí° <strong>Dica:</strong> Clique em "‚öñÔ∏è Avaliar" para aprovar ou rejeitar cada solicita√ß√£o</span>
        </div>
        <button type="button" id="btnClosePendingModal2" class="px-4 py-2 rounded-xl bg-slate-200 hover:bg-slate-300 transition">
          Fechar
        </button>
      </div>
    </div>
  </dialog>

  <script>
  // Corrige bot√£o Limpar filtros para atualizar a lista
  document.getElementById('btnResetFilters').addEventListener('click', function(e) {
    setTimeout(refreshViews, 0);
  });
  // UI: Tema claro/escuro com toggle, persist√™ncia e integra√ß√£o Chart.js
  // Modo escuro removido

  // ====== Supabase integra√ß√£o ======
      const supabaseUrl = "https://iynsvuugjjbvjacrjmig.supabase.co";
      const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml5bnN2dXVnampidmphY3JqbWlnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4ODUwODksImV4cCI6MjA3NDQ2MTA4OX0.b-8p05tTG4iLbITGVdY1Da3TQbbupaYIZLfT-aMhPbk";
      
      // Verificar se o Supabase est√° dispon√≠vel
      if (typeof supabase === 'undefined') {
        console.error('‚ùå Supabase n√£o foi carregado!');
        alert('Erro: Biblioteca Supabase n√£o foi carregada. Verifique a conex√£o com a internet.');
      } else {
        console.log('‚úÖ Supabase carregado com sucesso');
      }
      
      // Criar cliente com configura√ß√µes otimizadas para auth
      const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey, {
        auth: {
          detectSessionInUrl: true,
          persistSession: true,
          autoRefreshToken: true
        }
      });
      
      // Tornar acess√≠vel globalmente
      window.supabaseClient = supabaseClient;
      
      // ====== SISTEMA DE AUTENTICA√á√ÉO ======
      let currentUser = null;
      let currentUserData = null; // Dados completos do usu√°rio
      let currentSetor = null;
      let isAdmin = false;
      let selectedSetorFilter = null; // Para filtrar por setor (admin)
      
      // Bypass tempor√°rio para desenvolvimento (remover depois)
      const BYPASS_AUTH = false; // DESATIVADO - sistema de autentica√ß√£o normal ativo

      // Verificar sess√£o existente ao carregar a p√°gina
      async function checkAuthStatus() {
        try {
          const { data: { session }, error } = await supabaseClient.auth.getSession();
          
          if (error) {
            console.error('Erro ao verificar sess√£o:', error);
            showLoginScreen();
            return;
          }
          
          if (session && session.user) {
            console.log('Sess√£o encontrada, fazendo login autom√°tico...');
            await handleUserLogin(session.user);
          } else {
            console.log('Nenhuma sess√£o encontrada, mostrando tela de login...');
            showLoginScreen();
          }
        } catch (error) {
          console.error('Erro cr√≠tico na verifica√ß√£o de sess√£o:', error);
          showLoginScreen();
        }
      }

      // Mostrar tela de login
      function showLoginScreen() {
        document.getElementById('loginScreen').classList.remove('hidden');
        document.getElementById('appContent').classList.add('hidden');
      }

      // Mostrar aplica√ß√£o principal
      function showApp() {
        document.getElementById('loginScreen').classList.add('hidden');
        document.getElementById('appContent').classList.remove('hidden');
      }

      // Processar login do usu√°rio (s√≥ chamado ap√≥s verifica√ß√£o de c√≥digo)
      async function handleUserLogin(user) {
        try {
          currentUser = user;
          console.log('üë§ Processando login do usu√°rio:', user.email);
          console.log('üìã Dados completos do usu√°rio:', user);
          
          // Verificar se usu√°rio existe no banco
          console.log('üîç Buscando usu√°rio no banco:', user.email);
          
          let { data: userData, error } = await supabaseClient
            .from('usuarios')
            .select(`
              *,
              setores(id, nome, cor)
            `)
            .eq('email', user.email)
            .single();

          console.log('üìä Resultado da busca:', { userData, error });

          if (error && error.code === 'PGRST116') {
            // ‚ùå Usu√°rio n√£o existe - isso N√ÉO deveria acontecer mais
            // porque j√° verificamos antes de enviar o c√≥digo
            console.error('‚ùå ERRO CR√çTICO: Usu√°rio autenticou mas n√£o existe no banco!');
            alert('‚ùå Erro cr√≠tico no sistema!\n\nSeu email foi autenticado, mas n√£o foi encontrado no banco de dados.\n\nüìû Contate o administrador imediatamente.');
            showLoginScreen();
            return;
          }

          if (error) {
            console.error('‚ùå Erro ao buscar usu√°rio:', error);
            alert('Erro ao buscar usu√°rio no sistema: ' + (error.message || 'Erro desconhecido'));
            showLoginScreen();
            return;
          }

          // Usu√°rio existe, configurar sess√£o
          currentUserData = userData; // Armazenar dados completos
          currentSetor = userData.setores; // Pode ser null para admin
          isAdmin = userData.is_admin;
          
          // Atualizar visibilidade do bot√£o de pend√™ncias
          updatePendingApprovalsButtonVisibility();
          
          console.log('üîç Debug dados do usu√°rio:', {
            userData: userData,
            setor_id_campo: userData.setor_id,
            currentSetor: currentSetor,
            setores_raw: userData.setores,
            isAdmin: isAdmin,
            has_setor_id: !!currentSetor?.id,
            setor_nome: currentSetor?.nome,
            complete_user_data: JSON.stringify(userData, null, 2)
          });
          
          console.log('‚úÖ Login realizado:', { 
            user: userData.nome, 
            setor: currentSetor?.nome || (isAdmin ? 'TODOS OS SETORES (Admin)' : 'Nenhum'),
            isAdmin 
          });

          showApp();
          await loadTasksFromSupabase();
          updateUserInterface();

        } catch (error) {
          console.error('Erro no login:', error);
          alert('Erro no sistema de autentica√ß√£o. Tente novamente.');
        }
      }

      // Criar novo usu√°rio (primeiro acesso)
      async function createNewUser(user) {
        try {
          console.log('Iniciando cria√ß√£o de usu√°rio para:', user.email);

          // Buscar setor "Controladoria" (padr√£o)
          const { data: setorDefault, error: setorError } = await supabaseClient
            .from('setores')
            .select('id')
            .eq('nome', 'Controladoria')
            .single();

          if (setorError) {
            console.error('Erro ao buscar setor:', setorError);
            throw new Error('Setor Controladoria n√£o encontrado');
          }

          // SEMPRE criar como admin por enquanto (simplificar)
          console.log('Criando usu√°rio como ADMINISTRADOR...');
          
          const { data: newUser, error } = await supabaseClient
            .from('usuarios')
            .insert({
              email: user.email,
              nome: user.user_metadata?.full_name || user.email.split('@')[0],
              avatar_url: user.user_metadata?.avatar_url || null,
              setor_id: setorDefault.id,
              is_admin: true, // FOR√áAR como admin para teste
              ativo: true
            })
            .select('*, setores(nome, cor)')
            .single();

          if (error) {
            console.error('Erro ao criar usu√°rio:', error);
            console.error('Detalhes do erro:', JSON.stringify(error, null, 2));
            
            // Tentar dar mais detalhes do erro
            let errorMsg = 'Erro ao criar conta de usu√°rio:\n\n';
            if (error.message) errorMsg += error.message;
            if (error.details) errorMsg += '\n' + error.details;
            if (error.hint) errorMsg += '\n' + error.hint;
            
            alert(errorMsg);
            return;
          }

          currentUserData = newUser; // Armazenar dados completos
          currentSetor = newUser.setores;
          isAdmin = newUser.is_admin;
          
          console.log('‚úÖ Usu√°rio criado com sucesso:', newUser);
          
          alert(`üéâ Bem-vindo ${newUser.nome}!\n\nVoc√™ foi criado como ADMINISTRADOR!\nSetor: ${currentSetor?.nome || 'Controladoria'}`);
          
          showApp();
          await loadTasksFromSupabase();
          updateUserInterface();

        } catch (error) {
          console.error('‚ùå Erro CR√çTICO ao criar usu√°rio:', error);
          console.error('Stack trace:', error.stack);
          
          let errorMsg = '‚ùå Erro no sistema ao criar usu√°rio:\n\n';
          errorMsg += error.message || 'Erro desconhecido';
          
          alert(errorMsg + '\n\nüìû Contate o suporte t√©cnico.');
          
          // Voltar para tela de login
          showLoginScreen();
        }
      }

      // ====== SISTEMA DE NOTIFICA√á√ïES ======
      function showToast(message, type = 'info') {
        // Fun√ß√£o simples de notifica√ß√£o usando alert por enquanto
        // Tipos: 'success', 'error', 'warning', 'info'
        const icons = {
          success: '‚úÖ',
          error: '‚ùå', 
          warning: '‚ö†Ô∏è',
          info: '‚ÑπÔ∏è'
        };
        
        const icon = icons[type] || icons.info;
        alert(`${icon} ${message}`);
        
        // Log para debug
        console.log(`Toast ${type}: ${message}`);
      }

      // Vari√°vel para armazenar email temporariamente
      let tempEmail = '';

      // Enviar c√≥digo de verifica√ß√£o por email
      async function sendVerificationCode(email) {
        try {
          console.log('üìß Tentando enviar c√≥digo para:', email);
          document.getElementById('loginForm').style.display = 'none';
          document.getElementById('loginLoading').classList.remove('hidden');

          // üîí VERIFICA√á√ÉO DE SEGURAN√áA: Email deve estar pr√©-autorizado
          console.log('üîç Verificando se email est√° autorizado...');
          
          const { data: authorizedUser, error: authError } = await supabaseClient
            .from('usuarios')
            .select('email, nome, ativo')
            .eq('email', email)
            .single();

          console.log('üìä Resultado da verifica√ß√£o:', { authorizedUser, authError });

          // Se email n√£o est√° cadastrado, bloquear acesso
          if (authError && authError.code === 'PGRST116') {
            console.log('‚ùå Email n√£o autorizado:', email);
            alert('‚ùå Seu usu√°rio n√£o est√° autorizado por um administrador!\n\nProcure um administrador para realizar seu cadastro de acesso.');
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('loginLoading').classList.add('hidden');
            return;
          }

          // Se erro diferente de "n√£o encontrado", mostrar erro
          if (authError) {
            console.error('‚ùå Erro ao verificar autoriza√ß√£o:', authError);
            alert('‚ùå Erro ao verificar autoriza√ß√£o: ' + authError.message);
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('loginLoading').classList.add('hidden');
            return;
          }

          // Se usu√°rio est√° inativo, bloquear acesso
          if (!authorizedUser.ativo) {
            console.log('‚ùå Usu√°rio inativo:', email);
            alert('‚ùå Acesso bloqueado!\n\nSua conta foi desativada.\n\nüìû Entre em contato com o administrador.');
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('loginLoading').classList.add('hidden');
            return;
          }

          console.log('‚úÖ Email autorizado para:', authorizedUser.nome);

          // Voltar ao m√©todo original OTP - S√ì AGORA envia o c√≥digo
          const { data, error } = await supabaseClient.auth.signInWithOtp({
            email: email,
            options: {
              shouldCreateUser: true
            }
          });

          console.log('üìß Resposta do Supabase:', { data, error });

          if (error) {
            console.error('Erro ao enviar c√≥digo:', error);
            let errorMessage = 'Erro ao enviar c√≥digo: ' + error.message;
            
            // Mensagens de erro mais espec√≠ficas
            if (error.message.includes('Email rate limit exceeded')) {
              errorMessage = 'Muitas tentativas de envio. Aguarde alguns minutos antes de tentar novamente.';
            } else if (error.message.includes('Invalid email')) {
              errorMessage = 'Email inv√°lido. Verifique se o endere√ßo est√° correto.';
            } else if (error.message.includes('Email not enabled')) {
              errorMessage = 'Sistema de email n√£o configurado. Entre em contato com o administrador.';
            }
            
            alert(errorMessage);
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('loginLoading').classList.add('hidden');
          } else {
            console.log('‚úÖ C√≥digo enviado com sucesso');
            // Sucesso - mostrar formul√°rio de c√≥digo
            tempEmail = email;
            document.getElementById('sentToEmail').textContent = email;
            document.getElementById('loginLoading').classList.add('hidden');
            document.getElementById('codeForm').classList.remove('hidden');
            document.getElementById('codeInput').focus();
            
            alert('üìß C√≥digo de verifica√ß√£o enviado para ' + email + '!\n\nVerifique sua caixa de entrada e digite o c√≥digo de 6 d√≠gitos no campo abaixo.');
          }
        } catch (error) {
          console.error('Erro ao enviar c√≥digo:', error);
          alert('Erro no sistema. Tente novamente.');
          document.getElementById('loginForm').style.display = 'block';
          document.getElementById('loginLoading').classList.add('hidden');
        }
      }

      // Verificar c√≥digo digitado pelo usu√°rio
      async function verifyCode(email, code) {
        try {
          document.getElementById('codeForm').style.display = 'none';
          document.getElementById('loginLoading').classList.remove('hidden');

          const { data, error } = await supabaseClient.auth.verifyOtp({
            email: email,
            token: code,
            type: 'email' // Voltar ao tipo email
          });

          if (error) {
            console.error('Erro na verifica√ß√£o:', error);
            alert('C√≥digo inv√°lido ou expirado: ' + error.message);
            document.getElementById('codeForm').style.display = 'block';
            document.getElementById('loginLoading').classList.add('hidden');
            document.getElementById('codeInput').value = '';
            document.getElementById('codeInput').focus();
          } else {
            // Login realizado com sucesso!
            console.log('Login realizado com sucesso:', data);
            await handleUserLogin(data.user);
          }
        } catch (error) {
          console.error('Erro na verifica√ß√£o:', error);
          alert('Erro no sistema. Tente novamente.');
          document.getElementById('codeForm').style.display = 'block';
          document.getElementById('loginLoading').classList.add('hidden');
        }
      }

      // Voltar para o formul√°rio de email
      function backToEmailForm() {
        document.getElementById('codeForm').classList.add('hidden');
        document.getElementById('loginForm').style.display = 'block';
        document.getElementById('emailInput').focus();
        document.getElementById('codeInput').value = '';
        tempEmail = '';
      }

      // Logout
      async function logout() {
        if (confirm('Deseja realmente sair?')) {
          await supabaseClient.auth.signOut();
          currentUser = null;
          currentUserData = null; // Limpar dados do usu√°rio
          currentSetor = null;
          isAdmin = false;
          showLoginScreen();
        }
      }

      // Atualizar interface com dados do usu√°rio
      function updateUserInterface() {
        if (currentUser) {
          // Atualizar nome do usu√°rio
          const userName = document.getElementById('userName');
          if (userName) {
            userName.textContent = currentUser.user_metadata?.full_name || currentUser.email.split('@')[0];
          }

          // Atualizar setor com cor
          const userSetor = document.getElementById('userSetor');
          if (userSetor) {
            if (isAdmin) {
              // Admin v√™ "TODOS OS SETORES"
              userSetor.textContent = 'TODOS OS SETORES';
              userSetor.style.backgroundColor = '#DC2626'; // Vermelho para admin
              userSetor.style.color = 'white';
            } else if (currentSetor) {
              // Usu√°rio normal mostra seu setor
              userSetor.textContent = currentSetor.nome;
              userSetor.style.backgroundColor = currentSetor.cor || '#3B82F6';
              userSetor.style.color = 'white';
            }
          }

          // Mostrar/ocultar elementos de administra√ß√£o
          const btnAdmin = document.getElementById('btnAdmin');
          const btnManageStatus = document.getElementById('btnManageStatus');
          const btnNew = document.getElementById('btnNew');
          const btnReset = document.getElementById('btnReset');
          const btnResetFilters = document.getElementById('btnResetFilters');
          const btnExport = document.getElementById('btnExport');
          const btnImport = document.getElementById('btnImport');
          const setorFilter = document.getElementById('setorFilter');

          if (isAdmin) {
            // Mostrar elementos para admin
            if (btnAdmin) btnAdmin.classList.remove('hidden');
            if (btnManageStatus) btnManageStatus.classList.remove('hidden');
            if (btnNew) btnNew.classList.remove('hidden');
            if (btnReset) btnReset.classList.remove('hidden');
            if (btnExport) btnExport.classList.remove('hidden');
            if (btnImport) btnImport.classList.remove('hidden');
            if (setorFilter) setorFilter.style.display = 'flex';
            
            // Carregar setores no dropdown
            populateSetorFilter();
            
            // Adicionar badge de admin - APENAS se for realmente admin
            const userInfo = document.getElementById('userInfo');
            if (userInfo && !userInfo.querySelector('.admin-badge') && isAdmin === true) {
              const adminBadge = document.createElement('span');
              adminBadge.className = 'admin-badge text-xs px-2 py-1 bg-red-100 text-red-700 rounded-full';
              adminBadge.textContent = 'Admin';
              userInfo.appendChild(adminBadge);
            }
          } else {
            // Ocultar elementos para usu√°rio normal
            if (btnAdmin) btnAdmin.classList.add('hidden');
            if (btnManageStatus) btnManageStatus.classList.add('hidden');
            if (btnNew) btnNew.classList.add('hidden');
            if (btnReset) btnReset.classList.add('hidden');
            if (btnExport) btnExport.classList.add('hidden');
            if (btnImport) btnImport.classList.add('hidden');
            if (setorFilter) setorFilter.style.display = 'none';
            
            // Remover badge de admin se existir
            const userInfo = document.getElementById('userInfo');
            const adminBadge = userInfo?.querySelector('.admin-badge');
            if (adminBadge) {
              adminBadge.remove();
            }
          }
          
          // Bot√£o "Limpar Filtros" sempre dispon√≠vel para todos os usu√°rios
          if (btnResetFilters) btnResetFilters.classList.remove('hidden');
        }
      }

      // Fun√ß√µes de Administra√ß√£o
      async function populateSetorFilter() {
        try {
          console.log('üîÑ Carregando setores para filtro principal...');
          
          const { data: setores, error } = await supabaseClient
            .from('setores')
            .select('*')
            .eq('ativo', true)
            .order('nome');

          console.log('üìä Setores carregados para filtro:', setores);
          console.log('‚ùå Erro (se houver):', error);

          if (error) throw error;

          const setorSelect = document.getElementById('setorSelect');
          console.log('üîç Elemento setorSelect encontrado:', !!setorSelect);
          
          if (setorSelect) {
            // Limpar op√ß√µes existentes
            setorSelect.innerHTML = '<option value="">üåê Todos os Setores</option>';
            
            // Adicionar setores
            setores.forEach(setor => {
              const option = document.createElement('option');
              option.value = setor.id;
              option.textContent = setor.nome;
              setorSelect.appendChild(option);
              console.log('‚ûï Setor adicionado ao filtro:', setor.nome);
            });
            
            console.log('‚úÖ Total de setores adicionados ao filtro:', setores.length);
          }
        } catch (error) {
          console.error('Erro ao carregar setores:', error);
          showToast('Erro ao carregar setores para filtro', 'error');
        }
      }

      function handleSetorFilter() {
        const setorSelect = document.getElementById('setorSelect');
        if (setorSelect) {
          selectedSetorFilter = setorSelect.value || null;
          console.log('Filtro alterado para setor:', selectedSetorFilter);
          loadTasks(); // Recarregar tasks com o filtro aplicado
        }
      }

      function openAdminPanel() {
        // Por enquanto, mostrar um alert
        // Depois implementaremos modais espec√≠ficos
        const options = [
          'Gerenciar Usu√°rios',
          'Gerenciar Setores'
        ];
        
        const choice = prompt('Escolha uma op√ß√£o:\n1. ' + options.join('\n2. ') + '\n\nDigite o n√∫mero (1-' + options.length + '):');
        
        switch(choice) {
          case '1':
            openUserManagement();
            break;
          case '2':
            openSetorManagement(); 
            break;
          default:
            if (choice !== null) {
              showToast('Op√ß√£o inv√°lida', 'error');
            }
        }
      }

      async function openUserManagement() {
        console.log('üë• Abrindo gerenciamento de usu√°rios...');
        
        const modal = document.getElementById('userManagementModal');
        modal.showModal();
        
        // Aguardar o modal ser renderizado antes de carregar dados
        await new Promise(resolve => setTimeout(resolve, 100));
        
        // Carregar usu√°rios E setores dinamicamente
        await loadUsersForManagement();
        loadSetoresDynamic();
        
        console.log('‚úÖ Modal de usu√°rios aberto e dados carregados');
      }

      function openSetorManagement() {
        const modal = document.getElementById('setorManagementModal');
        modal.showModal();
        loadSetoresForManagement();
      }

      function openAdminReports() {
        const modal = document.getElementById('adminReportsModal');
        modal.showModal();
        loadAdminReports();
      }

      // === GERENCIAMENTO DE USU√ÅRIOS ===
      async function loadUsersForManagement() {
        try {
          const { data: usuarios, error } = await supabaseClient
            .from('usuarios')
            .select(`
              *,
              setores(nome, cor)
            `)
            .order('nome');

          if (error) throw error;

          const usersList = document.getElementById('usersList');
          usersList.innerHTML = '';

          // Verifica√ß√£o simples para evitar erro
          if (!usuarios || usuarios.length === 0) {
            usersList.innerHTML = '<p class="text-gray-500 text-center py-8">Nenhum usu√°rio cadastrado</p>';
            return;
          }

          usuarios.forEach(user => {
            const userCard = createUserCard(user);
            usersList.appendChild(userCard);
          });

          console.log('‚úÖ Usu√°rios carregados com sucesso');

        } catch (error) {
          console.error('Erro ao carregar usu√°rios:', error);
          showToast('Erro ao carregar usu√°rios', 'error');
        }
      }

      function createUserCard(user) {
        const div = document.createElement('div');
        div.className = 'bg-white p-4 rounded-xl border shadow-sm hover:shadow-md transition';
        
        const statusBadge = user.ativo 
          ? '<span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs font-medium">Ativo</span>'
          : '<span class="px-2 py-1 bg-red-100 text-red-800 rounded-full text-xs font-medium">Inativo</span>';
          
        const adminBadge = user.is_admin 
          ? '<span class="px-2 py-1 bg-purple-100 text-purple-800 rounded-full text-xs font-medium">Admin</span>'
          : '';

        const setorInfo = user.setores 
          ? `<span class="inline-block px-2 py-1 rounded-full text-xs font-medium text-white" style="background-color: ${user.setores.cor || '#3B82F6'}">${user.setores.nome}</span>`
          : '<span class="text-gray-500 text-sm">Sem setor</span>';

        div.innerHTML = `
          <div class="flex justify-between items-start mb-3">
            <div class="flex-1">
              <h4 class="font-semibold text-gray-900">${user.nome}</h4>
              <p class="text-sm text-gray-600">${user.email}</p>
              <div class="flex gap-2 mt-2">
                ${setorInfo}
                ${adminBadge}
                ${statusBadge}
              </div>
            </div>
            <div class="flex gap-2">
              <button onclick="editUser('${user.id}')" class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition" title="Editar">
                <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                  <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                  <path d="M18.5 2.5a2.12 2.12 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                </svg>
              </button>
              <button onclick="toggleUserStatus('${user.id}', ${user.ativo})" class="p-2 ${user.ativo ? 'text-red-600 hover:bg-red-50' : 'text-green-600 hover:bg-green-50'} rounded-lg transition" title="${user.ativo ? 'Desativar' : 'Ativar'}">
                ${user.ativo 
                  ? '<svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>' 
                  : '<svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>'
                }
              </button>
            </div>
          </div>
        `;

        return div;
      }

      async function loadSetoresForUserForm() {
        try {
          console.log('üîÑ Carregando setores para formul√°rio de usu√°rio...');
          
          const { data: setores, error } = await supabaseClient
            .from('setores')
            .select('*')
            .eq('ativo', true)
            .order('nome');

          console.log('üìä Setores carregados:', setores);
          console.log('‚ùå Erro (se houver):', error);

          if (error) throw error;

          // Verifica√ß√£o simples para evitar erro
          if (!setores) {
            console.log('‚ö†Ô∏è Setores √© null/undefined');
            return;
          }

          // Tentar encontrar o elemento com retry
          let setorSelect = null;
          let attempts = 0;
          const maxAttempts = 10;
          
          while (!setorSelect && attempts < maxAttempts) {
            setorSelect = document.getElementById('userSetorSelect');
            if (!setorSelect) {
              console.log(`üîç Tentativa ${attempts + 1}/${maxAttempts} - Elemento userSetorSelect n√£o encontrado, aguardando...`);
              await new Promise(resolve => setTimeout(resolve, 100));
            }
            attempts++;
          }
          
          console.log('üîç Elemento userSetor encontrado:', !!setorSelect);
          
          if (setorSelect) {
            // Primeira abordagem: limpar e recriar
            setorSelect.innerHTML = '';
            
            // Adicionar op√ß√£o padr√£o
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = 'Selecione um setor';
            setorSelect.appendChild(defaultOption);
            
            // Adicionar setores
            if (setores && setores.length > 0) {
              setores.forEach(setor => {
                const option = document.createElement('option');
                option.value = setor.id;
                option.textContent = setor.nome;
                setorSelect.appendChild(option);
                console.log('‚ûï Setor adicionado ao select:', setor.nome);
              });
              
              console.log('‚úÖ Total de setores adicionados:', setores.length);
            } else {
              console.log('‚ö†Ô∏è Nenhum setor para adicionar');
            }
            console.log('üîç HTML final do select:', setorSelect.innerHTML);
            
            // For√ßar refresh do select - m√∫ltiplas abordagens
            setorSelect.dispatchEvent(new Event('change'));
            setorSelect.focus();
            setorSelect.blur();
            
            // Se ainda n√£o funcionar, tentar abordagem alternativa
            setTimeout(() => {
              if (setorSelect.options.length <= 1) {
                console.log('‚ö†Ô∏è Tentando abordagem alternativa...');
                
                // M√©todo alternativo: usar innerHTML diretamente
                let optionsHTML = '<option value="">Selecione um setor</option>';
                setores.forEach(setor => {
                  optionsHTML += `<option value="${setor.id}">${setor.nome}</option>`;
                });
                
                setorSelect.innerHTML = optionsHTML;
                console.log('üîÑ Select reconstru√≠do com innerHTML:', setorSelect.innerHTML);
              }
            }, 200);
            
          } else {
            console.error('‚ùå Elemento userSetor n√£o foi encontrado ap√≥s m√∫ltiplas tentativas');
            showToast('Erro: Formul√°rio n√£o carregou completamente. Tente novamente.', 'error');
          }

        } catch (error) {
          console.error('‚ùå Erro ao carregar setores para formul√°rio:', error);
          showToast('Erro ao carregar setores para formul√°rio', 'error');
        }
      }
      
      // Fun√ß√£o direta para carregar setores sem complexidade
      async function loadSetoresDirectly() {
        console.log('üéØ Carregando setores de forma direta...');
        
        // Verificar se o Supabase est√° inicializado
        if (!supabase) {
          console.error('‚ùå Supabase n√£o est√° inicializado');
          showToast('Erro: Conex√£o com banco de dados n√£o estabelecida', 'error');
          return;
        }
        
        const select = document.getElementById('userSetor');
        if (!select) {
          console.error('‚ùå Select userSetor n√£o encontrado');
          return;
        }
        
        console.log('üìç Select encontrado:', select);
        
        // Limpar op√ß√µes existentes
        select.innerHTML = '<option value="">Carregando...</option>';
        
        try {
          console.log('üîÑ Fazendo consulta ao Supabase...');
          
          const { data: setores, error } = await supabase
            .from('setores')
            .select('id, nome')
            .order('nome');
            
          console.log('üìä Resultado da consulta:', { setores, error });
            
          if (error) {
            console.error('‚ùå Erro ao carregar setores:', error);
            select.innerHTML = '<option value="">Erro ao carregar setores</option>';
            showToast(`Erro ao carregar setores: ${error.message}`, 'error');
            return;
          }
          
          console.log('‚úÖ Setores carregados:', setores);
          
          // Resetar para op√ß√£o padr√£o
          select.innerHTML = '<option value="">Selecione um setor</option>';
          
          if (!setores || setores.length === 0) {
            console.warn('‚ö†Ô∏è Nenhum setor encontrado');
            const option = document.createElement('option');
            option.value = '';
            option.textContent = 'Nenhum setor cadastrado';
            option.disabled = true;
            select.appendChild(option);
            return;
          }
          
          // Adicionar cada setor
          setores.forEach(setor => {
            console.log('‚ûï Adicionando setor:', setor);
            const option = document.createElement('option');
            option.value = setor.id;
            option.textContent = setor.nome;
            select.appendChild(option);
          });
          
          console.log('‚úÖ Select populado com', setores.length, 'setores');
          console.log('HTML final do select:', select.innerHTML);
          
        } catch (error) {
          console.error('‚ùå Erro na fun√ß√£o loadSetoresDirectly:', error);
          select.innerHTML = '<option value="">Erro inesperado</option>';
          showToast(`Erro inesperado: ${error.message}`, 'error');
        }
      }

      async function showUserForm(title = 'Novo Usu√°rio') {
        console.log('üìã Exibindo formul√°rio de usu√°rio:', title);
        
        document.getElementById('userFormTitle').textContent = title;
        document.getElementById('userForm').classList.remove('hidden');
        
        // Aguardar o formul√°rio ser renderizado ANTES de fazer qualquer opera√ß√£o
        await new Promise(resolve => setTimeout(resolve, 150));
        
        // Sempre carregar setores quando exibir o formul√°rio (ANTES do reset)
        console.log('üîÑ Carregando setores para formul√°rio...');
        await loadSetoresForUserForm();
        
        // Reset form DEPOIS de carregar os setores (mas mantendo as options)
        const userSetor = document.getElementById('userSetor');
        const setorHTML = userSetor ? userSetor.innerHTML : '';
        
        document.getElementById('userFormData').reset();
        document.getElementById('editUserId').value = '';
        
        // Restaurar as op√ß√µes do setor se foram perdidas
        if (userSetor && setorHTML) {
          userSetor.innerHTML = setorHTML;
          console.log('üîÑ Options do setor restauradas ap√≥s reset');
        }
        
        console.log('‚úÖ Formul√°rio de usu√°rio configurado completamente');
      }

      function hideUserForm() {
        document.getElementById('userForm').classList.add('hidden');
      }

      async function editUser(userId) {
        console.log('‚úèÔ∏è Editando usu√°rio ID:', userId);
        
        try {
          const { data: user, error } = await supabaseClient
            .from('usuarios')
            .select('*')
            .eq('id', userId)
            .single();

          if (error) throw error;

          console.log('üìã Dados do usu√°rio:', user);

          // Mostrar formul√°rio primeiro
          document.getElementById('userFormTitle').textContent = 'Editar Usu√°rio';
          document.getElementById('userForm').classList.remove('hidden');
          
          // Carregar setores antes de preencher
          await loadSetoresDynamic();
          
          // Aguardar um pouco para garantir que os setores foram carregados
          await new Promise(resolve => setTimeout(resolve, 300));

          // Preencher formul√°rio com os dados do usu√°rio - M√âTODO FOR√áADO
          document.getElementById('editUserId').value = user.id;
          document.getElementById('userEmail').value = user.email || '';
          
          // Tentar m√∫ltiplas formas de preencher o nome
          const nomeField = document.getElementById('userNameInput');
          console.log('üîç Campo userNameInput encontrado:', !!nomeField);
          
          if (nomeField) {
            // M√©todo 1: value direto
            nomeField.value = user.nome || '';
            
            // M√©todo 2: setAttribute  
            nomeField.setAttribute('value', user.nome || '');
            
            // M√©todo 3: for√ßar eventos
            nomeField.dispatchEvent(new Event('input', { bubbles: true }));
            nomeField.dispatchEvent(new Event('change', { bubbles: true }));
            
            // M√©todo 4: innerHTML para debug
            console.log('üìù Tentativas de preenchimento do nome:');
            console.log('- user.nome:', user.nome);
            console.log('- nomeField.value ap√≥s set:', nomeField.value);
            console.log('- nomeField.getAttribute value:', nomeField.getAttribute('value'));
          }
          
          document.getElementById('userSetorSelect').value = user.setor_id || '';
          document.getElementById('userIsAdmin').checked = user.is_admin || false;

          // Debug detalhado
          console.log('üîç Debug dos campos preenchidos:');
          console.log('- ID:', user.id);
          console.log('- Email:', user.email);
          console.log('- Nome:', user.nome);
          console.log('- Setor ID:', user.setor_id);
          console.log('- Is Admin:', user.is_admin);
          console.log('- Campo userName preenchido com:', document.getElementById('userName').value);

          // Aguardar mais um pouco e verificar se ainda est√° l√°
          setTimeout(() => {
            const nomeAtual = document.getElementById('userName').value;
            console.log('üïê Verifica√ß√£o ap√≥s 500ms - Nome ainda est√°:', nomeAtual);
            if (!nomeAtual) {
              console.log('‚ùå PROBLEMA: Nome foi limpo por alguma fun√ß√£o!');
              // Tentar preencher novamente
              document.getElementById('userName').value = user.nome || '';
              console.log('üîÑ Tentativa de preencher novamente...');
            }
          }, 500);

          // Solu√ß√£o adicional: for√ßar preenchimento ap√≥s 1 segundo
          setTimeout(() => {
            document.getElementById('userName').value = user.nome || '';
            console.log('üîí Preenchimento for√ßado ap√≥s 1s com:', user.nome);
          }, 1000);

          console.log('‚úÖ Formul√°rio preenchido com dados do usu√°rio');

        } catch (error) {
          console.error('‚ùå Erro ao carregar dados do usu√°rio:', error);
          showToast('Erro ao carregar dados do usu√°rio', 'error');
        }
      }

      async function saveUser(formData) {
        console.log('üíæ Tentando salvar usu√°rio...', Object.fromEntries(formData));
        
        try {
          const userId = formData.get('editUserId');
          const userData = {
            email: formData.get('userEmail'),
            nome: formData.get('userName'),
            setor_id: formData.get('userSetor') || null,
            is_admin: formData.get('userIsAdmin') === 'on',
            ativo: true
          };

          console.log('üìä Dados do usu√°rio:', userData);

          let result;
          if (userId) {
            // Editar usu√°rio existente
            console.log('‚úèÔ∏è Editando usu√°rio ID:', userId);
            result = await supabaseClient
              .from('usuarios')
              .update(userData)
              .eq('id', userId);
          } else {
            // Criar novo usu√°rio
            console.log('üÜï Criando novo usu√°rio');
            result = await supabaseClient
              .from('usuarios')
              .insert([userData]);
          }

          console.log('üìã Resultado da opera√ß√£o:', result);

          if (result.error) {
            console.error('‚ùå Erro Supabase:', result.error);
            throw result.error;
          }

          showToast(userId ? 'Usu√°rio atualizado com sucesso' : 'Usu√°rio criado com sucesso', 'success');
          hideUserForm();
          loadUsersForManagement();

        } catch (error) {
          console.error('‚ùå Erro ao salvar usu√°rio:', error);
          
          // Mostrar erro espec√≠fico do RLS
          if (error.message.includes('row-level security policy')) {
            showToast('ERRO: Permiss√µes do banco de dados. Execute: ALTER TABLE usuarios DISABLE ROW LEVEL SECURITY;', 'error');
          } else {
            showToast('Erro ao salvar usu√°rio: ' + error.message, 'error');
          }
        }
      }

      async function toggleUserStatus(userId, currentStatus) {
        try {
          const { error } = await supabaseClient
            .from('usuarios')
            .update({ ativo: !currentStatus })
            .eq('id', userId);

          if (error) throw error;

          showToast(`Usu√°rio ${!currentStatus ? 'ativado' : 'desativado'} com sucesso`, 'success');
          loadUsersForManagement();

        } catch (error) {
          console.error('Erro ao alterar status do usu√°rio:', error);
          showToast('Erro ao alterar status do usu√°rio', 'error');
        }
      }

      // === GERENCIAMENTO DE SETORES ===
      async function loadSetoresForManagement() {
        try {
          const { data: setores, error } = await supabaseClient
            .from('setores')
            .select('*')
            .order('nome');

          if (error) throw error;

          // Contar usu√°rios por setor
          const { data: usuariosCount, error: countError } = await supabaseClient
            .from('usuarios')
            .select('setor_id')
            .eq('ativo', true);

          if (!countError) {
            // Agrupar contagem por setor
            const countBySetor = {};
            usuariosCount.forEach(user => {
              if (user.setor_id) {
                countBySetor[user.setor_id] = (countBySetor[user.setor_id] || 0) + 1;
              }
            });

            // Adicionar contagem aos setores
            setores.forEach(setor => {
              setor.usuariosCount = countBySetor[setor.id] || 0;
            });
          }

          const setoresList = document.getElementById('setoresList');
          setoresList.innerHTML = '';

          if (setores.length === 0) {
            setoresList.innerHTML = '<p class="text-gray-500 text-center py-8 col-span-full">Nenhum setor cadastrado</p>';
            return;
          }

          setores.forEach(setor => {
            const setorCard = createSetorCard(setor);
            setoresList.appendChild(setorCard);
          });

        } catch (error) {
          console.error('Erro ao carregar setores:', error);
          showToast('Erro ao carregar setores', 'error');
        }
      }

      function createSetorCard(setor) {
        const div = document.createElement('div');
        div.className = 'bg-white p-4 rounded-xl border shadow-sm hover:shadow-md transition';
        
        const statusBadge = setor.ativo 
          ? '<span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs font-medium">Ativo</span>'
          : '<span class="px-2 py-1 bg-red-100 text-red-800 rounded-full text-xs font-medium">Inativo</span>';

        div.innerHTML = `
          <div class="flex items-center gap-3 mb-3">
            <div class="w-4 h-4 rounded-full" style="background-color: ${setor.cor || '#3B82F6'}"></div>
            <h4 class="font-semibold text-gray-900 flex-1">${setor.nome}</h4>
            ${statusBadge}
          </div>
          
          ${setor.descricao ? `<p class="text-sm text-gray-600 mb-3">${setor.descricao}</p>` : ''}
          
          <div class="text-sm text-gray-500 mb-3">
            Usu√°rios: <span class="font-medium">${setor.usuariosCount || 0}</span>
          </div>

          <div class="flex gap-2">
            <button onclick="editSetor('${setor.id}')" class="flex-1 px-3 py-2 text-blue-600 hover:bg-blue-50 rounded-lg transition text-sm font-medium">
              Editar
            </button>
            <button onclick="toggleSetorStatus('${setor.id}', ${setor.ativo})" class="px-3 py-2 ${setor.ativo ? 'text-red-600 hover:bg-red-50' : 'text-green-600 hover:bg-green-50'} rounded-lg transition text-sm font-medium">
              ${setor.ativo ? 'Desativar' : 'Ativar'}
            </button>
          </div>
        `;

        return div;
      }

      function showSetorForm(title = 'Novo Setor', resetForm = true) {
        console.log('üìã Exibindo formul√°rio:', title, '| Reset:', resetForm);
        
        document.getElementById('setorFormTitle').textContent = title;
        document.getElementById('setorForm').classList.remove('hidden');
        
        // S√≥ fazer reset se for um novo setor
        if (resetForm) {
          console.log('üîÑ Resetando formul√°rio para novo setor');
          document.getElementById('setorFormData').reset();
          document.getElementById('editSetorId').value = '';
          
          // Cor padr√£o para novos setores
          document.getElementById('setorCor').value = '#3B82F6';
          document.getElementById('setorCorText').value = '#3B82F6';
        } else {
          console.log('‚úèÔ∏è Mantendo dados para edi√ß√£o');
        }
      }

      function hideSetorForm() {
        document.getElementById('setorForm').classList.add('hidden');
      }

      async function editSetor(setorId) {
        try {
          console.log('üìù Iniciando edi√ß√£o do setor:', setorId);
          
          const { data: setor, error } = await supabaseClient
            .from('setores')
            .select('*')
            .eq('id', setorId)
            .single();

          console.log('üìä Dados do setor carregados:', setor);
          console.log('‚ùå Erro (se houver):', error);

          if (error) throw error;

          // Verificar se os elementos existem
          const editSetorIdElement = document.getElementById('editSetorId');
          const setorNomeElement = document.getElementById('setorNome');
          const setorDescricaoElement = document.getElementById('setorDescricao');
          const setorCorElement = document.getElementById('setorCor');
          const setorCorTextElement = document.getElementById('setorCorText');
          
          console.log('üîç Elementos encontrados:', {
            editSetorId: !!editSetorIdElement,
            setorNome: !!setorNomeElement,
            setorDescricao: !!setorDescricaoElement,
            setorCor: !!setorCorElement,
            setorCorText: !!setorCorTextElement
          });

          // Preencher formul√°rio
          if (editSetorIdElement) editSetorIdElement.value = setor.id;
          if (setorNomeElement) setorNomeElement.value = setor.nome || '';
          if (setorDescricaoElement) setorDescricaoElement.value = setor.descricao || '';
          if (setorCorElement) setorCorElement.value = setor.cor || '#3B82F6';
          if (setorCorTextElement) setorCorTextElement.value = setor.cor || '#3B82F6';

          console.log('‚úÖ Formul√°rio preenchido com dados do setor');
          
          showSetorForm('Editar Setor', false); // false = n√£o resetar formul√°rio
          
          console.log('‚úÖ Formul√°rio de edi√ß√£o exibido');

        } catch (error) {
          console.error('‚ùå Erro ao carregar dados do setor:', error);
          showToast('Erro ao carregar dados do setor', 'error');
        }
      }

      async function saveSetor(formData) {
        try {
          console.log('üîÑ Salvando setor...', formData);
          
          const setorId = formData.get('editSetorId');
          const setorData = {
            nome: formData.get('setorNome'),
            descricao: formData.get('setorDescricao') || null,
            cor: formData.get('setorCor'),
            ativo: true
          };

          console.log('üìù Dados do setor:', setorData);
          console.log('üÜî ID do setor (para edi√ß√£o):', setorId);
          console.log('üë§ Usu√°rio atual:', currentUser);
          console.log('üîê √â admin:', isAdmin);

          // Verificar se √© admin antes de tentar salvar
          if (!isAdmin && !BYPASS_AUTH) {
            showToast('Apenas administradores podem gerenciar setores', 'error');
            return;
          }

          let result;
          if (setorId) {
            // Editar setor existente
            console.log('‚úèÔ∏è Editando setor existente...');
            result = await supabaseClient
              .from('setores')
              .update(setorData)
              .eq('id', setorId);
          } else {
            // Criar novo setor - tentar com diferentes abordagens
            console.log('üÜï Criando novo setor...');
            
            try {
              // Primeira tentativa: inser√ß√£o direta
              result = await supabaseClient
                .from('setores')
                .insert([setorData]);
                
              if (result.error) throw result.error;
              
            } catch (directError) {
              console.log('‚ùå Falha na inser√ß√£o direta:', directError);
              
              // Segunda tentativa: usar SQL direto via RPC
              try {
                console.log('üîÑ Tentando inser√ß√£o via SQL direto...');
                
                const sqlQuery = `
                  INSERT INTO setores (nome, descricao, cor, ativo) 
                  VALUES ('${setorData.nome}', '${setorData.descricao || ''}', '${setorData.cor}', ${setorData.ativo})
                  RETURNING *
                `;
                
                result = await supabaseClient
                  .rpc('exec_sql', { sql_query: sqlQuery });
                
                if (result.error) throw result.error;
                
              } catch (sqlError) {
                console.log('‚ùå SQL direto tamb√©m falhou:', sqlError);
                
                // Terceira tentativa: inser√ß√£o com bypass de RLS
                try {
                  console.log('üîÑ Tentando com bypass de seguran√ßa...');
                  
                  // Usar a API diretamente com configura√ß√£o de seguran√ßa
                  result = await supabaseClient
                    .from('setores')
                    .insert([setorData], { 
                      upsert: false,
                      onConflict: 'nome' 
                    });
                    
                  if (result.error) throw result.error;
                  
                } catch (bypassError) {
                  console.log('‚ùå Todas as tentativas falharam:', bypassError);
                  
                  // Se chegou at√© aqui, √© problema de configura√ß√£o do banco
                  if (bypassError.message?.includes('row-level security') || 
                      directError.message?.includes('row-level security')) {
                    
                    showToast(`‚ùå ERRO DE CONFIGURA√á√ÉO DO BANCO
                    
üîí As pol√≠ticas de seguran√ßa do Supabase est√£o impedindo a cria√ß√£o de setores.

üí° SOLU√á√ÉO R√ÅPIDA:
1. Abra o SQL Editor no Supabase
2. Execute: ALTER TABLE setores DISABLE ROW LEVEL SECURITY;
3. Ou crie uma pol√≠tica: CREATE POLICY "allow_all_setores" ON setores FOR ALL USING (true);

üìß Entre em contato com o administrador do banco de dados.`, 'error');
                    
                    return;
                  }
                  
                  // Se n√£o √© erro de RLS, re-throw o erro original
                  throw directError;
                }
              }
            }
          }

          console.log('üì§ Resultado da opera√ß√£o:', result);

          showToast(setorId ? 'Setor atualizado com sucesso' : 'Setor criado com sucesso', 'success');
          hideSetorForm();
          loadSetoresForManagement();
          
          // Atualizar filtro de setores se necess√°rio
          if (isAdmin) {
            populateSetorFilter();
          }

        } catch (error) {
          console.error('Erro ao salvar setor:', error);
          showToast('Erro ao salvar setor: ' + error.message, 'error');
        }
      }

      async function toggleSetorStatus(setorId, currentStatus) {
        try {
          const { error } = await supabaseClient
            .from('setores')
            .update({ ativo: !currentStatus })
            .eq('id', setorId);

          if (error) throw error;

          showToast(`Setor ${!currentStatus ? 'ativado' : 'desativado'} com sucesso`, 'success');
          loadSetoresForManagement();
          
          // Atualizar filtro de setores se necess√°rio
          if (isAdmin) {
            populateSetorFilter();
          }

        } catch (error) {
          console.error('Erro ao alterar status do setor:', error);
          showToast('Erro ao alterar status do setor', 'error');
        }
      }

      // === RELAT√ìRIOS ADMINISTRATIVOS ===
      async function loadAdminReports() {
        console.log('üìä loadAdminReports chamada');
        try {
          await Promise.all([
            loadDashboardStats(),
            loadTasksPerSetorChart(),
            loadUsersPerSetorTable(),
            loadPendingRequests()
          ]);
          console.log('üìä loadAdminReports conclu√≠da com sucesso');
        } catch (error) {
          console.error('Erro ao carregar relat√≥rios:', error);
          showToast('Erro ao carregar relat√≥rios administrativos', 'error');
        }
      }

      async function loadDashboardStats() {
        try {
          // Total de usu√°rios
          const { count: totalUsers } = await supabaseClient
            .from('usuarios')
            .select('*', { count: 'exact', head: true })
            .eq('ativo', true);

          // Total de setores
          const { count: totalSetores } = await supabaseClient
            .from('setores')
            .select('*', { count: 'exact', head: true })
            .eq('ativo', true);

          // Total de tarefas
          const { count: totalTasks } = await supabaseClient
            .from('tasks')
            .select('*', { count: 'exact', head: true });

          // Tarefas conclu√≠das
          const { count: completedTasks } = await supabaseClient
            .from('tasks')
            .select('*', { count: 'exact', head: true })
            .eq('status', 'Conclu√≠do');

          // Atualizar cards
          document.getElementById('totalUsers').textContent = totalUsers || 0;
          document.getElementById('totalSetores').textContent = totalSetores || 0;
          document.getElementById('totalTasks').textContent = totalTasks || 0;
          document.getElementById('completedTasks').textContent = completedTasks || 0;

        } catch (error) {
          console.error('Erro ao carregar estat√≠sticas:', error);
        }
      }

      async function loadTasksPerSetorChart() {
        try {
          const { data: tasksData, error } = await supabaseClient
            .from('tasks')
            .select(`
              setor_id,
              setores(nome, cor)
            `);

          if (error) throw error;

          // Agrupar por setor
          const setorCounts = {};
          const setorInfo = {};
          
          tasksData.forEach(task => {
            if (task.setor_id && task.setores) {
              setorCounts[task.setor_id] = (setorCounts[task.setor_id] || 0) + 1;
              setorInfo[task.setor_id] = task.setores;
            }
          });

          const labels = Object.values(setorInfo).map(s => s.nome);
          const data = Object.values(setorCounts);
          const colors = Object.values(setorInfo).map(s => s.cor || '#3B82F6');

          // Criar gr√°fico (usando Chart.js se dispon√≠vel)
          const ctx = document.getElementById('tasksPerSetorChart');
          if (ctx && window.Chart) {
            new Chart(ctx, {
              type: 'doughnut',
              data: {
                labels: labels,
                datasets: [{
                  data: data,
                  backgroundColor: colors,
                  borderWidth: 1
                }]
              },
              options: {
                responsive: true,
                plugins: {
                  legend: {
                    position: 'bottom'
                  }
                }
              }
            });
          } else {
            ctx.parentNode.innerHTML = '<p class="text-gray-500 text-center py-8">Gr√°fico requer Chart.js</p>';
          }

        } catch (error) {
          console.error('Erro ao carregar gr√°fico de tarefas por setor:', error);
        }
      }

      async function loadUsersPerSetorTable() {
        try {
          const { data: setores, error } = await supabaseClient
            .from('setores')
            .select(`
              *,
              usuarios!inner(count)
            `)
            .eq('ativo', true);

          if (error) throw error;

          // Contar usu√°rios por setor
          const { data: usuariosData } = await supabaseClient
            .from('usuarios')
            .select('setor_id, setores(nome, cor)')
            .eq('ativo', true);

          const setorStats = {};
          usuariosData.forEach(user => {
            if (user.setor_id && user.setores) {
              if (!setorStats[user.setor_id]) {
                setorStats[user.setor_id] = {
                  nome: user.setores.nome,
                  cor: user.setores.cor,
                  count: 0
                };
              }
              setorStats[user.setor_id].count++;
            }
          });

          const tableContainer = document.getElementById('usersPerSetorTable');
          
          if (Object.keys(setorStats).length === 0) {
            tableContainer.innerHTML = '<p class="text-gray-500 text-center py-8">Nenhum dados encontrados</p>';
            return;
          }

          const table = `
            <table class="w-full text-sm">
              <thead>
                <tr class="border-b">
                  <th class="text-left py-3 px-2">Setor</th>
                  <th class="text-center py-3 px-2">Usu√°rios Ativos</th>
                  <th class="text-center py-3 px-2">Percentual</th>
                </tr>
              </thead>
              <tbody>
                ${Object.values(setorStats).map(setor => {
                  const totalUsers = Object.values(setorStats).reduce((sum, s) => sum + s.count, 0);
                  const percentage = totalUsers > 0 ? ((setor.count / totalUsers) * 100).toFixed(1) : 0;
                  
                  return `
                    <tr class="border-b hover:bg-gray-50">
                      <td class="py-3 px-2">
                        <div class="flex items-center gap-2">
                          <div class="w-3 h-3 rounded-full" style="background-color: ${setor.cor}"></div>
                          ${setor.nome}
                        </div>
                      </td>
                      <td class="text-center py-3 px-2 font-medium">${setor.count}</td>
                      <td class="text-center py-3 px-2">${percentage}%</td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
          `;

          tableContainer.innerHTML = table;

        } catch (error) {
          console.error('Erro ao carregar tabela de usu√°rios por setor:', error);
        }
      }

      // Event Listeners
      document.getElementById('loginForm')?.addEventListener('submit', async function(e) {
        e.preventDefault();
        const email = document.getElementById('emailInput').value;
        if (email) {
          // Teste de conectividade antes de enviar o c√≥digo
          try {
            console.log('üîç Testando conectividade com Supabase...');
            const { data, error } = await supabaseClient.from('usuarios').select('count', { count: 'exact', head: true });
            console.log('‚úÖ Conectividade OK');
            sendVerificationCode(email);
          } catch (error) {
            console.error('‚ùå Erro de conectividade:', error);
            alert('Erro de conex√£o com o servidor. Verifique sua internet e tente novamente.');
          }
        }
      });

      document.getElementById('codeForm')?.addEventListener('submit', function(e) {
        e.preventDefault();
        const code = document.getElementById('codeInput').value;
        if (code && tempEmail) {
          verifyCode(tempEmail, code);
        }
      });

      document.getElementById('backToEmail')?.addEventListener('click', backToEmailForm);
      document.getElementById('btnLogout')?.addEventListener('click', logout);
      document.getElementById('btnAdmin')?.addEventListener('click', openAdminPanel);
      document.getElementById('setorSelect')?.addEventListener('change', handleSetorFilter);

      // Event listeners para o novo modal de pend√™ncias
      document.getElementById('btnPendingApprovals')?.addEventListener('click', () => {
        const modal = document.getElementById('pendingApprovalsModal');
        if (modal) {
          modal.showModal();
          loadPendingRequests();
        } else {
          console.error('‚ùå Modal pendingApprovalsModal n√£o encontrado!');
        }
      });

      document.getElementById('btnClosePendingModal')?.addEventListener('click', () => {
        const modal = document.getElementById('pendingApprovalsModal');
        if (modal) {
          modal.close();
        }
      });

      document.getElementById('btnClosePendingModal2')?.addEventListener('click', () => {
        const modal = document.getElementById('pendingApprovalsModal');
        if (modal) {
          modal.close();
        }
      });

      // Event listener para tecla Escape no modal
      document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape') {
          const modal = document.getElementById('pendingApprovalsModal');
          if (modal && modal.open) {
            modal.close();
          }
        }
      });

      window.addEventListener('click', (event) => {
        const modal = document.getElementById('pendingApprovalsModal');
        if (event.target === modal) {
          modal.close();
        }
      });

      // Fun√ß√£o para carregar setores dinamicamente do banco
      async function loadSetoresDynamic() {
        console.log('üéØ Carregando setores do banco de dados...');
        
        const select = document.getElementById('userSetorSelect');
        if (!select) {
          console.log('‚ùå Select n√£o encontrado');
          return;
        }
        
        // Mostrar carregando
        select.innerHTML = '<option value="">Carregando setores...</option>';
        
        try {
          // Verificar se supabaseClient est√° dispon√≠vel
          if (!window.supabaseClient && !supabaseClient) {
            console.log('‚ö†Ô∏è SupabaseClient n√£o dispon√≠vel, usando setores fixos');
            loadSetoresSimple();
            return;
          }
          
          const client = window.supabaseClient || supabaseClient;
          const { data: setores, error } = await client
            .from('setores')
            .select('id, nome')
            .order('nome');
            
          if (error) {
            console.error('‚ùå Erro ao carregar setores:', error);
            // Fallback para setores fixos
            loadSetoresSimple();
            return;
          }
          
          console.log('‚úÖ Setores carregados do banco:', setores);
          
          // Limpar e adicionar op√ß√£o padr√£o
          select.innerHTML = '<option value="">Selecione um setor</option>';
          
          if (!setores || setores.length === 0) {
            console.log('‚ö†Ô∏è Nenhum setor encontrado, usando setores fixos');
            loadSetoresSimple();
            return;
          }
          
          // Adicionar setores do banco
          setores.forEach(setor => {
            const option = document.createElement('option');
            option.value = setor.id;
            option.textContent = setor.nome;
            select.appendChild(option);
          });
          
          console.log(`‚úÖ ${setores.length} setores carregados dinamicamente`);
          
        } catch (error) {
          console.error('‚ùå Erro inesperado:', error);
          // Fallback para setores fixos
          loadSetoresSimple();
        }
      }

      // Fun√ß√£o SIMPLES para carregar setores (fallback)
      function loadSetoresSimple() {
        console.log('üéØ Carregando setores - vers√£o simples');
        
        const select = document.getElementById('userSetorSelect');
        if (!select) {
          console.log('‚ùå Select n√£o encontrado');
          return;
        }
        
        // Adicionar op√ß√µes manualmente por enquanto
        select.innerHTML = `
          <option value="">Selecione um setor</option>
          <option value="1">Controladoria</option>
          <option value="2">Financeiro</option>
          <option value="3">Comercial</option>
          <option value="4">Opera√ß√µes</option>
          <option value="5">RH</option>
        `;
        
        console.log('‚úÖ Setores carregados com sucesso');
      }

      // Event Listeners para Modais Administrativos
      
      // Modal de Gerenciamento de Usu√°rios
      document.getElementById('btnCloseUserModal')?.addEventListener('click', () => {
        document.getElementById('userManagementModal').close();
      });
      
      document.getElementById('btnNewUser')?.addEventListener('click', () => {
        console.log('üîò Novo Usu√°rio clicado');
        
        // Mostrar formul√°rio
        document.getElementById('userFormTitle').textContent = 'Novo Usu√°rio';
        document.getElementById('userForm').classList.remove('hidden');
        
        // Limpar campos
        document.getElementById('userEmail').value = '';
        document.getElementById('userNameInput').value = '';
        document.getElementById('userIsAdmin').checked = false;
        document.getElementById('editUserId').value = '';
        
        // Carregar setores dinamicamente
        loadSetoresDynamic();
      });
      
      document.getElementById('btnRefreshUsers')?.addEventListener('click', () => {
        loadUsersForManagement();
        loadSetoresDynamic(); // Vers√£o din√¢mica
      });
      
      document.getElementById('btnCancelUserForm')?.addEventListener('click', hideUserForm);
      
      // Fun√ß√£o para carregar setores no modal de tarefas
      async function loadSetoresInTaskModal() {
        console.log('üéØ Carregando setores para modal de tarefas...');
        
        const select = document.getElementById('inputSetor');
        if (!select) {
          console.log('‚ùå Select de setor no modal n√£o encontrado');
          return;
        }
        
        // Mostrar carregando
        select.innerHTML = '<option value="">Carregando setores...</option>';
        
        try {
          // Verificar se √© admin ou usu√°rio normal
          if (isAdmin) {
            // Admin pode escolher qualquer setor
            const client = window.supabaseClient || supabaseClient;
            const { data: setores, error } = await client
              .from('setores')
              .select('id, nome')
              .order('nome');
              
            if (error || !setores) {
              console.error('‚ùå Erro ao carregar setores:', error);
              select.innerHTML = '<option value="">Erro ao carregar setores</option>';
              return;
            }
            
            // Limpar e adicionar op√ß√£o padr√£o
            select.innerHTML = '<option value="">Selecione um setor</option>';
            
            // Adicionar setores
            setores.forEach(setor => {
              const option = document.createElement('option');
              option.value = setor.id;
              option.textContent = setor.nome;
              select.appendChild(option);
            });
            
            console.log(`‚úÖ ${setores.length} setores carregados para admin`);
          } else {
            // Usu√°rio normal - s√≥ pode criar tarefas no seu setor
            let userSetorId = null;
            let userSetorNome = 'Setor n√£o definido';
            
            // Tentar obter setor de v√°rias formas
            if (currentSetor && currentSetor.id) {
              userSetorId = currentSetor.id;
              userSetorNome = currentSetor.nome;
            } else if (currentUserData && currentUserData.setor_id) {
              userSetorId = currentUserData.setor_id;
              // Buscar nome do setor
              try {
                const client = window.supabaseClient || supabaseClient;
                const { data: setor } = await client
                  .from('setores')
                  .select('nome')
                  .eq('id', currentUserData.setor_id)
                  .single();
                if (setor) userSetorNome = setor.nome;
              } catch (e) {
                console.warn('Erro ao buscar nome do setor:', e);
              }
            }
            
            if (userSetorId) {
              select.innerHTML = `<option value="${userSetorId}">${userSetorNome}</option>`;
              select.value = userSetorId;
              select.disabled = true; // Desabilita para usu√°rios normais
              console.log('‚úÖ Setor fixo para usu√°rio normal:', userSetorNome);
            } else {
              select.innerHTML = '<option value="">Usu√°rio sem setor definido</option>';
              select.disabled = true;
              console.log('‚ùå Usu√°rio sem setor definido');
            }
          }
          
        } catch (error) {
          console.error('‚ùå Erro inesperado ao carregar setores:', error);
          select.innerHTML = '<option value="">Erro ao carregar setores</option>';
        }
      }
      
      document.getElementById('userFormData')?.addEventListener('submit', (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        saveUser(formData);
      });

      // Modal de Gerenciamento de Setores
      document.getElementById('btnCloseSetorModal')?.addEventListener('click', () => {
        document.getElementById('setorManagementModal').close();
      });
      
      document.getElementById('btnNewSetor')?.addEventListener('click', () => {
        showSetorForm('Novo Setor');
      });
      
      document.getElementById('btnRefreshSetores')?.addEventListener('click', loadSetoresForManagement);
      
      document.getElementById('btnCancelSetorForm')?.addEventListener('click', hideSetorForm);
      
      document.getElementById('setorFormData')?.addEventListener('submit', (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        saveSetor(formData);
      });

      // Sincronizar cor picker e input text
      document.getElementById('setorCor')?.addEventListener('input', (e) => {
        document.getElementById('setorCorText').value = e.target.value;
      });
      
      document.getElementById('setorCorText')?.addEventListener('input', (e) => {
        document.getElementById('setorCor').value = e.target.value;
      });

      // Modal de Relat√≥rios Administrativos
      document.getElementById('btnCloseReportsModal')?.addEventListener('click', () => {
        document.getElementById('adminReportsModal').close();
      });
      
      document.getElementById('btnCloseReportsModal2')?.addEventListener('click', () => {
        document.getElementById('adminReportsModal').close();
      });
      
      document.getElementById('btnExportReports')?.addEventListener('click', () => {
        showToast('Funcionalidade de exporta√ß√£o em desenvolvimento', 'info');
      });

      // Event listeners para o modal de confirma√ß√£o de conclus√£o
      document.getElementById('btnCloseConfirmationModal')?.addEventListener('click', () => {
        document.getElementById('confirmationRequestModal').close();
      });
      
      document.getElementById('btnCancelConfirmationRequest')?.addEventListener('click', () => {
        document.getElementById('confirmationRequestModal').close();
      });
      
      // Formul√°rio de solicita√ß√£o de confirma√ß√£o
      document.getElementById('confirmationForm')?.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const taskId = this.dataset.taskId;
        const notes = document.getElementById('confirmationNotes').value.trim();
        
        if (!taskId) {
          alert('Erro: ID da tarefa n√£o encontrado.');
          return;
        }
        
        // Desabilitar bot√£o para evitar cliques duplos
        const submitButton = this.querySelector('button[type="submit"]');
        const originalText = submitButton.textContent;
        submitButton.disabled = true;
        submitButton.textContent = 'Enviando...';
        
        try {
          const success = await handleRequestCompletion(taskId, notes);
          // ‚úÖ SEMPRE reabilitar bot√£o, independente do resultado
          submitButton.disabled = false;
          submitButton.textContent = originalText;
          
          if (success) {
            // Fechar modal apenas se sucesso
            document.getElementById('confirmationRequestModal').close();
          }
        } catch (error) {
          // ‚úÖ Reabilitar bot√£o em caso de erro
          submitButton.disabled = false;
          submitButton.textContent = originalText;
          console.error('Erro ao processar solicita√ß√£o:', error);
          alert('Erro inesperado: ' + error.message);
        }
      });

      // Event listeners para o modal de aprova√ß√£o
      document.getElementById('btnCloseApprovalModal')?.addEventListener('click', () => {
        document.getElementById('approvalModal').close();
      });
      
      document.getElementById('btnCancelApproval')?.addEventListener('click', () => {
        document.getElementById('approvalModal').close();
      });
      
      document.getElementById('btnConfirmApproval')?.addEventListener('click', processApproval);
      
      // Bot√£o para atualizar solicita√ß√µes pendentes
      document.getElementById('refreshPendingRequests')?.addEventListener('click', loadPendingRequests);

      // Listener para mudan√ßas de autentica√ß√£o (comentado para evitar auto-login)
      // supabaseClient.auth.onAuthStateChange((event, session) => {
      //   if (event === 'SIGNED_IN') {
      //     handleUserLogin(session.user);
      //   } else if (event === 'SIGNED_OUT') {
      //     showLoginScreen();
      //   }
      // });

      // Testar conex√£o com Supabase
      supabaseClient.from('tasks').select('count', { count: 'exact', head: true })
        .then(({ count, error }) => {
          if (error) {
            console.error('Erro ao conectar com Supabase:', error);
          } else {
            console.log('Conex√£o com Supabase OK. Total de tarefas:', count);
          }
        });

      // Verificar se a tabela task_attachments existe
      async function checkTaskAttachmentsTable() {
        try {
          const { error } = await supabaseClient.from('task_attachments').select('id').limit(1);
          if (error) {
            console.warn('Tabela task_attachments n√£o existe ou n√£o tem permiss√£o. Para salvar anexos, crie a tabela com o SQL:', `
CREATE TABLE task_attachments (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  task_id UUID REFERENCES tasks(id) ON DELETE CASCADE,
  file_name VARCHAR(255) NOT NULL,
  file_url TEXT NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);`);
            return false;
          }
          console.log('Tabela task_attachments OK');
          return true;
        } catch (error) {
          console.error('Erro ao verificar tabela task_attachments:', error);
          return false;
        }
      }

      // Verificar tabela na inicializa√ß√£o
      checkTaskAttachmentsTable();

      // Buscar tasks do Supabase e exibir no console
      async function fetchTasksSupabase() {
        try {
          console.log('Testando conex√£o inicial com Supabase...');
          const { data, error } = await supabaseClient.from('tasks').select('*');
          if (error) {
            console.error('Erro ao buscar tasks do Supabase:', error);
          } else {
            console.log('Conex√£o inicial com Supabase OK. Tasks encontradas:', data?.length || 0);
          }
        } catch (error) {
          console.error('Erro na conex√£o inicial com Supabase:', error);
        }
      }
      // N√£o executar fetchTasksSupabase automaticamente, aguardar a inicializa√ß√£o completa

      // Fun√ß√µes Supabase para CRUD
      async function supabaseInsertTask(task) {
        try {
          // Monta payload para tasks, removendo attachments
          const { attachments, ...payload } = task;
          
          // Corrige nome do campo de data para Supabase
          if (payload.due) {
            payload.due_date = payload.due;
            delete payload.due;
          }
          
          // Corrige nome do campo createdAt para created_at
          if (payload.createdAt) {
            payload.created_at = payload.createdAt;
            delete payload.createdAt;
          }
          
          // Se n√£o existe created_at, criar agora
          if (!payload.created_at) {
            payload.created_at = new Date().toISOString();
          }
          
          // tags precisa ser array de string
          if (typeof payload.tags === 'string') {
            payload.tags = payload.tags.split(',').map(x=>x.trim()).filter(Boolean);
          }
          
          console.log('Tentando salvar tarefa no Supabase:', payload);
          
          // Log detalhado dos campos para debug
          console.log('Campos sendo enviados:', {
            id: payload.id,
            sequential_id: payload.sequential_id,
            title: payload.title,
            assignee: payload.assignee,
            due_date: payload.due_date,
            priority: payload.priority,
            status: payload.status,
            description: payload.description,
            tags: payload.tags,
            created_at: payload.created_at
          });
          
          const { data, error } = await supabaseClient.from('tasks').upsert([payload], { onConflict: ['id'] });
          if (error) {
            console.error('Erro ao salvar no Supabase:', error);
            console.error('Detalhes do erro:', {
              message: error.message,
              details: error.details,
              hint: error.hint,
              code: error.code
            });
            console.error('Payload que causou o erro:', payload);
            
            // Salvar localmente como fallback
            console.log('Salvando localmente como fallback...');
            await saveTaskLocally(task);
            
            // Mostrar erro mais espec√≠fico
            let errorMessage = 'Erro ao salvar no Supabase';
            if (error.message.includes('column')) {
              errorMessage += ': Problema com estrutura da tabela';
            } else if (error.message.includes('permission')) {
              errorMessage += ': Problema de permiss√£o';
            } else if (error.message.includes('connection')) {
              errorMessage += ': Problema de conex√£o';
            }
            errorMessage += `. Tarefa foi salva localmente. Detalhes: ${error.message}`;
            
            throw new Error(errorMessage);
          } else {
            console.log('Tarefa salva no Supabase com sucesso:', data);
          }
          
          // Salva anexos na tabela task_attachments
          if (Array.isArray(attachments) && attachments.length > 0) {
            console.log(`Salvando ${attachments.length} anexos para tarefa ${payload.id}...`);
            for (const a of attachments) {
              try {
                // Gerar ID √∫nico se n√£o existir
                const attachmentId = a.id || uuidv4();
                
                const attachmentData = {
                  id: attachmentId,
                  task_id: payload.id,
                  file_name: a.name || 'anexo.jpg',
                  file_url: a.dataURL,
                  created_at: new Date().toISOString()
                };
                
                console.log('Salvando anexo:', { id: attachmentId, task_id: payload.id, file_name: a.name });
                
                const { data: attachData, error: attachError } = await supabaseClient
                  .from('task_attachments')
                  .upsert([attachmentData], { onConflict: ['id'] });
                  
                if (attachError) {
                  console.warn('Aviso ao salvar anexo no Supabase:', attachError.message);
                  console.warn('Dados do anexo:', { id: attachmentId, task_id: payload.id, file_name: a.name });
                  // N√£o falha completamente se anexo der erro, mas avisa o usu√°rio
                  if (attachError.message.includes('table') || attachError.message.includes('relation')) {
                    console.warn('Tabela task_attachments pode n√£o estar acess√≠vel. Anexos n√£o ser√£o salvos.');
                  } else if (attachError.message.includes('CORS') || attachError.message.includes('policy')) {
                    console.warn('Problema de CORS ao salvar anexo. Verifique as configura√ß√µes do Supabase.');
                  }
                } else {
                  console.log('Anexo salvo com sucesso:', attachmentId);
                }
              } catch (attachError) {
                console.error('Erro geral ao processar anexo:', attachError, a);
              }
            }
          }
        } catch (error) {
          console.error('Erro geral ao salvar tarefa:', error);
          throw error;
        }
      }
      
      // Fun√ß√£o para salvar tarefa localmente em caso de falha do Supabase
      async function saveTaskLocally(task) {
        try {
          // Encontrar se a tarefa j√° existe
          const index = tasks.findIndex(t => t.id === task.id);
          if (index >= 0) {
            // Atualizar tarefa existente
            tasks[index] = task;
          } else {
            // Adicionar nova tarefa
            tasks.push(task);
          }
          // Salvar no localStorage
          save();
          console.log('Tarefa salva localmente:', task);
        } catch (error) {
          console.error('Erro ao salvar localmente:', error);
        }
      }

      async function supabaseDeleteTask(id) {
        try {
          console.log('Excluindo tarefa:', id);
          const { error } = await supabaseClient.from('tasks').delete().eq('id', id);
          if (error) {
            console.error('Erro ao excluir tarefa no Supabase:', error);
          } else {
            console.log('Tarefa exclu√≠da com sucesso do Supabase');
          }
          
          // Excluir anexos relacionados
          const { error: attachError } = await supabaseClient.from('task_attachments').delete().eq('task_id', id);
          if (attachError) {
            console.error('Erro ao excluir anexos no Supabase:', attachError);
          }
          
          return { error };
        } catch (error) {
          console.error('Erro geral ao excluir tarefa:', error);
          return { error };
        }
      }

      async function supabaseBulkInsertTasks(taskList) {
        for (const t of taskList) {
          await supabaseInsertTask(t);
        }
      }

    // ====== Gerenciamento de Status ======
    const STATUS_STORAGE_KEY = 'taskBoard_status_v1';
    let customStatusList = [];

    // Status padr√£o do sistema
    const defaultStatusMap = {
      'Backlog': 'bg-slate-200 text-slate-800',
      'Em andamento': 'bg-indigo-100 text-indigo-800', 
      'Bloqueado': 'bg-rose-100 text-rose-800',
      'Conclu√≠do': 'bg-emerald-100 text-emerald-800'
    };

    // Carregar status personalizados do localStorage
    function loadCustomStatus() {
      const stored = localStorage.getItem(STATUS_STORAGE_KEY);
      if (stored) {
        try {
          customStatusList = JSON.parse(stored);
        } catch (e) {
          console.error('Erro ao carregar status personalizados:', e);
          customStatusList = [];
        }
      }
    }

    // Salvar status personalizados no localStorage
    function saveCustomStatus() {
      localStorage.setItem(STATUS_STORAGE_KEY, JSON.stringify(customStatusList));
    }

    // Obter todos os status (padr√£o + personalizados)
    function getAllStatus() {
      const statusMap = {...defaultStatusMap};
      customStatusList.forEach(status => {
        statusMap[status.name] = status.color;
      });
      return statusMap;
    }

    // Obter lista de nomes de status
    function getAllStatusNames() {
      return Object.keys(getAllStatus());
    }

    // Fun√ß√£o para atualizar os selects de status
    function updateStatusSelects() {
      const statusNames = getAllStatusNames();
      
      // Atualizar select de filtro
      const filterStatus = document.getElementById('filterStatus');
      const currentFilterValue = filterStatus.value;
      filterStatus.innerHTML = '<option value="">Todos</option>';
      statusNames.forEach(status => {
        const option = document.createElement('option');
        option.value = status;
        option.textContent = status;
        if (status === currentFilterValue) option.selected = true;
        filterStatus.appendChild(option);
      });

      // Atualizar select do formul√°rio
      const inputStatus = document.getElementById('inputStatus');
      const currentInputValue = inputStatus.value;
      inputStatus.innerHTML = '';
      statusNames.forEach(status => {
        const option = document.createElement('option');
        option.value = status;
        option.textContent = status;
        if (status === currentInputValue || (status === 'Em andamento' && !currentInputValue)) {
          option.selected = true;
        }
        inputStatus.appendChild(option);
      });
    }

    // Fun√ß√£o badgeStatus atualizada para usar status personalizados
    function badgeStatusUpdated(s) {
      const statusMap = getAllStatus();
      return `<span class="px-2 py-1 rounded-full text-xs ${statusMap[s]||'bg-slate-100 text-slate-800'}">${s||'-'}</span>`;
    }

    // Adicionar novo status ou salvar edi√ß√£o
    function addNewStatus(name, color) {
      const addButton = document.getElementById('btnAddStatus');
      const editingStatus = addButton.getAttribute('data-editing');
      
      if (editingStatus) {
        // Modo edi√ß√£o
        const success = saveStatusChanges(editingStatus, name, color);
        if (success) {
          cancelEditStatus();
        }
        return success;
      } else {
        // Modo adi√ß√£o
        if (!name || !name.trim()) {
          alert('Nome do status √© obrigat√≥rio');
          return false;
        }

        const trimmedName = name.trim();
        
        // Verificar se j√° existe
        if (getAllStatusNames().includes(trimmedName)) {
          alert('Este status j√° existe');
          return false;
        }

        // Adicionar √† lista
        customStatusList.push({
          name: trimmedName,
          color: color || 'bg-slate-200 text-slate-800'
        });

        saveCustomStatus();
        updateStatusSelects();
        renderStatusList();
        refreshViews();
        
        showStatusMessage(`Status "${trimmedName}" adicionado com sucesso!`, 'success');
        return true;
      }
    }

    // Excluir status personalizado
    function deleteCustomStatus(name) {
      // N√£o permitir exclus√£o de status padr√£o
      if (defaultStatusMap[name]) {
        alert('N√£o √© poss√≠vel excluir status padr√£o do sistema');
        return;
      }

      // Verificar se alguma tarefa usa este status
      const tasksUsingStatus = tasks.filter(task => task.status === name);
      if (tasksUsingStatus.length > 0) {
        if (!confirm(`Existem ${tasksUsingStatus.length} tarefas usando este status. Deseja continuar? As tarefas precisar√£o ter seu status alterado manualmente.`)) {
          return;
        }
      }

      if (confirm(`Tem certeza que deseja excluir o status "${name}"?`)) {
        // Remover da lista
        customStatusList = customStatusList.filter(status => status.name !== name);
        saveCustomStatus();
        updateStatusSelects();
        renderStatusList();
        refreshViews();
        
        // Mostrar mensagem de sucesso
        showStatusMessage(`Status "${name}" exclu√≠do com sucesso!`, 'success');
      }
    }

    // Editar status personalizado
    function editCustomStatus(name) {
      // N√£o permitir edi√ß√£o de status padr√£o
      if (defaultStatusMap[name]) {
        alert('N√£o √© poss√≠vel editar status padr√£o do sistema');
        return;
      }

      // Encontrar o status na lista
      const statusIndex = customStatusList.findIndex(status => status.name === name);
      if (statusIndex === -1) {
        alert('Status n√£o encontrado');
        return;
      }

      const currentStatus = customStatusList[statusIndex];
      
      // Preencher o formul√°rio de edi√ß√£o com os dados atuais
      document.getElementById('newStatusName').value = currentStatus.name;
      document.getElementById('newStatusColor').value = currentStatus.color;
      
      // Alterar o bot√£o para modo edi√ß√£o
      const addButton = document.getElementById('btnAddStatus');
      addButton.textContent = 'Salvar Altera√ß√µes';
      addButton.className = 'px-4 py-2 rounded-xl bg-green-600 text-white hover:bg-green-700 transition';
      
      // Adicionar atributo para identificar que est√° editando
      addButton.setAttribute('data-editing', name);
      
      // Mostrar indicador de modo edi√ß√£o
      document.getElementById('editModeIndicator').classList.remove('hidden');
      
      // Mostrar bot√£o cancelar
      let cancelButton = document.getElementById('btnCancelEdit');
      if (!cancelButton) {
        cancelButton = document.createElement('button');
        cancelButton.id = 'btnCancelEdit';
        cancelButton.type = 'button';
        cancelButton.textContent = 'Cancelar';
        cancelButton.className = 'px-4 py-2 rounded-xl bg-slate-400 text-white hover:bg-slate-500 transition';
        addButton.parentNode.appendChild(cancelButton);
        
        cancelButton.addEventListener('click', cancelEditStatus);
      }
      cancelButton.style.display = 'inline-block';
      
      // Focar no campo nome
      document.getElementById('newStatusName').focus();
    }

    // Cancelar edi√ß√£o de status
    function cancelEditStatus() {
      const addButton = document.getElementById('btnAddStatus');
      const cancelButton = document.getElementById('btnCancelEdit');
      
      // Restaurar estado original do bot√£o
      addButton.textContent = 'Adicionar';
      addButton.className = 'px-4 py-2 rounded-xl bg-purple-600 text-white hover:bg-purple-700 transition';
      addButton.removeAttribute('data-editing');
      
      // Esconder indicador de modo edi√ß√£o
      document.getElementById('editModeIndicator').classList.add('hidden');
      
      // Esconder bot√£o cancelar
      if (cancelButton) {
        cancelButton.style.display = 'none';
      }
      
      // Limpar formul√°rio
      document.getElementById('newStatusName').value = '';
      document.getElementById('newStatusColor').value = 'bg-slate-200 text-slate-800';
    }

    // Fun√ß√£o para salvar altera√ß√µes no status (modifica√ß√£o do addNewStatus)
    function saveStatusChanges(oldName, newName, newColor) {
      if (!newName || !newName.trim()) {
        alert('Nome do status √© obrigat√≥rio');
        return false;
      }

      const trimmedName = newName.trim();
      
      // Se o nome mudou, verificar se j√° existe outro com esse nome
      if (oldName !== trimmedName && getAllStatusNames().includes(trimmedName)) {
        alert('J√° existe um status com este nome');
        return false;
      }

      // Encontrar e atualizar o status
      const statusIndex = customStatusList.findIndex(status => status.name === oldName);
      if (statusIndex !== -1) {
        const oldStatusName = customStatusList[statusIndex].name;
        customStatusList[statusIndex] = {
          name: trimmedName,
          color: newColor || 'bg-slate-200 text-slate-800'
        };

        // Se o nome mudou, atualizar todas as tarefas que usam este status
        if (oldStatusName !== trimmedName) {
          tasks.forEach(task => {
            if (task.status === oldStatusName) {
              task.status = trimmedName;
            }
          });
          
          // Salvar tarefas atualizadas
          save();
          
          // Sincronizar com Supabase se necess√°rio
          supabaseBulkInsertTasks(tasks);
        }

        saveCustomStatus();
        updateStatusSelects();
        renderStatusList();
        refreshViews();
        
        showStatusMessage(`Status "${trimmedName}" atualizado com sucesso!`, 'success');
        return true;
      }
      
      return false;
    }

    // Mostrar mensagem de status
    function showStatusMessage(message, type = 'info') {
      // Remover notifica√ß√£o anterior se existir
      const existingNotification = document.getElementById('statusNotification');
      if (existingNotification) {
        existingNotification.remove();
      }
      
      // Criar nova notifica√ß√£o
      const notification = document.createElement('div');
      notification.id = 'statusNotification';
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: -400px;
        padding: 12px 16px;
        border-radius: 8px;
        color: white;
        font-size: 14px;
        font-weight: 500;
        z-index: 9999;
        transition: right 0.3s ease-in-out;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        max-width: 300px;
        word-wrap: break-word;
        cursor: pointer;
      `;
      
      // Definir cor baseada no tipo
      const colors = {
        success: '#10b981', // Verde
        error: '#ef4444',   // Vermelho
        info: '#3b82f6'     // Azul
      };
      
      // Aplicar cor de fundo
      notification.style.backgroundColor = colors[type] || colors.info;
      
      // Definir √≠cone baseado no tipo
      const icons = {
        success: '‚úì',
        error: '‚ö†',
        info: '‚Ñπ'
      };
      
      notification.innerHTML = `
        <div style="display: flex; align-items: center; justify-content: space-between; gap: 8px;">
          <div style="display: flex; align-items: center; gap: 8px;">
            <span style="font-size: 16px;">${icons[type] || icons.info}</span>
            <span>${message}</span>
          </div>
          <span style="font-size: 18px; opacity: 0.7; line-height: 1;">√ó</span>
        </div>
      `;
      
      // Fun√ß√£o para esconder e remover notifica√ß√£o
      function hideNotification() {
        notification.style.right = '-400px';
        setTimeout(() => {
          if (notification.parentNode) {
            notification.remove();
          }
        }, 300);
      }
      
      // Permitir fechar clicando na notifica√ß√£o
      notification.addEventListener('click', hideNotification);
      
      // Adicionar ao DOM
      document.body.appendChild(notification);
      
      // Mostrar notifica√ß√£o (animar para dentro)
      setTimeout(() => {
        notification.style.right = '20px';
      }, 50);
      
      // Esconder ap√≥s 4 segundos
      setTimeout(hideNotification, 4000);
    }

    // Renderizar lista de status no modal
    function renderStatusList() {
      const statusList = document.getElementById('statusList');
      const allStatus = getAllStatus();
      
      statusList.innerHTML = '';
      
      Object.keys(allStatus).forEach(statusName => {
        const statusColor = allStatus[statusName];
        const isDefault = defaultStatusMap[statusName];
        
        const statusItem = document.createElement('div');
        statusItem.className = 'flex items-center justify-between p-3 bg-white border border-slate-200 rounded-xl';
        
        statusItem.innerHTML = `
          <div class="flex items-center gap-3">
            <span class="px-2 py-1 rounded-full text-xs ${statusColor}">${statusName}</span>
            <span class="text-sm text-slate-600">${isDefault ? '(Padr√£o)' : '(Personalizado)'}</span>
          </div>
          <div class="flex gap-2">
            ${!isDefault ? `
              <button onclick="editCustomStatus('${statusName}')" class="px-3 py-1 text-xs bg-blue-100 text-blue-800 rounded-lg hover:bg-blue-200 transition">Editar</button>
              <button onclick="deleteCustomStatus('${statusName}')" class="px-3 py-1 text-xs bg-red-100 text-red-800 rounded-lg hover:bg-red-200 transition">Excluir</button>
            ` : ''}
          </div>
        `;
        
        statusList.appendChild(statusItem);
      });
    }

    // Salvar status personalizados no Supabase
    async function saveStatusToSupabase() {
      try {
        // Primeiro, verificar se a tabela existe e criar se necess√°rio
        const testQuery = await supabaseClient.from('custom_status').select('id').limit(1);
        
        if (testQuery.error && testQuery.error.message.includes('does not exist')) {
          // Tabela n√£o existe, vamos criar atrav√©s de uma inser√ß√£o
          console.log('Tabela custom_status ser√° criada automaticamente');
        }
        
        // Limpar registros existentes de status personalizados
        const { error: deleteError } = await supabaseClient.from('custom_status').delete().gte('id', '00000000-0000-0000-0000-000000000000');
        
        if (deleteError && !deleteError.message.includes('does not exist')) {
          console.warn('Aviso ao limpar status existentes:', deleteError);
        }
        
        // Inserir status personalizados
        if (customStatusList.length > 0) {
          const statusData = customStatusList.map(status => ({
            id: window.crypto ? crypto.randomUUID() : Math.random().toString(36),
            name: status.name,
            color: status.color,
            created_at: new Date().toISOString()
          }));
          
          const { error } = await supabaseClient.from('custom_status').insert(statusData);
          if (error) {
            console.error('Erro ao salvar status no Supabase:', error);
            showStatusMessage('Erro ao salvar status no Supabase. Verifique se a tabela existe.', 'error');
          } else {
            showStatusMessage('Status salvos no Supabase com sucesso!', 'success');
          }
        } else {
          showStatusMessage('Status personalizados removidos do Supabase!', 'success');
        }
      } catch (error) {
        console.error('Erro ao conectar com Supabase:', error);
        showStatusMessage('Erro ao conectar com Supabase: ' + error.message, 'error');
      }
    }

    // Carregar status personalizados do Supabase
    async function loadStatusFromSupabase() {
      try {
        const { data, error } = await supabaseClient.from('custom_status').select('*');
        if (error) {
          // Se a tabela n√£o existir, ser√° criada automaticamente pelo Supabase quando inserirmos dados
          if (error.message.includes('relation "public.custom_status" does not exist')) {
            console.log('Tabela custom_status n√£o existe ainda. Ser√° criada quando necess√°rio.');
          } else {
            console.error('Erro ao carregar status do Supabase:', error);
          }
        } else if (data && data.length > 0) {
          customStatusList = data.map(item => ({
            name: item.name,
            color: item.color
          }));
          saveCustomStatus();
          updateStatusSelects();
        }
      } catch (error) {
        console.error('Erro ao conectar com Supabase para carregar status:', error);
      }
    }

    // ====== State & Persist√™ncia ======
    const STORAGE_KEY = 'taskBoard_v1';
  let tasks = [];
  console.log('Tarefas carregadas ao iniciar:', tasks);
    let editingId = null;
    let anexosTemp = []; // {name, dataURL}

    function uuidv4() {
      if (window.crypto && window.crypto.randomUUID) return window.crypto.randomUUID();
      // Fallback para navegadores antigos
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        var r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }

    // Fun√ß√£o para gerar ID sequencial no formato ID001, ID002, etc.
    function generateSequentialId() {
      const maxId = tasks.reduce((max, task) => {
        if (task.sequential_id) {
          const num = parseInt(task.sequential_id.replace('ID', ''));
          return Math.max(max, num);
        }
        return max;
      }, 0);
      return `ID${String(maxId + 1).padStart(3, '0')}`;
    }
    // Carregar tarefas do Supabase ao iniciar (OTIMIZADO - Query em Lote)
    // Fun√ß√£o wrapper para carregar tarefas (para compatibilidade)
    async function loadTasks() {
      await loadTasksFromSupabase();
      renderTaskBoard(); // Atualizar a visualiza√ß√£o
    }

    async function loadTasksFromSupabase() {
      try {
        console.log('üöÄ Carregando tarefas do Supabase (modo otimizado)...');
        const startTime = Date.now();
        
        // Verifica√ß√µes simples antes de carregar
        if (!supabaseClient) {
          console.log('‚ö†Ô∏è SupabaseClient n√£o dispon√≠vel');
          tasks = [];
          return;
        }
        
        if (!currentUser) {
          console.log('‚ö†Ô∏è Usu√°rio n√£o autenticado');
          tasks = [];
          return;
        }

    // Fun√ß√£o auxiliar para atribuir tarefas a um setor
    async function assignTasksToSector(tasksList, setorId) {
      try {
        console.log(`üîÑ Atribuindo ${tasksList.length} tarefas ao setor ${setorId}...`);
        
        const taskIds = tasksList.map(t => t.id);
        
        const { data, error } = await supabaseClient
          .from('tasks')
          .update({ setor_id: setorId })
          .in('id', taskIds);
          
        if (error) {
          console.error('‚ùå Erro ao atribuir tarefas ao setor:', error);
          alert('Erro ao atribuir tarefas: ' + error.message);
          return false;
        }
        
        console.log('‚úÖ Tarefas atribu√≠das com sucesso!');
        alert(`‚úÖ ${tasksList.length} tarefas foram atribu√≠das ao setor Controladoria!`);
        
        // Recarregar tarefas
        await loadTasksFromSupabase();
        return true;
        
      } catch (error) {
        console.error('‚ùå Erro ao atribuir tarefas:', error);
        alert('Erro inesperado ao atribuir tarefas: ' + error.message);
        return false;
      }
    }
        
        // Construir query base com relacionamento setores e campos de confirma√ß√£o
        let query = supabaseClient.from('tasks').select(`
          *,
          setores(id, nome, cor),
          confirmation_status,
          confirmation_requested_at,
          confirmation_requested_by,
          confirmation_notes,
          confirmation_approved_at,
          confirmation_approved_by,
          admin_notes
        `);
        
        // Aplicar filtros baseados no tipo de usu√°rio
        console.log('üîç Debug antes dos filtros:', {
          isAdmin: isAdmin,
          selectedSetorFilter: selectedSetorFilter,
          currentSetor: currentSetor,
          currentSetor_id: currentSetor?.id,
          currentSetor_nome: currentSetor?.nome,
          currentUserData_setor_id: currentUserData?.setor_id,
          currentUserData_full: currentUserData
        });
        
        if (isAdmin && selectedSetorFilter) {
          // Admin com filtro espec√≠fico
          console.log('üîç Admin filtrando por setor:', selectedSetorFilter);
          query = query.eq('setor_id', selectedSetorFilter);
        } else if (!isAdmin) {
          // Usu√°rio normal - usar setor_id diretamente do campo do usu√°rio
          let userSetorId = null;
          
          // Prioridade: usar setor_id do campo direto do usu√°rio
          if (currentUserData && currentUserData.setor_id) {
            userSetorId = currentUserData.setor_id;
            console.log('‚úÖ Setor obtido de currentUserData.setor_id (campo direto):', userSetorId);
          } else if (currentSetor && currentSetor.id) {
            userSetorId = currentSetor.id;
            console.log('‚úÖ Setor obtido de currentSetor.id (relacionamento):', userSetorId);
          }
          
          if (userSetorId) {
            console.log('üë§ Usu√°rio normal - filtrando tarefas por setor (campo direto):', userSetorId);
            
            // DEBUG TEMPOR√ÅRIO: Vamos ver todas as tarefas primeiro
            console.log('üîç DEBUG: Verificando TODAS as tarefas antes de filtrar...');
            const { data: allTasks, error: allError } = await supabaseClient
              .from('tasks')
              .select('id, title, setor_id, sequential_id')
              .limit(10);
              
            if (!allError && allTasks) {
              console.log(`üìä DEBUG: Encontradas ${allTasks.length} tarefas no total:`);
              allTasks.forEach((task, idx) => {
                const match = task.setor_id === userSetorId ? '‚úÖ MATCH' : '‚ùå NO MATCH';
                console.log(`  ${idx + 1}. ${task.title} - Setor: ${task.setor_id || 'NULL'} ${match}`);
              });
            }
            
            // Usar o setor_id do campo direto do usu√°rio
            query = query.eq('setor_id', userSetorId);
          } else {
            console.warn('‚ö†Ô∏è PROBLEMA: Usu√°rio sem setor definido!');
            console.warn('üìä Debug completo:', {
              currentSetor: currentSetor,
              currentUserData: currentUserData,
              currentUserData_setor_id: currentUserData?.setor_id,
              isAdmin: isAdmin
            });
            // Em vez de carregar tarefas sem setor, mostrar erro
            console.log('‚ùå N√£o foi poss√≠vel determinar o setor do usu√°rio - carregando tarefas vazias');
            tasks = [];
            return;
          }
        }
        // Admin sem filtro v√™ todas as tarefas
        
        // QUERY 1: Carregar tarefas com filtro aplicado
        console.log('üîç Executando query com filtros aplicados...');
        const { data, error } = await query;
        
        console.log('üìä Resultado da query:', {
          data_length: data?.length || 0,
          error: error,
          query_applied: !isAdmin ? 'Filtro por setor aplicado' : 'Admin - sem filtro ou com filtro espec√≠fico'
        });
        
        if (error) {
          console.error('‚ùå Erro ao carregar tarefas do Supabase:', error);
          tasks = [];
          showToast('Erro ao carregar tarefas: ' + error.message, 'error');
          return; // N√£o throw, apenas retornar
        }
        
        tasks = data || [];
        console.log(`‚úÖ ${tasks.length} tarefas carregadas do Supabase`);
        
        if (tasks.length > 0) {
          console.log('üìã Primeiras tarefas carregadas:');
          tasks.slice(0, 5).forEach((task, idx) => {
            console.log(`  ${idx + 1}. ${task.title} (Setor ID: ${task.setor_id || 'NULL'}) (Sequential: ${task.sequential_id})`);
          });
        } else {
          console.warn('‚ö†Ô∏è Nenhuma tarefa encontrada para este usu√°rio/filtro');
          
          // Se √© usu√°rio normal e n√£o encontrou tarefas, vamos verificar se existem tarefas sem setor
          if (!isAdmin) {
            console.log('üîç Verificando se existem tarefas sem setor atribu√≠do...');
            try {
              const { data: tasksWithoutSector, error: errorNoSector } = await supabaseClient
                .from('tasks')
                .select('id, title, setor_id, sequential_id')
                .is('setor_id', null)
                .limit(10);
                
              if (!errorNoSector && tasksWithoutSector && tasksWithoutSector.length > 0) {
                console.log(`üìã Encontradas ${tasksWithoutSector.length} tarefas SEM setor:`);
                tasksWithoutSector.forEach((task, idx) => {
                  console.log(`  ${idx + 1}. ${task.title} (ID: ${task.id})`);
                });
                
                // Oferecer op√ß√£o de atribuir essas tarefas ao setor do usu√°rio
                console.log('üí° SOLU√á√ÉO: Atribuir essas tarefas ao setor Controladoria');
                
                if (confirm(`Foram encontradas ${tasksWithoutSector.length} tarefas sem setor atribu√≠do.\n\nDeseja atribu√≠-las automaticamente ao setor Controladoria?`)) {
                  await assignTasksToSector(tasksWithoutSector, currentSetor.id);
                }
              } else {
                console.log('‚úÖ N√£o h√° tarefas sem setor');
              }
            } catch (err) {
              console.error('Erro ao verificar tarefas sem setor:', err);
            }
          }
        }
        
        // QUERY 2: Carregar TODOS os anexos de uma vez (em lote)
        if (tasks.length > 0) {
          const taskIds = tasks.map(task => task.id);
          console.log(`üîÑ Carregando anexos para ${taskIds.length} tarefas em lote...`);
          
          const { data: allAttachments, error: attachError } = await supabaseClient
            .from('task_attachments')
            .select('id, file_name, file_url, task_id')
            .in('task_id', taskIds);
          
          if (attachError) {
            console.warn('Aviso ao carregar anexos em lote:', attachError);
            // Inicializar anexos vazios para todas as tarefas
            tasks.forEach(task => { task.attachments = []; });
          } else {
            // Organizar anexos por task_id para associa√ß√£o r√°pida
            const attachmentsByTaskId = {};
            
            (allAttachments || []).forEach(attach => {
              // Verificar se file_url √© v√°lida
              const isValidUrl = attach.file_url && (
                attach.file_url.startsWith('data:') || 
                attach.file_url.startsWith('http://') || 
                attach.file_url.startsWith('https://')
              );
              
              if (isValidUrl) {
                if (!attachmentsByTaskId[attach.task_id]) {
                  attachmentsByTaskId[attach.task_id] = [];
                }
                
                attachmentsByTaskId[attach.task_id].push({
                  id: attach.id,
                  name: attach.file_name || 'anexo',
                  dataURL: attach.file_url
                });
              }
            });
            
            // Associar anexos √†s tarefas correspondentes
            let totalAttachments = 0;
            tasks.forEach(task => {
              task.attachments = attachmentsByTaskId[task.id] || [];
              totalAttachments += task.attachments.length;
            });
            
            console.log(`‚úÖ ${totalAttachments} anexos v√°lidos carregados e associados √†s tarefas`);
          }
        } else {
          console.log('üì≠ Nenhuma tarefa encontrada, pulando carregamento de anexos');
        }
        
        // Migrar tarefas existentes sem sequential_id
        await migrateExistingTasks();
        
        const endTime = Date.now();
        const loadTime = ((endTime - startTime) / 1000).toFixed(2);
        console.log(`‚ö° Carregamento conclu√≠do em ${loadTime}s (modo otimizado)`);
        
        // IMPORTANTE: Atualizar a interface ap√≥s carregar as tarefas
        console.log('üîÑ Atualizando interface...');
        refreshAll();
        
      } catch (error) {
        console.error('‚ùå Erro geral ao carregar tarefas:', error);
        tasks = [];
        // Tentar carregar do localStorage como fallback
        const localTasks = localStorage.getItem(STORAGE_KEY);
        if (localTasks) {
          try {
            tasks = JSON.parse(localTasks);
            console.log('üîÑ Tarefas carregadas do localStorage como fallback');
          } catch (e) {
            console.error('Erro ao carregar do localStorage:', e);
          }
        }
      }
    }

    // ====== Sistema de Confirma√ß√£o de Conclus√£o ======
    
    // Fun√ß√£o para abrir modal de solicita√ß√£o de confirma√ß√£o
    function openConfirmationRequest(taskId) {
      const task = tasks.find(t => t.id === taskId);
      if (!task) {
        alert('Tarefa n√£o encontrada!');
        return;
      }
      
      // üö´ Verificar se j√° tem solicita√ß√£o pendente
      if (task.confirmation_status === 'pending') {
        alert('‚ö†Ô∏è Esta tarefa j√° possui uma solicita√ß√£o de conclus√£o pendente!\n\nAguarde a aprova√ß√£o do administrador.');
        return;
      }
      
      const titleElement = document.getElementById('confirmationTaskTitle');
      const descElement = document.getElementById('confirmationTaskDescription');
      const notesElement = document.getElementById('confirmationNotes');
      const formElement = document.getElementById('confirmationForm');
      const modalElement = document.getElementById('confirmationRequestModal');
      
      if (!titleElement || !descElement || !notesElement || !formElement || !modalElement) {
        alert('Erro: Modal n√£o encontrado na p√°gina!');
        return;
      }
      
      // üîÑ Verificar se modal j√° est√° aberto
      if (modalElement.open) {
        console.log('Modal j√° est√° aberto, ignorando...');
        return;
      }
      
      titleElement.textContent = task.title;
      descElement.textContent = task.description || 'Sem descri√ß√£o';
      notesElement.value = '';
      
      // Armazenar o ID da tarefa no formul√°rio
      formElement.dataset.taskId = taskId;
      
      // Abrir modal
      modalElement.showModal();
    }
    
    // Fun√ß√£o para processar a solicita√ß√£o de confirma√ß√£o
    async function handleRequestCompletion(taskId, notes = '') {
      try {
        if (!supabaseClient || !currentUser) {
          alert('Erro: Sistema n√£o inicializado corretamente.');
          return false;
        }
        
        console.log('üìù Enviando solicita√ß√£o de confirma√ß√£o para tarefa:', taskId);
        
        // üîç Verificar se j√° existe solicita√ß√£o pendente
        const { data: existingTask, error: checkError } = await supabaseClient
          .from('tasks')
          .select('confirmation_status, confirmation_requested_by')
          .eq('id', taskId)
          .single();
        
        if (checkError) {
          console.error('‚ùå Erro ao verificar tarefa:', checkError);
          alert('Erro ao verificar tarefa: ' + checkError.message);
          return false;
        }
        
        // üö´ Verificar se j√° tem solicita√ß√£o pendente
        if (existingTask.confirmation_status === 'pending') {
          alert('‚ö†Ô∏è Esta tarefa j√° possui uma solicita√ß√£o de conclus√£o pendente!\n\nAguarde a aprova√ß√£o do administrador.');
          return false;
        }
        
        // Atualizar a tarefa no Supabase com os dados da solicita√ß√£o
        const { data, error } = await supabaseClient
          .from('tasks')
          .update({
            confirmation_status: 'pending',
            confirmation_requested_at: new Date().toISOString(),
            confirmation_requested_by: currentUser.email,
            confirmation_notes: notes
          })
          .eq('id', taskId);
        
        if (error) {
          console.error('‚ùå Erro ao solicitar confirma√ß√£o:', error);
          alert('Erro ao enviar solicita√ß√£o: ' + error.message);
          return false;
        }
        
        // Atualizar a tarefa local tamb√©m
        const taskIndex = tasks.findIndex(t => t.id === taskId);
        if (taskIndex !== -1) {
          tasks[taskIndex].confirmation_status = 'pending';
          tasks[taskIndex].confirmation_requested_at = new Date().toISOString();
          tasks[taskIndex].confirmation_requested_by = currentUser.email;
          tasks[taskIndex].confirmation_notes = notes;
        }
        
        console.log('‚úÖ Solicita√ß√£o de confirma√ß√£o enviada com sucesso!');
        alert('‚úÖ Solicita√ß√£o de confirma√ß√£o enviada!\n\nO administrador ser√° notificado e avaliar√° sua solicita√ß√£o.');
        
        // ‚ö° Atualizar interface de forma otimizada (n√£o fechar modal aqui)
        refreshViews(); // S√≥ atualizar as views, n√£o tudo
        
        return true;
        
      } catch (error) {
        console.error('‚ùå Erro inesperado ao solicitar confirma√ß√£o:', error);
        alert('Erro inesperado: ' + error.message);
        return false;
      }
    }

    // Fun√ß√£o para controlar visibilidade do bot√£o de pend√™ncias
    function updatePendingApprovalsButtonVisibility() {
      const btnPendingApprovals = document.getElementById('btnPendingApprovals');
      
      if (btnPendingApprovals) {
        if (isAdmin) {
          btnPendingApprovals.classList.remove('hidden');
        } else {
          btnPendingApprovals.classList.add('hidden');
        }
      }
    }

    // ====== Sistema de Aprova√ß√£o Administrativa ======
    
    // Fun√ß√£o para carregar solicita√ß√µes pendentes
    async function loadPendingRequests() {
      try {
        if (!supabaseClient) {
          console.error('‚ùå Supabase client n√£o dispon√≠vel');
          return;
        }
        
        if (!isAdmin) {
          return;
        }
        
        const { data, error } = await supabaseClient
          .from('tasks')
          .select(`
            id, title, description, assignee, due_date, status, priority,
            confirmation_status,
            confirmation_requested_at,
            confirmation_requested_by,
            confirmation_notes,
            setores(nome)
          `)
          .eq('confirmation_status', 'pending')
          .order('confirmation_requested_at', { ascending: false });
        
        if (error) {
          console.error('‚ùå Erro ao carregar solicita√ß√µes pendentes:', error);
          return;
        }
        
        if (data && data.length > 0) {
          renderPendingRequests(data);
          renderPendingListModal(data);
        } else {
          renderPendingRequests([]);
          renderPendingListModal([]);
        }
        
        updateNotificationBadge(data?.length || 0);
        
        return data || [];
        
      } catch (error) {
        console.error('‚ùå Erro inesperado ao carregar solicita√ß√µes:', error);
        return [];
      }
    }
    
    // Fun√ß√£o para renderizar lista de solicita√ß√µes pendentes
    function renderPendingRequests(requests) {
      const container = document.getElementById('pendingRequestsContainer');
      const noRequests = document.getElementById('noPendingRequests');
      const countBadge = document.getElementById('pendingRequestsCount');
      
      if (!container) {
        return;
      }
      
      // Atualizar contador
      if (countBadge) {
        if (requests.length > 0) {
          countBadge.textContent = requests.length;
          countBadge.classList.remove('hidden');
        } else {
          countBadge.classList.add('hidden');
        }
      }
      
      if (requests.length === 0) {
        container.innerHTML = '';
        if (noRequests) noRequests.style.display = 'block';
        return;
      }
      
      if (noRequests) noRequests.style.display = 'none';
      
      container.innerHTML = requests.map(request => {
        const requestDate = new Date(request.confirmation_requested_at);
        const timeAgo = getTimeAgo(requestDate);
        
        return `
          <div class="bg-orange-50 border border-orange-200 rounded-lg p-4 hover:bg-orange-100 transition">
            <div class="flex justify-between items-start gap-4">
              <div class="flex-1">
                <div class="flex items-center gap-2 mb-2">
                  <h5 class="font-medium text-gray-800">${request.title}</h5>
                  <span class="text-xs bg-${getPriorityColor(request.priority)}-100 text-${getPriorityColor(request.priority)}-700 px-2 py-1 rounded">${request.priority}</span>
                </div>
                <p class="text-sm text-gray-600 mb-3">${request.description || 'Sem descri√ß√£o'}</p>
                
                <div class="flex flex-wrap gap-4 text-xs text-gray-500 mb-3">
                  <span>üë§ ${request.assignee || 'N√£o atribu√≠do'}</span>
                  <span>üìÖ ${formatDate(request.due_date)}</span>
                  <span>üè¢ ${request.setores?.nome || 'Sem setor'}</span>
                </div>
                
                <div class="bg-white p-3 rounded border text-sm">
                  <div class="flex items-center gap-2 text-xs text-orange-600 mb-1">
                    <span>üë§ ${request.confirmation_requested_by}</span>
                    <span>‚Ä¢</span>
                    <span>üïí ${timeAgo}</span>
                  </div>
                  <p class="text-gray-700 italic">"${request.confirmation_notes || 'Sem observa√ß√µes'}"</p>
                </div>
              </div>
              
              <div class="flex flex-col gap-2">
                <button 
                  onclick="openApprovalModal('${request.id}')" 
                  class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition text-sm font-medium"
                >
                  ‚öñÔ∏è Avaliar
                </button>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }
    
    // Fun√ß√£o para renderizar pend√™ncias no modal dedicado
    function renderPendingListModal(requests) {
      const container = document.getElementById('pendingListContainer');
      const noMessage = document.getElementById('noPendingMessage');
      const countBadge = document.getElementById('pendingModalCount');
      
      if (!container) {
        console.error('‚ùå Container pendingListContainer n√£o encontrado!');
        return;
      }
      
      // Atualizar contador
      if (countBadge) {
        if (requests.length > 0) {
          countBadge.textContent = requests.length;
          countBadge.classList.remove('hidden');
        } else {
          countBadge.classList.add('hidden');
        }
      }
      
      if (requests.length === 0) {
        container.innerHTML = '';
        if (noMessage) noMessage.style.display = 'block';
        return;
      }
      
      if (noMessage) noMessage.style.display = 'none';
      
      container.innerHTML = requests.map(request => {
        const requestDate = new Date(request.confirmation_requested_at);
        const timeAgo = getTimeAgo(requestDate);
        
        return `
          <div class="bg-white border border-orange-200 rounded-lg p-6 hover:shadow-md transition">
            <div class="flex justify-between items-start gap-6">
              <div class="flex-1">
                <!-- Cabe√ßalho da tarefa -->
                <div class="flex items-center gap-3 mb-3">
                  <h4 class="text-lg font-semibold text-gray-800">${request.title}</h4>
                  <span class="text-xs bg-${getPriorityColor(request.priority)}-100 text-${getPriorityColor(request.priority)}-700 px-2 py-1 rounded font-medium">${request.priority || 'M√©dia'}</span>
                  <span class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded font-medium">${request.status}</span>
                </div>
                
                <!-- Descri√ß√£o da tarefa -->
                <p class="text-gray-600 mb-4">${request.description || 'Sem descri√ß√£o detalhada'}</p>
                
                <!-- Informa√ß√µes da tarefa -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm text-gray-600 mb-4">
                  <div class="flex items-center gap-1">
                    <span>üë§</span>
                    <span><strong>Respons√°vel:</strong> ${request.assignee || 'N√£o atribu√≠do'}</span>
                  </div>
                  <div class="flex items-center gap-1">
                    <span>üìÖ</span>
                    <span><strong>Prazo:</strong> ${formatDate(request.due_date)}</span>
                  </div>
                  <div class="flex items-center gap-1">
                    <span>üè¢</span>
                    <span><strong>Setor:</strong> ${request.setores?.nome || 'Sem setor'}</span>
                  </div>
                  <div class="flex items-center gap-1">
                    <span>üïí</span>
                    <span><strong>Solicitado:</strong> ${timeAgo}</span>
                  </div>
                </div>
                
                <!-- Solicita√ß√£o do usu√°rio -->
                <div class="bg-orange-50 border border-orange-200 rounded-lg p-4">
                  <div class="flex items-center gap-2 text-orange-700 mb-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                      <path d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                    </svg>
                    <span class="font-medium">${request.confirmation_requested_by}</span>
                    <span class="text-xs text-orange-600">‚Ä¢ ${timeAgo}</span>
                  </div>
                  <div class="text-gray-700">
                    <p class="text-sm font-medium mb-1">üí¨ Observa√ß√µes do usu√°rio:</p>
                    <p class="text-sm italic">"${request.confirmation_notes || 'Nenhuma observa√ß√£o fornecida pelo usu√°rio'}"</p>
                  </div>
                </div>
              </div>
              
              <!-- A√ß√£o -->
              <div class="flex flex-col items-end gap-2">
                <button 
                  onclick="openApprovalModal('${request.id}')" 
                  class="flex items-center gap-2 px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-medium shadow-sm"
                >
                  ‚öñÔ∏è Avaliar Solicita√ß√£o
                </button>
                <span class="text-xs text-gray-500 text-center">
                  Aprovar ou Rejeitar
                </span>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }
    
    // Fun√ß√£o para abrir modal de aprova√ß√£o
    async function openApprovalModal(taskId) {
      try {
        console.log('üîç Abrindo modal de aprova√ß√£o para tarefa:', taskId);
        
        // Buscar dados completos da tarefa
        const { data, error } = await supabaseClient
          .from('tasks')
          .select(`
            id, title, description, assignee, due_date, status, priority,
            confirmation_status, confirmation_requested_at, confirmation_requested_by, 
            confirmation_notes, setores(nome)
          `)
          .eq('id', taskId)
          .single();
        
        if (error || !data) {
          console.error('‚ùå Erro ao carregar dados da tarefa:', error);
          alert('Erro ao carregar dados da tarefa!');
          return;
        }
        
        // Preencher modal com dados da tarefa
        document.getElementById('approvalTaskTitle').textContent = data.title;
        document.getElementById('approvalTaskDescription').textContent = data.description || 'Sem descri√ß√£o';
        document.getElementById('approvalTaskAssignee').textContent = data.assignee || 'N√£o atribu√≠do';
        document.getElementById('approvalTaskDue').textContent = formatDate(data.due_date);
        document.getElementById('approvalTaskStatus').textContent = data.status;
        
        // Preencher dados da solicita√ß√£o
        document.getElementById('approvalRequestedBy').textContent = data.confirmation_requested_by;
        document.getElementById('approvalRequestedAt').textContent = formatDate(data.confirmation_requested_at);
        document.getElementById('approvalUserNotes').textContent = data.confirmation_notes || 'Nenhuma observa√ß√£o fornecida';
        
        // Limpar formul√°rio
        document.querySelectorAll('input[name="approvalDecision"]').forEach(radio => radio.checked = false);
        document.getElementById('adminNotes').value = '';
        
        // Armazenar ID da tarefa no modal
        document.getElementById('approvalModal').dataset.taskId = taskId;
        
        // Abrir modal
        document.getElementById('approvalModal').showModal();
        
      } catch (error) {
        console.error('‚ùå Erro inesperado:', error);
        alert('Erro inesperado: ' + error.message);
      }
    }
    
    // Fun√ß√£o para processar aprova√ß√£o/rejei√ß√£o
    async function processApproval() {
      try {
        const modal = document.getElementById('approvalModal');
        const taskId = modal.dataset.taskId;
        
        if (!taskId) {
          alert('Erro: ID da tarefa n√£o encontrado.');
          return;
        }
        
        // Verificar se uma decis√£o foi selecionada
        const decision = document.querySelector('input[name="approvalDecision"]:checked')?.value;
        if (!decision) {
          alert('Por favor, selecione uma decis√£o (Aprovar ou Rejeitar).');
          return;
        }
        
        const adminNotes = document.getElementById('adminNotes').value.trim();
        const isApproved = decision === 'approve';
        
        console.log(`üìù Processando ${isApproved ? 'aprova√ß√£o' : 'rejei√ß√£o'} da tarefa:`, taskId);
        
        // Dados para atualizar
        const updateData = {
          confirmation_status: isApproved ? 'approved' : 'rejected',
          confirmation_approved_at: new Date().toISOString(),
          confirmation_approved_by: currentUser.email,
          admin_notes: adminNotes
        };
        
        // Se aprovado, marcar tarefa como conclu√≠da
        if (isApproved) {
          updateData.status = 'Conclu√≠do';
        }
        
        // Atualizar no Supabase
        const { error } = await supabaseClient
          .from('tasks')
          .update(updateData)
          .eq('id', taskId);
        
        if (error) {
          console.error('‚ùå Erro ao processar aprova√ß√£o:', error);
          alert('Erro ao processar: ' + error.message);
          return;
        }
        
        const action = isApproved ? 'aprovada' : 'rejeitada';
        console.log(`‚úÖ Solicita√ß√£o ${action} com sucesso!`);
        alert(`‚úÖ Solicita√ß√£o ${action} com sucesso!`);
        
        // Fechar modal e atualizar listas
        modal.close();
        await loadPendingRequests();
        await loadTasksFromSupabase();
        refreshAll();
        
      } catch (error) {
        console.error('‚ùå Erro inesperado ao processar aprova√ß√£o:', error);
        alert('Erro inesperado: ' + error.message);
      }
    }
    
    // Fun√ß√£o para atualizar badge de notifica√ß√£o
    function updateNotificationBadge(count) {
      // Badge no novo bot√£o de pend√™ncias
      const pendingBadge = document.getElementById('pendingBadge');
      
      if (pendingBadge) {
        if (count > 0) {
          pendingBadge.textContent = count;
          pendingBadge.classList.remove('hidden');
        } else {
          pendingBadge.classList.add('hidden');
        }
      }
    }

    // ====== Fun√ß√µes Utilit√°rias para Aprova√ß√µes ======
    
    function getTimeAgo(date) {
      const now = new Date();
      const diffMs = now - date;
      const diffMinutes = Math.floor(diffMs / (1000 * 60));
      const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
      const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
      
      if (diffMinutes < 60) {
        return `${diffMinutes} min atr√°s`;
      } else if (diffHours < 24) {
        return `${diffHours}h atr√°s`;
      } else {
        return `${diffDays} dias atr√°s`;
      }
    }
    
    function getPriorityColor(priority) {
      switch (priority) {
        case 'Alta': return 'red';
        case 'M√©dia': return 'yellow';
        case 'Baixa': return 'green';
        default: return 'gray';
      }
    }

    // Fun√ß√£o para migrar tarefas existentes e atribuir IDs sequenciais
    async function migrateExistingTasks() {
      let needsUpdate = false;
      let counter = 1;
      
      for (let task of tasks) {
        if (!task.sequential_id) {
          task.sequential_id = `ID${String(counter).padStart(3, '0')}`;
          needsUpdate = true;
          counter++;
          
          // Atualizar no Supabase
          const { error } = await supabaseClient
            .from('tasks')
            .update({ sequential_id: task.sequential_id })
            .eq('id', task.id);
            
          if (error) {
            console.error('Erro ao migrar tarefa:', error);
          }
        } else {
          // Se j√° tem sequential_id, extrair o n√∫mero para continuar a sequ√™ncia
          const num = parseInt(task.sequential_id.replace('ID', ''));
          if (num >= counter) {
            counter = num + 1;
          }
        }
      }
      
      if (needsUpdate) {
        console.log('Migra√ß√£o de IDs sequenciais conclu√≠da');
      }
    }
    function save() { localStorage.setItem(STORAGE_KEY, JSON.stringify(tasks)); }
  console.log('Tarefas salvas:', tasks);

    // ====== Utilit√°rios ======
    function formatDate(iso) {
      if (!iso) return '-';
      const d = new Date(iso + 'T00:00:00');
      return d.toLocaleDateString('pt-BR');
    }
    function daysDiffFromToday(iso) {
      if (!iso) return null;
      const d1 = new Date(); d1.setHours(0,0,0,0);
      const d2 = new Date(iso + 'T00:00:00');
      return Math.round((d2 - d1) / (1000*60*60*24));
    }
    function badgePriority(p) {
      const map = { 'Baixa':'bg-emerald-100 text-emerald-800', 'M√©dia':'bg-sky-100 text-sky-800', 'Alta':'bg-amber-100 text-amber-800', 'Cr√≠tica':'bg-rose-100 text-rose-800' };
      return `<span class="px-2 py-1 rounded-full text-xs ${map[p]||'bg-slate-100 text-slate-800'}">${p||'-'}</span>`;
    }
    function badgeStatus(s) {
      const statusMap = getAllStatus();
      return `<span class="px-2 py-1 rounded-full text-xs ${statusMap[s]||'bg-slate-100 text-slate-800'}">${s||'-'}</span>`;
    }

    // ====== Dashboard (KPIs & Charts) ======
    const kpi = {
      render() {
        const total = tasks.length;
        const done = tasks.filter(t=>t.status==='Conclu√≠do').length;
        const doing = tasks.filter(t=>t.status==='Em andamento').length;
        const blocked = tasks.filter(t=>t.status==='Bloqueado').length;
        const backlog = tasks.filter(t=>t.status==='Backlog').length;
        const overdue = tasks.filter(t=> t.due_date && daysDiffFromToday(t.due_date) < 0 && t.status !== 'Conclu√≠do').length;
        const soon = tasks.filter(t=> t.due_date && daysDiffFromToday(t.due_date) >= 0 && daysDiffFromToday(t.due_date) <= 7 && t.status!=='Conclu√≠do').length;
        const pct = total? Math.round((done/total)*100):0;
        const cards = [
          {label:'Total', val: total, icon:`<svg width='22' height='22' fill='none' stroke='currentColor' stroke-width='2' viewBox='0 0 24 24'><circle cx='12' cy='12' r='10'/></svg>`, color:'bg-white'},
          {label:'Conclu√≠das', val: done, icon:`<svg width='22' height='22' fill='none' stroke='currentColor' stroke-width='2' viewBox='0 0 24 24'><path d='M5 13l4 4L19 7'/></svg>`, color:'bg-white'},
          {label:'Em andamento', val: doing, icon:`<svg width='22' height='22' fill='none' stroke='currentColor' stroke-width='2' viewBox='0 0 24 24'><circle cx='12' cy='12' r='10'/><path d='M12 6v6l4 2'/></svg>`, color:'bg-white'},
          {label:'Bloqueadas', val: blocked, icon:`<svg width='22' height='22' fill='none' stroke='currentColor' stroke-width='2' viewBox='0 0 24 24'><rect x='3' y='11' width='18' height='7' rx='2'/><path d='M7 11V7a5 5 0 0 1 10 0v4'/></svg>`, color:'bg-white'},
          {label:'Backlog', val: backlog, icon:`<svg width='22' height='22' fill='none' stroke='currentColor' stroke-width='2' viewBox='0 0 24 24'><rect x='3' y='7' width='18' height='13' rx='2'/><path d='M16 3v4M8 3v4'/></svg>`, color:'bg-white'},
          {label:'Vencidas', val: overdue, icon:`<svg width='22' height='22' fill='none' stroke='currentColor' stroke-width='2' viewBox='0 0 24 24'><circle cx='12' cy='12' r='10'/><path d='M12 8v4l3 3'/></svg>`, color:'bg-white'},
        ];
        const el = document.getElementById('kpiCards');
        el.innerHTML = '';
        cards.forEach((c) => {
          const div = document.createElement('div');
          div.className = `${c.color} rounded-2xl shadow p-4 flex flex-col gap-2 items-start`;
          div.innerHTML = `
            <div class="flex items-center gap-2">
              <span class="inline-flex items-center justify-center rounded-full bg-white/80 p-1">${c.icon}</span>
              <span class="text-xs font-medium text-slate-500">${c.label}</span>
            </div>
            <div class="text-2xl font-bold text-slate-800">${c.val}</div>
          `;
          el.appendChild(div);
        });
        // Extra: porcentagem conclu√≠da
        const extra = document.createElement('div');
        extra.className = 'col-span-2 lg:col-span-2 flex flex-col md:flex-row items-center justify-between gap-2 bg-white dark:bg-slate-900 rounded-2xl shadow-sm p-4 border border-slate-100 dark:border-slate-800';
        extra.innerHTML = `
          <div>
            <div class="text-sm text-slate-500 dark:text-slate-400">% Conclu√≠do</div>
            <div class="text-2xl font-bold text-emerald-600 dark:text-emerald-400">${pct}%</div>
            <div class="text-xs text-slate-500 dark:text-slate-400">${soon} atividades com prazo nos pr√≥ximos 7 dias</div>
          </div>
          <div class="flex-1 ml-4 h-3 bg-slate-100 dark:bg-slate-800 rounded-full overflow-hidden">
            <div class="h-full bg-emerald-500 dark:bg-emerald-600 transition-all duration-200" style="width:${pct}%"></div>
          </div>`;
        extra.setAttribute('tabindex','0');
        extra.setAttribute('role','region');
        extra.setAttribute('aria-label','Porcentagem conclu√≠da');
        el.appendChild(extra);
      }
    };

    let statusChart, priorityChart;
    function refreshCharts() {
      const byStatus = ['Backlog','Em andamento','Bloqueado','Conclu√≠do'].map(s=> tasks.filter(t=>t.status===s).length);
      const byPriority = ['Baixa','M√©dia','Alta','Cr√≠tica'].map(p=> tasks.filter(t=>t.priority===p).length);

      const ctx1 = document.getElementById('statusChart');
      if (statusChart) statusChart.destroy();
      // UI: Cores din√¢micas Chart.js via CSS
      const cs = getComputedStyle(document.documentElement);
      const chartColors = {
        bg: cs.getPropertyValue('--chart-bg').trim(),
        fg: cs.getPropertyValue('--chart-fg').trim(),
        emerald: cs.getPropertyValue('--chart-emerald').trim(),
        sky: cs.getPropertyValue('--chart-sky').trim(),
        amber: cs.getPropertyValue('--chart-amber').trim(),
        rose: cs.getPropertyValue('--chart-rose').trim(),
        slate: cs.getPropertyValue('--chart-slate').trim(),
      };
      statusChart = new Chart(ctx1, {
        type: 'bar',
        data: {
          labels: ['Backlog','Em andamento','Bloqueado','Conclu√≠do'],
          datasets: [{
            label: 'Qtde',
            data: byStatus,
            backgroundColor: [
              '#00C853', // Verde vivo
              '#FFD600', // Amarelo vivo
              '#2962FF', // Azul vivo
              '#D50000'  // Vermelho vivo
            ],
            borderRadius: 6,
            borderSkipped: false
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: chartColors.bg,
              titleColor: chartColors.fg,
              bodyColor: chartColors.fg,
              borderColor: chartColors.slate,
              borderWidth: 1
            },
            datalabels: { display: false }
          },
          animation: false,
          layout: { padding: 0 },
          scales: {
            x: {
              beginAtZero: true,
              grid: { color: chartColors.slate+"22" },
              ticks: { color: chartColors.fg }
            },
            y: {
              beginAtZero: true,
              max: Math.max(...byStatus, 5),
              grid: { color: chartColors.slate+"22" },
              ticks: { color: chartColors.fg }
            }
          }
        },
        plugins: []
      });

      const ctx2 = document.getElementById('priorityChart');
      if (priorityChart) priorityChart.destroy();
      priorityChart = new Chart(ctx2, {
        type: 'doughnut',
        data: {
          labels: ['Baixa','M√©dia','Alta','Cr√≠tica'],
          datasets: [{
            data: byPriority,
            backgroundColor: [
              '#00C853', // Verde vivo
              '#FFD600', // Amarelo vivo
              '#2962FF', // Azul vivo
              '#D50000'  // Vermelho vivo
            ],
            borderColor: chartColors.bg,
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                color: chartColors.fg,
                font: { size: 13, family: 'inherit' }
              }
            },
            tooltip: {
              backgroundColor: chartColors.bg,
              titleColor: chartColors.fg,
              bodyColor: chartColors.fg,
              borderColor: chartColors.slate,
              borderWidth: 1
            },
            datalabels: { display: false }
          },
          animation: false,
          layout: { padding: 0 }
        },
        plugins: []
      });
    }

    // ====== Render Lista ======
    function applyFilters(list) {
      const q = document.getElementById('search').value.toLowerCase().trim();
      const tagsOnly = document.getElementById('searchTagsOnly').checked;
      const fs = document.getElementById('filterStatus').value;
      const fp = document.getElementById('filterPriority').value;
      const fa = document.getElementById('filterAssignee').value.toLowerCase().trim();
      return list.filter(t=>{
        let condQ;
        if (tagsOnly) {
          condQ = q ? (t.tags||[]).some(tag => tag.toLowerCase().includes(q)) : true;
        } else {
          // Incluir sequential_id na busca
          const text = [t.title, t.assignee, (t.tags||[]).join(','), t.description, t.sequential_id].join(' ').toLowerCase();
          condQ = q ? text.includes(q) : true;
        }
        const condS = fs? t.status===fs: true;
        const condP = fp? t.priority===fp: true;
        const condA = fa? (t.assignee||'').toLowerCase().includes(fa): true;
        return condQ && condS && condP && condA;
      });
    }

    function renderList() {
      console.log('üé® renderList() chamada - Total de tarefas dispon√≠veis:', tasks.length);
      let list = applyFilters(tasks);
      console.log('üé® Ap√≥s aplicar filtros, tarefas para exibir:', list.length);
      
      // Ordena√ß√£o hier√°rquica: Prioridade de Status + Urg√™ncia por Prazo
      list = list.slice().sort((a, b) => {
        // N√çVEL 1: Prioridade por Status
        const priorityStatuses = ['Backlog', 'Em andamento'];
        const aPriority = priorityStatuses.includes(a.status);
        const bPriority = priorityStatuses.includes(b.status);
        
        // Se um tem prioridade de status e outro n√£o
        if (aPriority && !bPriority) return -1; // a vem primeiro
        if (!aPriority && bPriority) return 1;  // b vem primeiro
        
        // N√çVEL 2: Se ambos t√™m a mesma prioridade de status, ordena por prazo
        // Dentro do mesmo grupo de prioridade, mant√©m ordena√ß√£o por urg√™ncia
        const pa = a.due_date || a.due;
        const pb = b.due_date || b.due;
        
        if (!pa && !pb) return 0;
        if (!pa) return 1;  // tarefas sem prazo v√£o para o final do grupo
        if (!pb) return -1; // tarefas sem prazo v√£o para o final do grupo
        return new Date(pa) - new Date(pb); // mais pr√≥ximo primeiro
      });
      const tbody = document.getElementById('taskTable');
      tbody.innerHTML = '';
      document.getElementById('emptyList').classList.toggle('hidden', list.length!==0);
      list.forEach((t, idx) => {
        const tr = document.createElement('tr');
        // Zebra: linhas pares com leve fundo
        tr.className = 'hover:bg-slate-100' + (idx % 2 === 1 ? ' bg-slate-50' : '');
        const prazo = t.due_date || t.due;
        const overdue = prazo && daysDiffFromToday(prazo) < 0 && t.status !== 'Conclu√≠do';
        const thumbCount = (t.attachments||[]).length;
        let soon = false;
        let soonText = '';
        if (prazo && !overdue) {
          const diff = daysDiffFromToday(prazo);
          if (diff >= 0 && diff <= 7) {
            soon = true;
            soonText = `<div class='flex justify-center'><span class='inline-block mt-1 px-2 py-0.5 rounded bg-black text-red-500 font-bold text-xs'>D-${diff}</span></div>`;
          }
        }
        tr.innerHTML = `
          <td class="px-4 py-3 font-mono text-sm font-semibold text-slate-600">${t.sequential_id || '-'}</td>
          <td class="px-4 py-3">
            <div class="font-medium">${t.title}</div>
            <div class="text-xs text-slate-500">${t.description? t.description.slice(0,80)+(t.description.length>80?'‚Ä¶':''):'-'}</div>
          </td>
          <td class="px-4 py-3">${t.assignee||'-'}</td>
          <td class="px-4 py-3 ${overdue?'text-rose-600 font-semibold':''}">
            ${formatDate(prazo)}
            ${soonText}
          </td>
          <td class="px-4 py-3">${badgePriority(t.priority)}</td>
          <td class="px-4 py-3">${badgeStatus(t.status)}</td>
          <td class="px-4 py-3">${(t.tags||[]).map(x=>`<span class='text-xs bg-slate-100 rounded px-2 py-0.5 mr-1'>${x}</span>`).join('')}</td>
          <td class="px-4 py-3">${thumbCount>0? thumbCount+' img':''}</td>
          <td class="px-4 py-3 text-right">
            <div class="flex justify-end gap-2">
              <button class="px-3 py-1 rounded-xl bg-slate-200" data-act="view" data-id="${t.id}">Ver</button>
              ${isAdmin ? `<button class="px-3 py-1 rounded-xl bg-amber-200" data-act="edit" data-id="${t.id}">Editar</button>` : ''}
              ${!isAdmin && t.status !== 'Conclu√≠do' && t.confirmation_status !== 'pending' ? `<button class="px-3 py-1 rounded-xl bg-green-200" data-act="requestCompletion" data-id="${t.id}">Solicitar Conclus√£o</button>` : ''}
              ${t.confirmation_status === 'pending' ? `<span class="px-3 py-1 rounded-xl bg-yellow-200 text-yellow-800 text-sm">‚è≥ Aprova√ß√£o Pendente</span>` : ''}
              ${isAdmin ? `<button class="px-3 py-1 rounded-xl bg-rose-200" data-act="del" data-id="${t.id}">Excluir</button>` : ''}
            </div>
          </td>`;
        tbody.appendChild(tr);
      });
    }

    // ====== Render Kanban ======
    const columns = ['Backlog','Em andamento','Bloqueado','Conclu√≠do'];
    function renderKanban() {
      const container = document.getElementById('viewKanban');
      container.innerHTML='';
      // Cores e √≠cones para colunas
      const colMeta = {
        'Backlog':   { color: 'bg-slate-50', icon: `<svg width='18' height='18' fill='none' stroke='currentColor' stroke-width='2' viewBox='0 0 24 24'><rect x='3' y='7' width='18' height='13' rx='2'/><path d='M16 3v4M8 3v4'/></svg>` },
        'Em andamento': { color: 'bg-sky-50', icon: `<svg width='18' height='18' fill='none' stroke='currentColor' stroke-width='2' viewBox='0 0 24 24'><circle cx='12' cy='12' r='10'/><path d='M12 6v6l4 2'/></svg>` },
        'Bloqueado': { color: 'bg-rose-50', icon: `<svg width='18' height='18' fill='none' stroke='currentColor' stroke-width='2' viewBox='0 0 24 24'><rect x='3' y='11' width='18' height='7' rx='2'/><path d='M7 11V7a5 5 0 0 1 10 0v4'/></svg>` },
        'Conclu√≠do': { color: 'bg-emerald-50', icon: `<svg width='18' height='18' fill='none' stroke='currentColor' stroke-width='2' viewBox='0 0 24 24'><path d='M5 13l4 4L19 7'/></svg>` },
      };
      columns.forEach(col => {
        const colDiv = document.createElement('div');
        colDiv.className = `${colMeta[col].color} rounded-2xl shadow-sm p-3 flex flex-col min-h-[260px]`;
        // Contagem de cards na coluna
        const count = applyFilters(tasks).filter(t => t.status === col).length;
        colDiv.innerHTML = `
          <div class='flex items-center gap-2 mb-2 sticky top-0 z-10'>
            <span class='inline-flex items-center justify-center rounded-full bg-white p-1 border border-slate-200'>${colMeta[col].icon}</span>
            <span class='font-semibold text-black'>${col}</span>
            <span class='ml-auto text-xs font-bold bg-slate-100 text-black rounded-full px-2 py-0.5'>${count}</span>
          </div>
          <div class='space-y-3 overflow-auto' style='min-height:200px; max-height:60vh' data-col='${col}'></div>`;
        container.appendChild(colDiv);
      });

      const list = applyFilters(tasks);
      list.forEach(t => {
        const card = document.createElement('div');
        card.className = 'rounded-xl border border-slate-200 p-3 bg-white shadow-sm flex flex-col gap-2 text-black';
        const prazo = t.due_date || t.due;
        const overdue = prazo && daysDiffFromToday(prazo) < 0 && t.status !== 'Conclu√≠do';
        const soon = prazo && daysDiffFromToday(prazo) >= 0 && daysDiffFromToday(prazo) <= 7 && t.status !== 'Conclu√≠do';
        // Chip de prazo
        let prazoChip = '';
        if (overdue) prazoChip = `<span class='ml-2 inline-block px-2 py-0.5 rounded-full text-xs font-semibold bg-rose-50 text-rose-700 border border-rose-100' aria-label='Vencida'>Vencida</span>`;
        else if (soon) prazoChip = `<span class='ml-2 inline-block px-2 py-0.5 rounded-full text-xs font-semibold bg-amber-50 text-amber-700 border border-amber-100' aria-label='D-${daysDiffFromToday(prazo)}'>D-${daysDiffFromToday(prazo)}</span>`;
        else if (prazo && daysDiffFromToday(prazo) === 0) prazoChip = `<span class='ml-2 inline-block px-2 py-0.5 rounded-full text-xs font-semibold bg-sky-50 text-sky-700 border border-sky-100' aria-label='Hoje'>Hoje</span>`;
        const imgs = (t.attachments||[]).slice(0,2).map(a=>`<img src='${a.dataURL}' alt='Miniatura do anexo da tarefa ${t.title}' class='h-8 w-8 object-cover rounded-lg border border-slate-200' loading='lazy'/>`).join('');
        card.innerHTML = `
          <div class='flex items-start justify-between gap-2'>
            <div class='flex-1 min-w-0'>
              <div class='flex items-center gap-2 mb-1'>
                <span class='text-xs font-mono bg-slate-200 px-2 py-0.5 rounded text-slate-600'>${t.sequential_id || '-'}</span>
              </div>
              <div class='font-medium text-black truncate'>${t.title}</div>
              <div class='text-xs text-slate-700 truncate'>${t.assignee||'-'} ‚Ä¢ ${formatDate(prazo)}${prazoChip}</div>
            </div>
            <div class='text-xs'>${badgePriority(t.priority)}</div>
          </div>
          <div class='flex flex-wrap items-center gap-2 mt-1'>${(t.tags||[]).map(x=>`<span class='text-xs font-medium bg-slate-100 border border-slate-200 rounded px-2 py-0.5 mr-1'>${x}</span>`).join('')}${imgs}</div>
          <div class='flex justify-end gap-2 mt-2'>
            <button class='px-2 py-1 rounded-xl bg-slate-200 text-xs' data-act='view' data-id='${t.id}' aria-label='Ver detalhes'><svg width='14' height='14' fill='none' stroke='currentColor' stroke-width='2' viewBox='0 0 24 24'><circle cx='12' cy='12' r='10'/><circle cx='12' cy='12' r='4'/></svg></button>
            ${!isAdmin && t.status !== 'Conclu√≠do' && t.confirmation_status !== 'pending' ? `<button class='px-2 py-1 rounded-xl bg-green-200 text-xs' data-act='requestCompletion' data-id='${t.id}' aria-label='Solicitar Conclus√£o'><svg width='14' height='14' fill='none' stroke='currentColor' stroke-width='2' viewBox='0 0 24 24'><polyline points='20 6 9 17 4 12'/></svg></button>` : ''}
            ${t.confirmation_status === 'pending' ? `<span class='px-2 py-1 rounded-xl bg-yellow-200 text-yellow-800 text-xs' title='Aguardando aprova√ß√£o'>‚è≥</span>` : ''}
            ${isAdmin ? `<button class='px-2 py-1 rounded-xl bg-amber-200 text-xs' data-act='edit' data-id='${t.id}' aria-label='Editar'><svg width='14' height='14' fill='none' stroke='currentColor' stroke-width='2' viewBox='0 0 24 24'><path d='M12 20h9'/><path d='M16.5 3.5a2.121 2.121 0 1 1 3 3L7 19l-4 1 1-4 12.5-12.5z'/></svg></button>` : ''}
            ${isAdmin ? `<button class='px-2 py-1 rounded-xl bg-rose-200 text-xs' data-act='del' data-id='${t.id}' aria-label='Excluir'><svg width='14' height='14' fill='none' stroke='currentColor' stroke-width='2' viewBox='0 0 24 24'><path d='M3 6h18M8 6v12a2 2 0 0 0 2 2h4a2 2 0 0 0 2-2V6'/></svg></button>` : ''}
          </div>`;
        container.querySelector(`[data-col='${t.status}']`).appendChild(card);
      });
    }

    // ====== Modais ======
    const modal = document.getElementById('taskModal');
    const form = document.getElementById('taskForm');
    const detailModal = document.getElementById('detailModal');

    // Verificar se elementos essenciais existem
    if (!modal || !form) {
      console.error('Elementos essenciais n√£o encontrados:', { modal, form });
      alert('Erro: Elementos da interface n√£o foram carregados corretamente. Recarregue a p√°gina.');
    }

    document.getElementById('btnNew').addEventListener('click', ()=>{
      console.log('Abrindo modal para nova tarefa...');
      editingId = null; anexosTemp = []; renderThumbs();
      form.reset();
      document.getElementById('modalTitle').textContent = 'Nova Atividade';
      loadSetoresInTaskModal(); // Carregar setores quando abrir o modal
      modal.showModal();
    });
    document.getElementById('btnCloseModal').addEventListener('click', ()=> modal.close());

    // ====== Anexos ======
    function renderThumbs() {
  const wrap = document.getElementById('thumbs');
  wrap.innerHTML = '';
  anexosTemp.forEach((a,idx)=>{
    const d = document.createElement('div');
    d.className = 'relative group';
    d.innerHTML = `
      <img src='${a.dataURL}' class='h-20 w-20 object-cover rounded-xl border cursor-pointer hover:shadow-lg transition' 
           onclick='openImageModal("${a.dataURL}", "${a.name}")' title='Clique para visualizar ${a.name}'/>
      <button type='button' class='absolute -top-2 -right-2 bg-rose-600 text-white rounded-full h-6 w-6 text-xs hover:bg-rose-700 transition' data-rm='${idx}' title='Remover imagem'>√ó</button>
      <div class='absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-20 rounded-xl transition-all flex items-center justify-center pointer-events-none'>
        <span class='text-white text-xs opacity-0 group-hover:opacity-100 transition-opacity'>üëÅÔ∏è</span>
      </div>`;
    wrap.appendChild(d);
  });
}

    // Event listeners para anexos
    const dropArea = document.getElementById('dropArea');
    const imageInput = document.getElementById('imageInput');
    
    // Drag and drop
    ;['dragenter','dragover'].forEach(evt=> dropArea.addEventListener(evt, (e)=>{ e.preventDefault(); dropArea.classList.add('dragover'); }));
    ;['dragleave','drop'].forEach(evt=> dropArea.addEventListener(evt, (e)=>{ e.preventDefault(); dropArea.classList.remove('dragover'); }));
    dropArea.addEventListener('drop', async (e)=>{
      console.log('Drop event triggered');
      
      // Verificar se o drop foi sobre o label do input (evitar duplica√ß√£o)
      if (e.target.closest('label') && e.target.closest('label').querySelector('#imageInput')) {
        console.log('Drop ignorado - foi sobre o label do input');
        return;
      }
      
      const files = [...e.dataTransfer.files].filter(f=> f.type.startsWith('image/'));
      console.log(`Processando ${files.length} arquivos de imagem`);
      
      for (const f of files) {
        // Verificar tamanho do arquivo (limitar a 5MB)
        if (f.size > 5 * 1024 * 1024) {
          alert(`Arquivo ${f.name} √© muito grande (${(f.size / 1024 / 1024).toFixed(1)}MB). Limite: 5MB`);
          continue;
        }
        
        try {
          console.log(`Processando arquivo: ${f.name}`);
          const dataURL = await fileToDataURL(f);
          // Verificar se o dataURL n√£o √© muito grande (aproximadamente)
          if (dataURL.length > 6 * 1024 * 1024) { // ~4.5MB ap√≥s base64
            alert(`Imagem ${f.name} √© muito grande ap√≥s convers√£o. Tente reduzir a qualidade ou tamanho.`);
            continue;
          }
          
          const newAttachment = { 
            id: uuidv4(), 
            name: f.name, 
            dataURL: dataURL
          };
          console.log(`Adicionando anexo:`, newAttachment.id, newAttachment.name);
          anexosTemp.push(newAttachment);
        } catch (error) {
          console.error('Erro ao processar arquivo:', f.name, error);
          alert(`Erro ao processar arquivo ${f.name}`);
        }
      }
      console.log(`Total de anexos agora: ${anexosTemp.length}`);
      renderThumbs();
    });

    function fileToDataURL(file) {
      return new Promise((res, rej)=>{
        const fr = new FileReader();
        fr.onload = ()=> res(fr.result);
        fr.onerror = (error) => {
          console.error('Erro ao ler arquivo:', error);
          rej(error);
        };
        fr.readAsDataURL(file);
      });
    }

    document.getElementById('btnClearAnexos').addEventListener('click', ()=>{ anexosTemp = []; renderThumbs(); });

    // Event listener para remover anexos individuais
    document.getElementById('thumbs').addEventListener('click', (e) => {
      const rmBtn = e.target.closest('button[data-rm]');
      if (rmBtn) {
        const idx = parseInt(rmBtn.getAttribute('data-rm'));
        if (!isNaN(idx) && idx >= 0 && idx < anexosTemp.length) {
          anexosTemp.splice(idx, 1);
          renderThumbs();
        }
      }
    });

    // Event listener para input file (sele√ß√£o manual de arquivos)
    document.getElementById('imageInput').addEventListener('change', async (e) => {
      console.log('Input file change event triggered');
      const files = [...e.target.files].filter(f => f.type.startsWith('image/'));
      console.log(`Processando ${files.length} arquivos de imagem via input`);
      
      for (const f of files) {
        // Verificar tamanho do arquivo (limitar a 5MB)
        if (f.size > 5 * 1024 * 1024) {
          alert(`Arquivo ${f.name} √© muito grande (${(f.size / 1024 / 1024).toFixed(1)}MB). Limite: 5MB`);
          continue;
        }
        
        try {
          console.log(`Processando arquivo via input: ${f.name}`);
          const dataURL = await fileToDataURL(f);
          // Verificar se o dataURL n√£o √© muito grande
          if (dataURL.length > 6 * 1024 * 1024) {
            alert(`Imagem ${f.name} √© muito grande ap√≥s convers√£o. Tente reduzir a qualidade ou tamanho.`);
            continue;
          }
          
          const newAttachment = {
            id: uuidv4(),
            name: f.name,
            dataURL: dataURL
          };
          console.log(`Adicionando anexo via input:`, newAttachment.id, newAttachment.name);
          anexosTemp.push(newAttachment);
        } catch (error) {
          console.error('Erro ao processar arquivo:', f.name, error);
          alert(`Erro ao processar arquivo ${f.name}`);
        }
      }
      console.log(`Total de anexos agora: ${anexosTemp.length}`);
      renderThumbs();
      e.target.value = ''; // Limpar input para permitir selecionar o mesmo arquivo novamente
    });

    // ====== Salvar / Editar ======
    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      
      try {
        // Valida√ß√£o b√°sica
        const title = form.querySelector('#inputTitle').value.trim();
        if (!title) {
          alert('O t√≠tulo √© obrigat√≥rio!');
          form.querySelector('#inputTitle').focus();
          return;
        }
        
        // Mostrar loading
        const submitButton = form.querySelector('button[type="submit"]');
        const originalText = submitButton.textContent;
        submitButton.textContent = 'Salvando...';
        submitButton.disabled = true;
        
        const fd = new FormData(form);
        const data = Object.fromEntries(fd.entries());
        const tags = (data.tags||'').split(',').map(x=>x.trim()).filter(Boolean);
        
        if (editingId) {
          const idx = tasks.findIndex(t=>t.id===editingId);
          if (idx === -1) {
            throw new Error('Tarefa para edi√ß√£o n√£o encontrada');
          }
          
          // Obter setor_id do formul√°rio
          const setorId = form.querySelector('#inputSetor').value;
          
          // Validar setor para usu√°rios n√£o-admin
          if (!isAdmin && (!setorId || setorId !== currentSetor?.id)) {
            alert('Erro: Setor inv√°lido para este usu√°rio!');
            return;
          }
          
          let editTask = { ...tasks[idx], ...data, tags, attachments: [...anexosTemp] };
          // Adicionar setor_id atualizado
          editTask.setor_id = setorId || null;
          
          // Corrige nome do campo de data para Supabase
          if (editTask.due) {
            editTask.due_date = editTask.due;
            delete editTask.due;
          }
          // Corrige nome do campo createdAt para created_at
          if (editTask.createdAt && !editTask.created_at) {
            editTask.created_at = editTask.createdAt;
            delete editTask.createdAt;
          }
          // Remove anexos antigos do Supabase antes de salvar novos
          await supabaseClient.from('task_attachments').delete().eq('task_id', editTask.id);
          await supabaseInsertTask(editTask);
        } else {
          const sequentialId = generateSequentialId();
          
          // Obter setor_id do formul√°rio
          const setorId = form.querySelector('#inputSetor').value;
          
          // Validar setor para usu√°rios n√£o-admin
          if (!isAdmin && (!setorId || setorId !== currentSetor?.id)) {
            alert('Erro: Setor inv√°lido para este usu√°rio!');
            return;
          }
          
          const nova = { 
            id: uuidv4(), 
            sequential_id: sequentialId,
            title: data.title, 
            assignee: data.assignee||'', 
            due: data.due||'', 
            priority: data.priority||'M√©dia', 
            status: data.status||'Backlog', 
            description: data.description||'', 
            setor_id: setorId || null, // Adicionar setor_id
            tags, 
            attachments: [...anexosTemp], 
            created_at: new Date().toISOString() 
          };
          await supabaseInsertTask(nova);
        }
        
        modal.close();
        await loadTasksFromSupabase();
        await refreshAll();
        
        // Reset form
        form.reset();
        anexosTemp = [];
        renderThumbs();
        editingId = null;
        
        // Restaurar bot√£o
        submitButton.textContent = originalText;
        submitButton.disabled = false;
        
        // Mostrar mensagem de sucesso
        const attachmentCount = anexosTemp.length;
        
        const successMessage = editingId ? 
          `Tarefa atualizada com sucesso!${attachmentCount > 0 ? ` ${attachmentCount} anexo(s) salvos.` : ''}` :
          `Tarefa criada com sucesso!${attachmentCount > 0 ? ` ${attachmentCount} anexo(s) salvos.` : ''}`;
        
        console.log(successMessage);
        
        // Opcionalmente mostrar alerta para o usu√°rio
        // alert(successMessage);
        
      } catch (error) {
        console.error('Erro ao salvar tarefa:', error);
        alert(`Erro ao salvar a tarefa: ${error.message || error}`);
        
        // Restaurar bot√£o em caso de erro
        const submitButton = form.querySelector('button[type="submit"]');
        submitButton.textContent = 'Salvar';
        submitButton.disabled = false;
      }
    });

    // ====== A√ß√µes da Lista/Kanban ======
    const taskTable = document.getElementById('taskTable');
    const viewKanban = document.getElementById('viewKanban');
    
    if (taskTable) {
      taskTable.addEventListener('click', onActionClick);
    } else {
      console.error('Elemento taskTable n√£o encontrado');
    }
    
    if (viewKanban) {
      viewKanban.addEventListener('click', onActionClick);
    } else {
      console.error('Elemento viewKanban n√£o encontrado');
    }

    async function onActionClick(e) {
      try {
        const btn = e.target.closest('button');
        if (!btn) return;
        
        const act = btn.getAttribute('data-act');
        const id = btn.getAttribute('data-id');
        
        if (!act || !id) {
          console.warn('A√ß√£o ou ID n√£o encontrado no bot√£o:', { act, id });
          return;
        }
        
        const t = tasks.find(x=>x.id===id);
        if (!t) {
          console.warn('Tarefa n√£o encontrada:', id);
          return;
        }
        if (act==='del') {
            if (confirm('Excluir esta atividade?')) {
              try {
                console.log('Iniciando exclus√£o da tarefa:', id);
                const result = await supabaseDeleteTask(id);
                
                if (result && result.error) {
                  console.warn('Erro no Supabase, removendo tarefa localmente como fallback');
                  // Remover localmente como fallback
                  const taskIndex = tasks.findIndex(task => task.id === id);
                  if (taskIndex > -1) {
                    tasks.splice(taskIndex, 1);
                    save();
                    await refreshAll();
                    alert('Tarefa removida localmente. Pode haver inconsist√™ncia com o servidor.');
                  } else {
                    alert('Erro ao excluir no Supabase e tarefa n√£o encontrada localmente!');
                  }
                  return;
                }
                
                console.log('Tarefa exclu√≠da com sucesso, atualizando interface...');
                await loadTasksFromSupabase();
                await refreshAll();
                console.log('Interface atualizada ap√≥s exclus√£o');
                
              } catch (error) {
                console.error('Erro inesperado ao excluir tarefa:', error);
                alert('Erro inesperado ao excluir a atividade. Tente novamente.');
              }
            }
        }
        if (act==='edit') { openEdit(t); }
        if (act==='view') { openDetail(t); }
        if (act==='requestCompletion') { 
          openConfirmationRequest(id); 
        }
      } catch (error) {
        console.error('Erro geral no onActionClick:', error);
      }
    }

    function openEdit(t) {
      editingId = t.id;
      anexosTemp = [...(t.attachments||[])];
      renderThumbs();
      form.title.value = t.title || '';
      form.assignee.value = t.assignee || '';
      form.due.value = t.due_date || t.due || '';
      form.priority.value = t.priority || 'M√©dia';
      form.status.value = t.status || 'Backlog';
      form.description.value = t.description || '';
      form.tags.value = (t.tags||[]).join(', ');
      
      // Carregar setores e definir o valor da tarefa atual
      loadSetoresInTaskModal().then(() => {
        const setorSelect = document.getElementById('inputSetor');
        if (setorSelect && t.setor_id) {
          setorSelect.value = t.setor_id;
        }
      });
      
      document.getElementById('modalTitle').textContent = 'Editar Atividade';
      modal.showModal();
    }

    function openDetail(t) {
      // Armazenar refer√™ncia da tarefa atual para uso nos event listeners
      window.currentDetailTask = t;
      
      const body = document.getElementById('detailBody');
      body.innerHTML = `
        <div class='flex items-center gap-2 mb-3'>
          <span class='text-slate-500'>ID:</span>
          <span class='text-xs font-mono bg-slate-200 px-2 py-1 rounded text-slate-600'>${t.sequential_id || '-'}</span>
        </div>
        <div><span class='text-slate-500'>T√≠tulo:</span> <span class='font-medium'>${t.title}</span></div>
        <div class='grid grid-cols-2 gap-2'>
          <div><span class='text-slate-500'>Respons√°vel:</span> ${t.assignee||'-'}</div>
          <div><span class='text-slate-500'>Prazo:</span> ${formatDate(t.due_date || t.due)}</div>
          <div><span class='text-slate-500'>Prioridade:</span> ${badgePriority(t.priority)}</div>
          <div><span class='text-slate-500'>Status:</span> ${badgeStatus(t.status)}</div>
        </div>
        <div><span class='text-slate-500'>Descri√ß√£o:</span><div class='mt-1'>${t.description||'-'}</div></div>
        <div><span class='text-slate-500'>Tags:</span> ${(t.tags||[]).map(x=>`<span class='text-xs bg-slate-100 rounded px-2 py-0.5 mr-1'>${x}</span>`).join('') || '-'}</div>
        <div>
          <span class='text-slate-500'>Anexos:</span>
          <div class='mt-2 flex flex-wrap gap-2' id='detailAttachments'>
            ${(t.attachments||[]).map((a, idx)=>{
              // Verificar se √© uma URL v√°lida ou data URL
              const isDataUrl = a.dataURL && a.dataURL.startsWith('data:');
              const imgSrc = isDataUrl ? a.dataURL : '#';
              const imgAlt = `Anexo: ${a.name || 'imagem'}`;
              
              if (isDataUrl) {
                return `<div class='relative group'>
                  <img src='${a.dataURL}' 
                       class='h-24 w-24 object-cover rounded-xl border hover:shadow-lg transition cursor-pointer attachment-img' 
                       alt='${imgAlt}' 
                       loading='lazy' 
                       data-filename='${a.name}' 
                       data-index='${idx}'
                       title='Clique para visualizar ${a.name}'/>
                  <div class='absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-20 rounded-xl transition-all flex items-center justify-center pointer-events-none'>
                    <span class='text-white text-xs opacity-0 group-hover:opacity-100 transition-opacity'>üëÅÔ∏è</span>
                  </div>
                </div>`;
              } else {
                return `<div class='h-24 w-24 bg-slate-100 rounded-xl border flex items-center justify-center text-xs text-slate-500 text-center' title='${a.name}'>
                  <span>üìé<br/>${a.name}</span>
                </div>`;
              }
            }).join('') || '<span class="text-slate-400">Nenhum anexo</span>'}
          </div>
        </div>`;
      detailModal.showModal();
      
      // Adicionar event listeners para as imagens de anexo no modal de detalhes
      const attachmentImgs = detailModal.querySelectorAll('.attachment-img');
      attachmentImgs.forEach(img => {
        img.addEventListener('click', function() {
          const index = parseInt(this.getAttribute('data-index'));
          const task = window.currentDetailTask;
          
          if (task && task.attachments && task.attachments[index]) {
            const attachment = task.attachments[index];
            openImageModal(attachment.dataURL, attachment.name);
          } else {
            // Fallback: usar dados do pr√≥prio elemento
            const dataURL = this.src;
            const fileName = this.getAttribute('data-filename') || 'Imagem';
            openImageModal(dataURL, fileName);
          }
        });
      });
    }

    document.getElementById('btnCloseDetail').addEventListener('click', ()=> {
      detailModal.close();
      window.currentDetailTask = null;
    });
    document.getElementById('btnCloseDetail2').addEventListener('click', ()=> {
      detailModal.close();
      window.currentDetailTask = null;
    });

    // ====== Modal de Visualiza√ß√£o de Imagem ======
    const imageModal = document.getElementById('imageModal');
    let currentImageData = null;

    function openImageModal(dataURL, fileName) {
      const img = document.getElementById('imageModalImg');
      const title = document.getElementById('imageModalTitle');
      
      img.src = dataURL;
      img.alt = fileName || 'Imagem';
      title.textContent = fileName || 'Visualizar Imagem';
      currentImageData = { dataURL, fileName };
      
      imageModal.showModal();
    }

    document.getElementById('btnCloseImage').addEventListener('click', ()=> {
      imageModal.close();
      currentImageData = null;
    });

    document.getElementById('btnDownloadImage').addEventListener('click', ()=> {
      if (currentImageData) {
        const link = document.createElement('a');
        link.href = currentImageData.dataURL;
        link.download = currentImageData.fileName || 'imagem.jpg';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }
    });

    document.getElementById('btnOpenImageNewTab').addEventListener('click', ()=> {
      if (currentImageData) {
        try {
          // Verificar se √© uma data URL v√°lida
          if (!currentImageData.dataURL.startsWith('data:image/')) {
            alert('Formato de imagem inv√°lido.');
            return;
          }
          
          // Extrair dados da imagem
          const parts = currentImageData.dataURL.split(',');
          if (parts.length !== 2) {
            alert('Dados da imagem corrompidos.');
            return;
          }
          
          const header = parts[0]; // data:image/jpeg;base64
          const data = parts[1];   // dados base64
          
          // Extrair tipo MIME
          const mimeMatch = header.match(/data:([^;]+)/);
          const mimeType = mimeMatch ? mimeMatch[1] : 'image/jpeg';
          
          // Converter base64 para Blob
          const byteCharacters = atob(data);
          const byteNumbers = new Array(byteCharacters.length);
          for (let i = 0; i < byteCharacters.length; i++) {
            byteNumbers[i] = byteCharacters.charCodeAt(i);
          }
          const byteArray = new Uint8Array(byteNumbers);
          const blob = new Blob([byteArray], { type: mimeType });
          const blobUrl = URL.createObjectURL(blob);
          
          // Tentar abrir em nova aba
          const newWindow = window.open('', '_blank');
          if (newWindow) {
            newWindow.document.write(`
              <!DOCTYPE html>
              <html>
                <head>
                  <title>${currentImageData.fileName || 'Imagem'}</title>
                  <meta charset="UTF-8">
                  <meta name="viewport" content="width=device-width, initial-scale=1.0">
                  <style>
                    body { 
                      margin: 0; 
                      background: #f8fafc; 
                      display: flex; 
                      justify-content: center; 
                      align-items: center; 
                      min-height: 100vh; 
                      font-family: system-ui, -apple-system, sans-serif;
                      padding: 20px;
                      box-sizing: border-box;
                    }
                    .container {
                      text-align: center;
                      background: white;
                      border-radius: 12px;
                      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
                      padding: 24px;
                      max-width: 100%;
                      max-height: 100%;
                    }
                    h1 {
                      color: #334155;
                      margin: 0 0 20px 0;
                      font-size: 1.5rem;
                      font-weight: 600;
                    }
                    img { 
                      max-width: 100%; 
                      max-height: calc(100vh - 140px); 
                      object-fit: contain;
                      border-radius: 8px;
                      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                    }
                    .info {
                      margin-top: 16px;
                      color: #64748b;
                      font-size: 0.9rem;
                    }
                  </style>
                </head>
                <body>
                  <div class="container">
                    <h1>${currentImageData.fileName || 'Visualizar Imagem'}</h1>
                    <img src="${blobUrl}" alt="${currentImageData.fileName || 'Imagem'}" />
                    <div class="info">Clique com o bot√£o direito para salvar a imagem</div>
                  </div>
                </body>
              </html>
            `);
            newWindow.document.close();
            
            // Limpar a URL ap√≥s 30 segundos
            setTimeout(() => URL.revokeObjectURL(blobUrl), 30000);
          } else {
            alert('Popup bloqueado. Permita popups para este site ou use o bot√£o "Baixar Imagem".');
          }
        } catch (error) {
          console.error('Erro ao abrir imagem em nova aba:', error);
          alert('Erro ao processar imagem. Use o bot√£o "Baixar Imagem" como alternativa.');
        }
      }
    });

    // Fechar modal ao clicar fora da √°rea do conte√∫do
    imageModal.addEventListener('click', (e) => {
      if (e.target === imageModal || e.target.classList.contains('modal-backdrop')) {
        imageModal.close();
        currentImageData = null;
      }
    });

    // Adicionar funcionalidade de teclado (ESC para fechar)
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && imageModal.open) {
        imageModal.close();
        currentImageData = null;
      }
    });

    // Tornar fun√ß√£o global para uso no HTML
    window.openImageModal = openImageModal;

    // ====== Filtros & Tabs ======
    ['search','filterStatus','filterPriority','filterAssignee'].forEach(id=> document.getElementById(id).addEventListener('input', refreshViews));
  document.getElementById('tabList').addEventListener('click', ()=> switchTab('list'));
  document.getElementById('tabKanban').addEventListener('click', ()=> switchTab('kanban'));
    function switchTab(which) {
      document.getElementById('viewList').classList.toggle('hidden', which!=='list');
      document.getElementById('viewKanban').classList.toggle('hidden', which!=='kanban');
      refreshViews();
    }

    // ====== Import/Export/Reset ======
    document.getElementById('btnExport').addEventListener('click', ()=>{
      const blob = new Blob([JSON.stringify(tasks, null, 2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `atividades_${new Date().toISOString().slice(0,10)}.json`;
      a.click();
      URL.revokeObjectURL(a.href);
    });

    document.getElementById('inputImport').addEventListener('change', async (e)=>{
      const file = e.target.files[0]; if (!file) return;
      const text = await file.text();
      let importOk = false;
      try {
        const data = JSON.parse(text);
        if (Array.isArray(data)) {
          // Garante que cada atividade tenha um id UUID v√°lido e tags/attachments como array
          const importTasks = data.map((t) => {
            let validId = t.id;
            const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;
            if (!validId || !uuidRegex.test(validId)) validId = uuidv4();
            
            // Se n√£o tem sequential_id, gera um novo
            let sequentialId = t.sequential_id;
            if (!sequentialId) {
              sequentialId = generateSequentialId();
            }
            
            return {
              ...t,
              id: validId,
              sequential_id: sequentialId,
              tags: Array.isArray(t.tags) ? t.tags : (typeof t.tags === 'string' ? t.tags.split(',').map(x=>x.trim()).filter(Boolean) : []),
              attachments: Array.isArray(t.attachments) ? t.attachments : []
            };
          });
          await supabaseBulkInsertTasks(importTasks);
          alert('Importado com sucesso!');
          importOk = true;
          await refreshAll();
        } else {
          alert('Arquivo inv√°lido.');
        }
      } catch {
        if (!importOk) alert('JSON inv√°lido.');
      }
      e.target.value = '';
    });

    document.getElementById('btnReset').addEventListener('click', async ()=>{
      if (confirm('Apagar todas as atividades e limpar o armazenamento local?')) {
        const senha = prompt('Digite a senha para confirmar o reset:');
        if (senha === '0000') {
          // Deleta todas as tarefas e anexos do Supabase
          // Buscar todos os ids das tarefas
          const { data: tasksData, error: errGetTasks } = await supabaseClient.from('tasks').select('id');
          const { data: attachData, error: errGetAttach } = await supabaseClient.from('task_attachments').select('id');
          let errTasks = null, errAttach = null;
          if (tasksData && tasksData.length > 0) {
            const ids = tasksData.map(t => t.id);
            const res = await supabaseClient.from('tasks').delete().in('id', ids);
            errTasks = res.error;
          }
          if (attachData && attachData.length > 0) {
            const ids = attachData.map(a => a.id);
            const res = await supabaseClient.from('task_attachments').delete().in('id', ids);
            errAttach = res.error;
          }
          if (errTasks || errAttach) {
            alert('Erro ao deletar dados do Supabase!');
            console.error('Erro ao deletar tasks:', errTasks);
            console.error('Erro ao deletar anexos:', errAttach);
            return;
          }
          tasks = []; save(); refreshAll();
        } else {
          alert('Senha incorreta. Opera√ß√£o cancelada.');
        }
      }
    });

    // ====== Event Listeners do Modal de Status ======
    const statusModal = document.getElementById('statusModal');
    
    // Abrir modal de status
    document.getElementById('btnManageStatus').addEventListener('click', ()=>{
      renderStatusList();
      statusModal.showModal();
    });
    
    // Fechar modal de status
    document.getElementById('btnCloseStatusModal').addEventListener('click', ()=> statusModal.close());
    document.getElementById('btnCloseStatusModal2').addEventListener('click', ()=> statusModal.close());
    
    // Adicionar novo status
    document.getElementById('btnAddStatus').addEventListener('click', ()=>{
      const name = document.getElementById('newStatusName').value;
      const color = document.getElementById('newStatusColor').value;
      
      if (addNewStatus(name, color)) {
        document.getElementById('newStatusName').value = '';
        document.getElementById('newStatusColor').value = 'bg-slate-200 text-slate-800';
        refreshViews();
      }
    });
    
    // Salvar status no Supabase
    document.getElementById('btnSaveStatusToSupabase').addEventListener('click', saveStatusToSupabase);
    
    // Permitir adicionar status com Enter
    document.getElementById('newStatusName').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        document.getElementById('btnAddStatus').click();
      }
    });
    
    // Tornar fun√ß√µes globais para uso no HTML
    window.deleteCustomStatus = deleteCustomStatus;
    window.editCustomStatus = editCustomStatus;

    // ====== Refresh geral ======
    function refreshViews() {
      renderList();
      renderKanban();
    }
    
    // Alias para compatibilidade
    const renderTaskBoard = refreshViews;
    
    function refreshAll() {
      kpi.render();
      refreshCharts();
      refreshViews();
      
      // Controlar visibilidade do bot√£o de pend√™ncias
      updatePendingApprovalsButtonVisibility();
      
      // Carregar pend√™ncias se for admin
      if (isAdmin && supabaseClient) {
        loadPendingRequests();
      }
      
      // For√ßa exibir todas as tarefas se tasks estiver vazio
      if (!tasks || tasks.length === 0) {
        document.getElementById('emptyList').classList.remove('hidden');
      } else {
        document.getElementById('emptyList').classList.add('hidden');
      }
    }

    // Inicializar
    // Inicializar
    async function startApp() {
      console.log('Iniciando aplica√ß√£o...');
      document.getElementById('loadingList').classList.remove('hidden');
      document.getElementById('errorList').classList.add('hidden');
      document.getElementById('emptyList').classList.add('hidden');
      try {
        // Verificar se Supabase est√° dispon√≠vel
        if (typeof supabase === 'undefined') {
          throw new Error('Supabase n√£o est√° dispon√≠vel');
        }
        
        // Carregar status personalizados primeiro
        console.log('Carregando status personalizados...');
        loadCustomStatus();
        await loadStatusFromSupabase();
        
        // Carregar tarefas
        console.log('Carregando tarefas...');
        await loadTasksFromSupabase();
        
        // Atualizar selects com status personalizados
        console.log('Atualizando selects...');
        updateStatusSelects();
        
        console.log('Atualizando interface...');
        await refreshAll();
        document.getElementById('loadingList').classList.add('hidden');
        if (!tasks || tasks.length === 0) {
          document.getElementById('emptyList').classList.remove('hidden');
        }
        console.log('Aplica√ß√£o iniciada com sucesso!');
      } catch (e) {
        document.getElementById('loadingList').classList.add('hidden');
        document.getElementById('errorList').classList.remove('hidden');
        console.error('Erro na inicializa√ß√£o:', e);
        alert(`Erro ao inicializar aplica√ß√£o: ${e.message}`);
      }
    }
    
    // Inicializar quando o DOM estiver carregado
    async function initializeApp() {
      try {
        // BYPASS para desenvolvimento (remover depois)
        if (BYPASS_AUTH) {
          console.log('üö® MODO BYPASS ATIVADO - Simulando login como admin');
          
          // Simular dados do admin
          currentUser = {
            email: 'natanjs01@gmail.com',
            user_metadata: { full_name: 'Natanael Bernardo' }
          };
          currentSetor = null; // Admin n√£o tem setor
          isAdmin = true;
          
          // Atualizar visibilidade do bot√£o de pend√™ncias
          updatePendingApprovalsButtonVisibility();
          
          // Debug: Verificar se o modal de confirma√ß√£o existe
          const confirmationModal = document.getElementById('confirmationRequestModal');
          console.log('üîß Modal de confirma√ß√£o encontrado:', !!confirmationModal);
          
          // Bot√£o tempor√°rio para debug de pend√™ncias
          setTimeout(() => {
            const debugButton = document.createElement('button');
            debugButton.textContent = 'DEBUG: Carregar Pend√™ncias';
            debugButton.style.cssText = 'position: fixed; top: 50px; right: 10px; z-index: 9999; background: purple; color: white; padding: 10px; font-size: 12px;';
            debugButton.onclick = async () => {
              console.log('üîß Debug: For√ßando carregamento de pend√™ncias...');
              await loadPendingRequests();
            };
            document.body.appendChild(debugButton);
            
            // Bot√£o para criar solicita√ß√£o fake (apenas para teste)
            const fakeButton = document.createElement('button');
            fakeButton.textContent = 'TESTE: Criar Solicita√ß√£o Fake';
            fakeButton.style.cssText = 'position: fixed; top: 90px; right: 10px; z-index: 9999; background: orange; color: white; padding: 10px; font-size: 12px;';
            fakeButton.onclick = async () => {
              console.log('üîß Criando solicita√ß√£o fake...');
              if (tasks.length > 0) {
                const firstTask = tasks[0];
                const { error } = await supabaseClient
                  .from('tasks')
                  .update({
                    confirmation_status: 'pending',
                    confirmation_requested_at: new Date().toISOString(),
                    confirmation_requested_by: 'teste@exemplo.com',
                    confirmation_notes: 'Solicita√ß√£o de teste criada pelo debug'
                  })
                  .eq('id', firstTask.id);
                
                if (error) {
                  console.error('Erro ao criar solicita√ß√£o fake:', error);
                  alert('Erro: ' + error.message);
                } else {
                  console.log('‚úÖ Solicita√ß√£o fake criada!');
                  alert('Solicita√ß√£o fake criada! Agora clique em "DEBUG: Carregar Pend√™ncias"');
                }
              } else {
                alert('Nenhuma tarefa dispon√≠vel para teste');
              }
            };
            document.body.appendChild(fakeButton);
          }, 2000);
          
          showApp();
          startApp();
          updateUserInterface();
          
          // For√ßar carregamento de pend√™ncias para admin
          setTimeout(async () => {
            console.log('üöÄ Carregamento autom√°tico de pend√™ncias para admin...');
            await loadPendingRequests();
          }, 3000);
          
          return;
        }
        
        // Apenas mostrar tela de login - N√ÉO verificar sess√£o automaticamente
        showLoginScreen();
        console.log('Tela de login exibida. Aguardando intera√ß√£o do usu√°rio.');
        
        // S√≥ verificar sess√£o se o usu√°rio fizer uma a√ß√£o
        
      } catch (error) {
        console.error('Erro na inicializa√ß√£o:', error);
        showLoginScreen();
      }
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeApp);
    } else {
      initializeApp();
    }
    // Exportar PDF do Dashboard (restaurado e robusto)
    function setupPDFExportButton() {
      const btnExportPDF = document.getElementById('btnExportPDF');
      if (!btnExportPDF) return;
      btnExportPDF.onclick = function () {
        if (!window.html2pdf) {
          const script = document.createElement('script');
          script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js';
          script.onload = exportDashboardPDF;
          document.body.appendChild(script);
        } else {
          exportDashboardPDF();
        }
      };
    }

    function exportDashboardPDF() {
      // Ativa datalabels s√≥ para exporta√ß√£o
      const originalStatus = { ...statusChart.options.plugins.datalabels };
      const originalPriority = { ...priorityChart.options.plugins.datalabels };
      statusChart.options.plugins.datalabels = {
        ...originalStatus,
        anchor: 'end',
        align: 'top',
        color: '#0f172a',
        font: { weight: 'bold', size: 14 },
        formatter: function(value) { return value; },
        display: true
      };
      priorityChart.options.plugins.datalabels = {
        ...originalPriority,
        color: '#0f172a',
        font: { weight: 'bold', size: 14 },
        formatter: function(value, ctx) {
          const label = ctx.chart.data.labels[ctx.dataIndex];
          return value > 0 ? label + ': ' + value : '';
        },
        display: true
      };
      statusChart.update();
      priorityChart.update();

      // Monta o dashboard para PDF
      const dashboard = document.createElement('div');
      dashboard.style.background = getComputedStyle(document.body).backgroundColor;
      dashboard.style.color = getComputedStyle(document.body).color;
      dashboard.style.padding = '24px';
      dashboard.className = 'bg-slate-50 text-slate-800';
      // T√≠tulo
      const titulo = document.createElement('h1');
      titulo.textContent = 'Implanta√ß√£o de Controles de Fechamento';
      titulo.style.fontSize = '2rem';
      titulo.style.fontWeight = 'bold';
      titulo.style.marginBottom = '24px';
      dashboard.appendChild(titulo);
      // KPIs
      const kpi = document.getElementById('kpiCards').cloneNode(true);
      dashboard.appendChild(kpi);
      // Charts: copiar os t√≠tulos e os CANVAS renderizados
      const chartsSection = document.createElement('section');
      chartsSection.className = 'grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6';
      // Status das Atividades
      const chart1Div = document.createElement('div');
      chart1Div.className = 'bg-white rounded-2xl shadow p-4';
      const chart1Title = document.createElement('h2');
      chart1Title.className = 'font-semibold mb-2';
      chart1Title.textContent = 'Status das Atividades';
      chart1Div.appendChild(chart1Title);
      // Copia o canvas renderizado
      const statusCanvas = document.getElementById('statusChart');
      const statusImg = document.createElement('img');
      statusImg.src = statusCanvas.toDataURL('image/png');
      statusImg.style.width = '100%';
      statusImg.style.maxHeight = '280px';
      chart1Div.appendChild(statusImg);
      chartsSection.appendChild(chart1Div);
      // Prioridade
      const chart2Div = document.createElement('div');
      chart2Div.className = 'bg-white rounded-2xl shadow p-4';
      const chart2Title = document.createElement('h2');
      chart2Title.className = 'font-semibold mb-2';
      chart2Title.textContent = 'Prioridade';
      chart2Div.appendChild(chart2Title);
      const priorityCanvas = document.getElementById('priorityChart');
      const priorityImg = document.createElement('img');
      priorityImg.src = priorityCanvas.toDataURL('image/png');
      priorityImg.style.width = '100%';
      priorityImg.style.maxHeight = '280px';
      chart2Div.appendChild(priorityImg);
      chartsSection.appendChild(chart2Div);
      dashboard.appendChild(chartsSection);
      html2pdf().set({
        margin: 0.5,
        filename: 'dashboard_atividades.pdf',
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2, backgroundColor: null },
        jsPDF: { unit: 'in', format: 'a4', orientation: 'landscape' }
      }).from(dashboard).save().then(()=>{
        // Restaura o estado original dos gr√°ficos
        statusChart.options.plugins.datalabels = originalStatus;
        priorityChart.options.plugins.datalabels = originalPriority;
        statusChart.update();
        priorityChart.update();
      });
    }

    // Garante que os handlers dos bot√µes de relat√≥rio sejam sempre aplicados ap√≥s o carregamento
    window.addEventListener('DOMContentLoaded', function() {
      setupPDFExportButton();
      // Handler para Lista PDF
      const btnExportListPDF = document.getElementById('btnExportListPDF');
      if (btnExportListPDF) {
        btnExportListPDF.onclick = function () {
          if (!window.html2pdf) {
            const script = document.createElement('script');
            script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js';
            script.onload = exportListPDF;
            document.body.appendChild(script);
          } else {
            exportListPDF();
          }
        };
      }
    });

    // Fun√ß√£o para exportar a lista filtrada em PDF usando jsPDF autotable
    function exportListPDF() {
      let list = applyFilters(tasks);
      // Ordena pelo prazo mais pr√≥ximo do vencimento (ascendente), tarefas sem prazo v√£o para o final
      list = list.slice().sort((a, b) => {
        const pa = a.due_date || a.due;
        const pb = b.due_date || b.due;
        if (!pa && !pb) return 0;
        if (!pa) return 1;
        if (!pb) return -1;
        return new Date(pa) - new Date(pb);
      });

      // Cabe√ßalhos da tabela
      const headers = [
        'ID',
        'T√≠tulo',
        'Respons√°vel',
        'Prazo',
        'Prioridade',
        'Status',
        'Tags'
      ];

      // Dados da tabela
      const data = list.map(t => [
        t.sequential_id || '-',
        t.title || '-',
        t.assignee || '-',
        formatDate(t.due_date || t.due),
        t.priority || '-',
        t.status || '-',
        (t.tags || []).join(', ') || '-'
      ]);

      // Cria o PDF
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation: 'landscape', unit: 'pt', format: 'a4' });

      doc.setFontSize(16);
      doc.text('Lista de Atividades Filtradas', 40, 40);

      doc.autoTable({
        head: [headers],
        body: data,
        startY: 60,
        margin: { left: 20, right: 20 },
        styles: { fontSize: 9, cellPadding: 3 },
        headStyles: { fillColor: [30, 64, 175], textColor: 255, fontStyle: 'bold' },
        alternateRowStyles: { fillColor: [241, 245, 249] },
        didDrawPage: function (data) {
          doc.setFontSize(10);
          doc.setTextColor(150);
          doc.text('Gerado em: ' + new Date().toLocaleString('pt-BR'), data.settings.margin.left, doc.internal.pageSize.height - 10);
        }
      });

      doc.save('lista_atividades.pdf');
    }
  </script>
</body>
</html>