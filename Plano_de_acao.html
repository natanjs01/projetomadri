<!-- O código JavaScript deve estar apenas dentro das tags <script> no final do arquivo. Nenhuma função deve aparecer fora do <script>. -->
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Controle de Atividades — Dashboard & Anexos</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Chart.js DataLabels Plugin -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  <script>
    // Registrar o plugin globalmente para evitar erros
    window.addEventListener('DOMContentLoaded', function() {
      if (window.Chart && window.ChartDataLabels) {
        Chart.register(window.ChartDataLabels);
      }
    });
  </script>
  <!-- Supabase JS CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- jsPDF e autotable para exportação PDF profissional -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
  <style>
    /* Responsividade para rotação horizontal em dispositivos móveis */
    @media screen and (max-width: 900px) and (orientation: landscape) {
      /* Cards de KPI em linha única com rolagem horizontal */
      #kpiCards {
        display: flex !important;
        flex-direction: row !important;
        overflow-x: auto !important;
        gap: 0.5rem !important;
        padding-bottom: 0.5rem;
      }
      #kpiCards > div {
        min-width: 160px !important;
        max-width: 220px !important;
        flex: 0 0 auto !important;
        border-radius: 1rem !important;
        margin: 0 !important;
      }
      html, body {
        font-size: 0.95rem;
        padding: 0;
        margin: 0;
        overflow-x: auto;
      }
      .max-w-7xl {
        max-width: 100vw;
        padding: 0.5rem !important;
      }
      header, section, .bg-white, .rounded-2xl, .shadow, .p-4 {
        border-radius: 0 !important;
        box-shadow: none !important;
        padding-left: 0.5rem !important;
        padding-right: 0.5rem !important;
      }
      .grid, .grid-cols-2, .grid-cols-4, .grid-cols-6, .grid-cols-1, .lg\:grid-cols-2 {
        grid-template-columns: 1fr !important;
      }
      /* Filtros em coluna, não em linha */
      form[role="search"], .filtros-mobile-col {
        flex-direction: column !important;
        align-items: stretch !important;
        gap: 0.5rem !important;
      }
      /* Tabela com rolagem horizontal */
      .tabela-responsive, table {
        display: block;
        width: 100vw !important;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
      th, td {
        white-space: nowrap;
        font-size: 0.95em;
        min-width: 110px;
      }
      #statusChart, #priorityChart {
        min-width: 320px !important;
        max-width: 100vw !important;
        height: 220px !important;
      }
      .offcanvasRelatorios, #offcanvasRelatorios {
        width: 100vw !important;
        max-width: 100vw !important;
      }
    }
    /* Paleta para gráficos Chart.js (usada via getComputedStyle) */
    :root {
  --chart-bg: #fff;
  --chart-fg: #0f172a;
  --chart-emerald: #3ba97d;
  --chart-sky: #2586b6;
  --chart-amber: #bfa13b;
  --chart-rose: #b85c6b;
  --chart-slate: #6b7a8c;
    }
    * { scrollbar-width: thin; scrollbar-color: #CBD5E1 transparent; }
    ::-webkit-scrollbar { height: 8px; width: 8px; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 9999px; }
    ::-webkit-scrollbar-track { background: transparent; }
    .dropzone {
      border: 2px dashed #94a3b8; border-radius: 1rem; transition: all .15s ease;
    }
    .dropzone.dragover { border-color: #0ea5e9; background: #f0f9ff; }
    #statusChart, #priorityChart {
      height: 280px !important;
      max-height: 280px;
      min-height: 140px;
      width: 100% !important;
      max-width: 100%;
      display: block;
      margin: 0 auto;
    }
  </style>
</head>
<body class="bg-slate-50 text-slate-800">
  <div class="max-w-7xl mx-auto p-4 md:p-6" role="main" aria-label="Painel de atividades">
    <!-- UI: Header aprimorado com barra de ações, ícones SVG, toggle de tema -->
    <header class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
      <div class="flex items-center gap-3">
        <span class="inline-flex items-center justify-center rounded-full bg-sky-100 dark:bg-sky-900 p-2">
          <!-- UI: Ícone SVG do app -->
          <svg width="28" height="28" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" class="text-sky-600 dark:text-sky-400"><circle cx="12" cy="12" r="10"/><path d="M8 12h8M12 8v8"/></svg>
        </span>
        <div>
          <h1 class="text-2xl md:text-3xl font-bold tracking-tight text-black">Controle de Atividades</h1>
          <p class="text-slate-600 dark:text-slate-400 text-sm">Crie tarefas, anexe imagens, visualize em dashboard, lista ou Kanban.</p>
        </div>
      </div>
      <nav class="flex flex-wrap items-center gap-2 mt-3 md:mt-0" aria-label="Ações rápidas">
        <button id="btnNew" class="group flex items-center gap-2 px-3 py-2 rounded-xl bg-sky-600 text-white hover:bg-sky-700 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 transition" aria-label="Nova Atividade">
          <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg>
          <span class="hidden sm:inline">Nova</span>
        </button>
        <button id="btnExport" class="group flex items-center gap-2 px-3 py-2 rounded-xl bg-emerald-600 text-white hover:bg-emerald-700 focus:outline-none focus-visible:ring-2 focus-visible:ring-emerald-400 transition" aria-label="Exportar">
          <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 5v14M19 12l-7 7-7-7"/></svg>
          <span class="hidden sm:inline">Exportar</span>
        </button>
        <label class="group flex items-center gap-2 px-3 py-2 rounded-xl bg-amber-600 text-white hover:bg-amber-700 focus-within:ring-2 focus-within:ring-amber-400 cursor-pointer transition" aria-label="Importar">
          <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 19V5M5 12l7 7 7-7"/></svg>
          <span class="hidden sm:inline">Importar</span>
          <input type="file" id="inputImport" accept="application/json" class="hidden" />
        </label>
  <!-- botão PDF removido, só menu lateral de relatórios permanece -->
        <button id="btnRelatorios" class="group flex items-center gap-2 px-3 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700 focus:outline-none focus-visible:ring-2 focus-visible:ring-indigo-400 transition" aria-label="Abrir menu de relatórios" type="button">
          <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M3 6h18M3 12h18M3 18h18"/></svg>
          <span class="hidden sm:inline">Relatórios</span>
        </button>
        <!-- Off-canvas menu lateral de relatórios -->
        <div id="offcanvasRelatorios" class="fixed top-0 right-0 h-full w-80 max-w-full bg-white shadow-2xl border-l border-slate-200 z-50 transform translate-x-full transition-transform duration-300 ease-in-out flex flex-col" style="display:none;">
          <div class="flex items-center justify-between px-6 py-4 border-b">
            <h3 class="text-lg font-semibold">Relatórios</h3>
            <button id="btnCloseRelatorios" class="text-slate-500 hover:text-slate-900 text-2xl font-bold" title="Fechar">&times;</button>
          </div>
          <div class="flex-1 p-6 flex flex-col gap-4">
            <button id="btnExportPDF" class="flex items-center gap-2 px-4 py-3 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700 transition w-full" type="button">
              <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 5v14M19 12l-7 7-7-7"/></svg>
              PDF Dashboard
            </button>
            <button id="btnExportListPDF" class="flex items-center gap-2 px-4 py-3 rounded-xl bg-emerald-600 text-white hover:bg-emerald-700 transition w-full" type="button">
              <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M3 6h18M3 12h18M3 18h18"/></svg>
              Lista PDF
            </button>
            <!-- Outras opções de relatórios podem ser adicionadas aqui -->
          </div>
        </div>
        <button id="btnManageStatus" class="group flex items-center gap-2 px-3 py-2 rounded-xl bg-purple-600 text-white hover:bg-purple-700 focus:outline-none focus-visible:ring-2 focus-visible:ring-purple-400 transition" title="Gerenciar Status" aria-label="Gerenciar Status">
          <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg>
          <span class="hidden sm:inline">Status</span>
        </button>
        <button id="btnReset" class="group flex items-center gap-2 px-3 py-2 rounded-xl bg-rose-600 text-white hover:bg-rose-700 focus:outline-none focus-visible:ring-2 focus-visible:ring-rose-400 transition" title="Apagar todas as atividades" aria-label="Resetar">
          <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M3 6h18M8 6v12a2 2 0 0 0 2 2h4a2 2 0 0 0 2-2V6"/></svg>
          <span class="hidden sm:inline">Reset</span>
        </button>
      </nav>
    <script>
      // Off-canvas menu lateral de relatórios
      const btnRelatorios = document.getElementById('btnRelatorios');
      const offcanvas = document.getElementById('offcanvasRelatorios');
      const btnCloseRelatorios = document.getElementById('btnCloseRelatorios');
      btnRelatorios.addEventListener('click', function() {
        offcanvas.style.display = 'flex';
        setTimeout(()=>{offcanvas.classList.remove('translate-x-full');}, 10);
      });
      btnCloseRelatorios.addEventListener('click', function() {
        offcanvas.classList.add('translate-x-full');
        setTimeout(()=>{offcanvas.style.display = 'none';}, 300);
      });
      // Fecha ao clicar fora do menu
      document.addEventListener('mousedown', function(e) {
        if (offcanvas.style.display === 'flex' && !offcanvas.contains(e.target) && e.target !== btnRelatorios) {
          offcanvas.classList.add('translate-x-full');
          setTimeout(()=>{offcanvas.style.display = 'none';}, 300);
        }
      });
    </script>
    </header>

    <!-- KPIs -->
    <section class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3 mb-6" id="kpiCards">
  <!-- UI: Cards de KPI aprimorados, grid responsiva, ícones, contraste, tendência -->
  <!-- Cards gerados via JS -->
    </section>

    <!-- Charts -->
    <section class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6">
      <div class="bg-white rounded-2xl shadow p-4">
        <h2 class="font-semibold mb-2">Status das Atividades</h2>
        <canvas id="statusChart" height="140"></canvas>
      </div>
      <div class="bg-white rounded-2xl shadow p-4">
        <h2 class="font-semibold mb-2">Prioridade</h2>
        <canvas id="priorityChart" height="140"></canvas>
      </div>
    </section>

    <!-- Filtros / Abas -->
    <section class="bg-white rounded-2xl shadow p-4 mb-4">
      <!-- UI: Filtros compactos, alinhamento, placeholders claros, botão de reset, foco visível, contraste -->
      <form class="flex flex-col md:flex-row md:items-end gap-3" role="search" aria-label="Filtros de atividades" onsubmit="return false;">
        <div class="flex-1 min-w-[180px]">
          <label class="block text-sm font-medium mb-1" for="search">Busca</label>
          <div class="flex gap-2 items-center">
            <input id="search" class="w-full rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 text-slate-800 dark:text-slate-100 px-3 py-2 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 transition" placeholder="ID, título, responsável, tags..." autocomplete="off" />
            <label class="flex gap-1 items-center text-xs text-slate-600 dark:text-slate-400"><input type="checkbox" id="searchTagsOnly" class="accent-sky-600" /> Tags</label>
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1" for="filterStatus">Status</label>
          <select id="filterStatus" class="rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 text-slate-800 dark:text-slate-100 px-3 py-2 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 transition">
            <option value="">Todos</option>
            <option>Backlog</option>
            <option>Em andamento</option>
            <option>Bloqueado</option>
            <option>Concluído</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1" for="filterPriority">Prioridade</label>
          <select id="filterPriority" class="rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 text-slate-800 dark:text-slate-100 px-3 py-2 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 transition">
            <option value="">Todas</option>
            <option>Baixa</option>
            <option>Média</option>
            <option>Alta</option>
            <option>Crítica</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1" for="filterAssignee">Responsável</label>
          <input id="filterAssignee" class="rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 text-slate-800 dark:text-slate-100 px-3 py-2 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 transition" placeholder="Ex.: Ana" autocomplete="off" />
        </div>
        <div class="flex gap-2 mt-2 md:mt-0">
          <button id="tabList" class="px-4 py-2 rounded-2xl bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-100 hover:bg-sky-100 dark:hover:bg-sky-800 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 transition" type="button">Lista</button>
          <button id="tabKanban" class="px-4 py-2 rounded-2xl bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-100 hover:bg-sky-100 dark:hover:bg-sky-800 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 transition" type="button">Kanban</button>
          <button id="btnResetFilters" class="px-4 py-2 rounded-2xl bg-rose-100 dark:bg-rose-900 text-rose-700 dark:text-rose-200 hover:bg-rose-200 dark:hover:bg-rose-800 focus:outline-none focus-visible:ring-2 focus-visible:ring-rose-400 transition" type="reset" title="Limpar filtros" aria-label="Limpar filtros">
            <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M18 6L6 18M6 6l12 12"/></svg>
          </button>
        </div>
      </form>
    </section>

    <!-- Conteúdo: Lista -->
    <section id="viewList" class="bg-white rounded-2xl shadow overflow-x-auto">
      <!-- UI: Tabela aprimorada, cabeçalho sticky, zebra rows, chips, badges, foco visível, contraste -->
      <div class="overflow-x-auto rounded-2xl">
        <table class="min-w-full text-sm border-separate border-spacing-0" aria-label="Lista de atividades">
          <thead class="bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-200 sticky top-0 z-10 shadow-sm">
            <tr>
              <th scope="col" class="text-left px-4 py-3 font-semibold">ID</th>
              <th scope="col" class="text-left px-4 py-3 font-semibold">Título</th>
              <th scope="col" class="text-left px-4 py-3 font-semibold">Responsável</th>
              <th scope="col" class="text-left px-4 py-3 font-semibold">Prazo</th>
              <th scope="col" class="text-left px-4 py-3 font-semibold">Prioridade</th>
              <th scope="col" class="text-left px-4 py-3 font-semibold">Status</th>
              <th scope="col" class="text-left px-4 py-3 font-semibold">Tags</th>
              <th scope="col" class="text-left px-4 py-3 font-semibold">Anexos</th>
              <th scope="col" class="px-4 py-3 font-semibold">Ações</th>
            </tr>
          </thead>
          <tbody id="taskTable" class="divide-y divide-slate-100 dark:divide-slate-800"></tbody>
        </table>
      </div>
  <div id="loadingList" class="hidden p-6 text-center text-slate-500 dark:text-slate-400 animate-pulse" aria-live="polite">Carregando atividades…</div>
  <div id="errorList" class="hidden p-6 text-center text-rose-600 dark:text-rose-400" aria-live="assertive">Erro ao carregar atividades. Tente novamente.</div>
  <div id="emptyList" class="hidden p-6 text-center text-slate-500 dark:text-slate-400" aria-live="polite">Nenhuma atividade encontrada…</div>
    </section>

    <!-- Conteúdo: Kanban -->
    <section id="viewKanban" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
  <!-- UI: Kanban aprimorado, colunas distintas, cabeçalho com contagem, cartões legíveis, tags, miniaturas, responsividade, acessibilidade -->
  <!-- Colunas geradas via JS -->
    </section>
  </div>

  <!-- Modal: Nova/Editar Atividade -->
  <dialog id="taskModal" class="rounded-2xl w-11/12 max-w-3xl p-0 shadow-2xl">
    <form id="taskForm" class="bg-white rounded-2xl" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="flex justify-between items-center px-5 py-4 border-b">
        <h3 id="modalTitle" class="text-lg font-semibold">Nova Atividade</h3>
        <button type="button" id="btnCloseModal" class="p-2 rounded-xl hover:bg-slate-100">✕</button>
      </div>
      <div class="p-5 grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="md:col-span-2">
          <label class="block text-sm font-medium mb-1" for="inputTitle">Título *</label>
          <input required name="title" id="inputTitle" class="w-full rounded-xl border border-slate-300 px-3 py-2" placeholder="Ex.: Publicar especificação do módulo fiscal" />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1" for="inputAssignee">Responsável</label>
          <input name="assignee" id="inputAssignee" class="w-full rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 text-slate-800 dark:text-slate-100 px-3 py-2 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 transition" placeholder="Ex.: Natanael" />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1" for="inputDue">Prazo</label>
          <input type="date" name="due" id="inputDue" class="w-full rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 text-slate-800 dark:text-slate-100 px-3 py-2 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 transition" />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1" for="inputPriority">Prioridade</label>
          <select name="priority" id="inputPriority" class="w-full rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 text-slate-800 dark:text-slate-100 px-3 py-2 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 transition">
            <option>Baixa</option>
            <option>Média</option>
            <option selected>Alta</option>
            <option>Crítica</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1" for="inputStatus">Status</label>
          <select name="status" id="inputStatus" class="w-full rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 text-slate-800 dark:text-slate-100 px-3 py-2 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 transition">
            <option>Backlog</option>
            <option selected>Em andamento</option>
            <option>Bloqueado</option>
            <option>Concluído</option>
          </select>
        </div>
        <div class="md:col-span-2">
          <label class="block text-sm font-medium mb-1" for="inputDescription">Descrição</label>
          <textarea name="description" id="inputDescription" rows="3" class="w-full rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 text-slate-800 dark:text-slate-100 px-3 py-2 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 transition" placeholder="Contexto, escopo, critérios de aceite…"></textarea>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1" for="inputTags">Tags (separe por vírgula)</label>
          <input name="tags" id="inputTags" class="w-full rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 text-slate-800 dark:text-slate-100 px-3 py-2 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 transition" placeholder="ex.: fiscal, SAP, ICMS" />
        </div>
        <!-- Anexos -->
        <div class="md:col-span-2">
          <label class="block text-sm font-medium mb-2">Anexos (imagens)</label>
          <div id="dropArea" class="dropzone p-4 text-sm text-slate-600 dark:text-slate-400 flex flex-col items-center justify-center gap-2 transition-all" aria-label="Área de anexos" tabindex="0">
            <p>Arraste e solte imagens aqui ou</p>
            <label class="px-3 py-2 rounded-xl bg-slate-800 dark:bg-slate-700 text-white cursor-pointer focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 transition">Selecionar imagens
              <input type="file" id="imageInput" accept="image/*" multiple class="hidden" />
            </label>
            <p class="text-xs text-slate-500 dark:text-slate-400">As imagens ficam salvas localmente no seu navegador.</p>
          </div>
          <div id="thumbs" class="mt-3 flex flex-wrap gap-2"></div>
        </div>
      </div>
      <div class="px-5 py-4 border-t border-slate-100 dark:border-slate-800 flex justify-end gap-2">
        <button type="button" id="btnClearAnexos" class="px-4 py-2 rounded-2xl bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-100 hover:bg-sky-100 dark:hover:bg-sky-800 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 transition">Limpar anexos</button>
        <button type="submit" class="px-4 py-2 rounded-2xl bg-sky-600 text-white hover:bg-sky-700 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-400 transition">Salvar</button>
      </div>
    </form>
  </dialog>

  <!-- Modal: Detalhes -->
  <dialog id="detailModal" class="rounded-2xl w-11/12 max-w-3xl p-0 shadow-2xl">
    <div class="bg-white rounded-2xl">
      <div class="flex justify-between items-center px-5 py-4 border-b">
        <h3 class="text-lg font-semibold">Detalhes da Atividade</h3>
        <button type="button" id="btnCloseDetail" class="p-2 rounded-xl hover:bg-slate-100">✕</button>
      </div>
      <div id="detailBody" class="p-5 space-y-3 text-sm"></div>
      <div class="px-5 py-4 border-t text-right">
        <button type="button" id="btnCloseDetail2" class="px-4 py-2 rounded-2xl bg-slate-200">Fechar</button>
      </div>
    </div>
  </dialog>

  <!-- Modal: Gerenciar Status -->
  <dialog id="statusModal" class="rounded-2xl w-11/12 max-w-2xl p-0 shadow-2xl">
    <div class="bg-white rounded-2xl">
      <div class="flex justify-between items-center px-5 py-4 border-b">
        <h3 class="text-lg font-semibold">Gerenciar Status</h3>
        <button type="button" id="btnCloseStatusModal" class="p-2 rounded-xl hover:bg-slate-100">✕</button>
      </div>
      <div class="p-5">
        <!-- Adicionar novo status -->
        <div class="mb-6 p-4 bg-slate-50 rounded-xl">
          <div class="flex items-center justify-between mb-3">
            <h4 class="font-medium">Adicionar Novo Status</h4>
            <div id="editModeIndicator" class="hidden px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full">
              Modo Edição
            </div>
          </div>
          <div class="flex gap-3 items-end">
            <div class="flex-1">
              <label class="block text-sm font-medium mb-1">Nome do Status</label>
              <input type="text" id="newStatusName" class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-400" placeholder="Ex: Aguardando Aprovação">
            </div>
            <div class="flex-1">
              <label class="block text-sm font-medium mb-1">Cor (classe CSS)</label>
              <select id="newStatusColor" class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-400">
                <option value="bg-slate-200 text-slate-800">Cinza (Padrão)</option>
                <option value="bg-blue-100 text-blue-800">Azul</option>
                <option value="bg-indigo-100 text-indigo-800">Índigo</option>
                <option value="bg-purple-100 text-purple-800">Roxo</option>
                <option value="bg-pink-100 text-pink-800">Rosa</option>
                <option value="bg-red-100 text-red-800">Vermelho</option>
                <option value="bg-orange-100 text-orange-800">Laranja</option>
                <option value="bg-amber-100 text-amber-800">Âmbar</option>
                <option value="bg-yellow-100 text-yellow-800">Amarelo</option>
                <option value="bg-lime-100 text-lime-800">Lima</option>
                <option value="bg-green-100 text-green-800">Verde</option>
                <option value="bg-emerald-100 text-emerald-800">Esmeralda</option>
                <option value="bg-teal-100 text-teal-800">Verde-azulado</option>
                <option value="bg-cyan-100 text-cyan-800">Ciano</option>
              </select>
            </div>
            <div class="flex gap-2">
              <button type="button" id="btnAddStatus" class="px-4 py-2 rounded-xl bg-purple-600 text-white hover:bg-purple-700 transition">
                Adicionar
              </button>
            </div>
          </div>
        </div>

        <!-- Instruções para Supabase -->
        <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-xl">
          <h4 class="font-medium text-blue-800 mb-2">📝 Primeira vez usando status personalizados?</h4>
          <p class="text-sm text-blue-700 mb-2">Para salvar no Supabase, é necessário criar a tabela <code class="bg-blue-100 px-1 rounded">custom_status</code>:</p>
          <details class="text-xs">
            <summary class="cursor-pointer text-blue-600 font-medium">Ver código SQL</summary>
            <pre class="mt-2 p-2 bg-blue-100 rounded text-blue-800 overflow-x-auto">CREATE TABLE custom_status (
  id UUID PRIMARY KEY,
  name VARCHAR(255) NOT NULL,
  color VARCHAR(255) NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);</pre>
          </details>
        </div>

        <!-- Lista de status existentes -->
        <div>
          <h4 class="font-medium mb-3">Status Existentes</h4>
          <div id="statusList" class="space-y-2">
            <!-- Status serão carregados dinamicamente aqui -->
          </div>
        </div>
      </div>
      <div class="px-5 py-4 border-t text-right">
        <button type="button" id="btnCloseStatusModal2" class="px-4 py-2 rounded-xl bg-slate-200 hover:bg-slate-300 transition mr-2">Fechar</button>
        <button type="button" id="btnSaveStatusToSupabase" class="px-4 py-2 rounded-xl bg-purple-600 text-white hover:bg-purple-700 transition">Salvar no Supabase</button>
      </div>
    </div>
  </dialog>

  <script>
  // Corrige botão Limpar filtros para atualizar a lista
  document.getElementById('btnResetFilters').addEventListener('click', function(e) {
    setTimeout(refreshViews, 0);
  });
  // UI: Tema claro/escuro com toggle, persistência e integração Chart.js
  // Modo escuro removido

  // ====== Supabase integração ======
      const supabaseUrl = "https://iynsvuugjjbvjacrjmig.supabase.co";
      const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml5bnN2dXVnampidmphY3JqbWlnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4ODUwODksImV4cCI6MjA3NDQ2MTA4OX0.b-8p05tTG4iLbITGVdY1Da3TQbbupaYIZLfT-aMhPbk";
  const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

      // Buscar tasks do Supabase e exibir no console
      async function fetchTasksSupabase() {
        const { data, error } = await supabaseClient.from('tasks').select('*');
        if (error) {
          console.error('Erro ao buscar tasks do Supabase:', error);
        } else {
          console.log('Tasks do Supabase:', data);
        }
      }
      fetchTasksSupabase();

      // Funções Supabase para CRUD
      async function supabaseInsertTask(task) {
        // Monta payload para tasks, removendo attachments
        const { attachments, ...payload } = task;
        // Corrige nome do campo de data
        if (payload.due) {
          payload.due_date = payload.due;
          delete payload.due;
        }
        // tags precisa ser array de string
        if (typeof payload.tags === 'string') {
          payload.tags = payload.tags.split(',').map(x=>x.trim()).filter(Boolean);
        }
        const { data, error } = await supabaseClient.from('tasks').upsert([payload], { onConflict: ['id'] });
        if (error) {
          console.error('Erro ao salvar no Supabase:', error, payload);
        } else {
          console.log('Tarefa salva no Supabase:', data, payload);
        }
        // Salva anexos na tabela task_attachments
        if (Array.isArray(attachments) && attachments.length > 0) {
          for (const a of attachments) {
            const { data: attachData, error: attachError } = await supabaseClient.from('task_attachments').upsert([
              {
                id: a.id || (window.crypto ? crypto.randomUUID() : Math.random().toString(36).slice(2) + Date.now().toString(36)),
                task_id: payload.id,
                file_name: a.name,
                file_url: a.dataURL,
                created_at: new Date().toISOString()
              }
            ]);
            if (attachError) {
              console.error('Erro ao salvar anexo no Supabase:', attachError, a);
            } else {
              console.log('Anexo salvo no Supabase:', attachData, a);
            }
          }
        }
      }

      async function supabaseDeleteTask(id) {
        const { error } = await supabaseClient.from('tasks').delete().eq('id', id);
        if (error) console.error('Erro ao excluir no Supabase:', error);
        // Excluir anexos relacionados
        await supabaseClient.from('task_attachments').delete().eq('task_id', id);
      }

      async function supabaseBulkInsertTasks(taskList) {
        for (const t of taskList) {
          await supabaseInsertTask(t);
        }
      }

    // ====== Gerenciamento de Status ======
    const STATUS_STORAGE_KEY = 'taskBoard_status_v1';
    let customStatusList = [];

    // Status padrão do sistema
    const defaultStatusMap = {
      'Backlog': 'bg-slate-200 text-slate-800',
      'Em andamento': 'bg-indigo-100 text-indigo-800', 
      'Bloqueado': 'bg-rose-100 text-rose-800',
      'Concluído': 'bg-emerald-100 text-emerald-800'
    };

    // Carregar status personalizados do localStorage
    function loadCustomStatus() {
      const stored = localStorage.getItem(STATUS_STORAGE_KEY);
      if (stored) {
        try {
          customStatusList = JSON.parse(stored);
        } catch (e) {
          console.error('Erro ao carregar status personalizados:', e);
          customStatusList = [];
        }
      }
    }

    // Salvar status personalizados no localStorage
    function saveCustomStatus() {
      localStorage.setItem(STATUS_STORAGE_KEY, JSON.stringify(customStatusList));
    }

    // Obter todos os status (padrão + personalizados)
    function getAllStatus() {
      const statusMap = {...defaultStatusMap};
      customStatusList.forEach(status => {
        statusMap[status.name] = status.color;
      });
      return statusMap;
    }

    // Obter lista de nomes de status
    function getAllStatusNames() {
      return Object.keys(getAllStatus());
    }

    // Função para atualizar os selects de status
    function updateStatusSelects() {
      const statusNames = getAllStatusNames();
      
      // Atualizar select de filtro
      const filterStatus = document.getElementById('filterStatus');
      const currentFilterValue = filterStatus.value;
      filterStatus.innerHTML = '<option value="">Todos</option>';
      statusNames.forEach(status => {
        const option = document.createElement('option');
        option.value = status;
        option.textContent = status;
        if (status === currentFilterValue) option.selected = true;
        filterStatus.appendChild(option);
      });

      // Atualizar select do formulário
      const inputStatus = document.getElementById('inputStatus');
      const currentInputValue = inputStatus.value;
      inputStatus.innerHTML = '';
      statusNames.forEach(status => {
        const option = document.createElement('option');
        option.value = status;
        option.textContent = status;
        if (status === currentInputValue || (status === 'Em andamento' && !currentInputValue)) {
          option.selected = true;
        }
        inputStatus.appendChild(option);
      });
    }

    // Função badgeStatus atualizada para usar status personalizados
    function badgeStatusUpdated(s) {
      const statusMap = getAllStatus();
      return `<span class="px-2 py-1 rounded-full text-xs ${statusMap[s]||'bg-slate-100 text-slate-800'}">${s||'-'}</span>`;
    }

    // Adicionar novo status ou salvar edição
    function addNewStatus(name, color) {
      const addButton = document.getElementById('btnAddStatus');
      const editingStatus = addButton.getAttribute('data-editing');
      
      if (editingStatus) {
        // Modo edição
        const success = saveStatusChanges(editingStatus, name, color);
        if (success) {
          cancelEditStatus();
        }
        return success;
      } else {
        // Modo adição
        if (!name || !name.trim()) {
          alert('Nome do status é obrigatório');
          return false;
        }

        const trimmedName = name.trim();
        
        // Verificar se já existe
        if (getAllStatusNames().includes(trimmedName)) {
          alert('Este status já existe');
          return false;
        }

        // Adicionar à lista
        customStatusList.push({
          name: trimmedName,
          color: color || 'bg-slate-200 text-slate-800'
        });

        saveCustomStatus();
        updateStatusSelects();
        renderStatusList();
        refreshViews();
        
        showStatusMessage(`Status "${trimmedName}" adicionado com sucesso!`, 'success');
        return true;
      }
    }

    // Excluir status personalizado
    function deleteCustomStatus(name) {
      // Não permitir exclusão de status padrão
      if (defaultStatusMap[name]) {
        alert('Não é possível excluir status padrão do sistema');
        return;
      }

      // Verificar se alguma tarefa usa este status
      const tasksUsingStatus = tasks.filter(task => task.status === name);
      if (tasksUsingStatus.length > 0) {
        if (!confirm(`Existem ${tasksUsingStatus.length} tarefas usando este status. Deseja continuar? As tarefas precisarão ter seu status alterado manualmente.`)) {
          return;
        }
      }

      if (confirm(`Tem certeza que deseja excluir o status "${name}"?`)) {
        // Remover da lista
        customStatusList = customStatusList.filter(status => status.name !== name);
        saveCustomStatus();
        updateStatusSelects();
        renderStatusList();
        refreshViews();
        
        // Mostrar mensagem de sucesso
        showStatusMessage(`Status "${name}" excluído com sucesso!`, 'success');
      }
    }

    // Editar status personalizado
    function editCustomStatus(name) {
      // Não permitir edição de status padrão
      if (defaultStatusMap[name]) {
        alert('Não é possível editar status padrão do sistema');
        return;
      }

      // Encontrar o status na lista
      const statusIndex = customStatusList.findIndex(status => status.name === name);
      if (statusIndex === -1) {
        alert('Status não encontrado');
        return;
      }

      const currentStatus = customStatusList[statusIndex];
      
      // Preencher o formulário de edição com os dados atuais
      document.getElementById('newStatusName').value = currentStatus.name;
      document.getElementById('newStatusColor').value = currentStatus.color;
      
      // Alterar o botão para modo edição
      const addButton = document.getElementById('btnAddStatus');
      addButton.textContent = 'Salvar Alterações';
      addButton.className = 'px-4 py-2 rounded-xl bg-green-600 text-white hover:bg-green-700 transition';
      
      // Adicionar atributo para identificar que está editando
      addButton.setAttribute('data-editing', name);
      
      // Mostrar indicador de modo edição
      document.getElementById('editModeIndicator').classList.remove('hidden');
      
      // Mostrar botão cancelar
      let cancelButton = document.getElementById('btnCancelEdit');
      if (!cancelButton) {
        cancelButton = document.createElement('button');
        cancelButton.id = 'btnCancelEdit';
        cancelButton.type = 'button';
        cancelButton.textContent = 'Cancelar';
        cancelButton.className = 'px-4 py-2 rounded-xl bg-slate-400 text-white hover:bg-slate-500 transition';
        addButton.parentNode.appendChild(cancelButton);
        
        cancelButton.addEventListener('click', cancelEditStatus);
      }
      cancelButton.style.display = 'inline-block';
      
      // Focar no campo nome
      document.getElementById('newStatusName').focus();
    }

    // Cancelar edição de status
    function cancelEditStatus() {
      const addButton = document.getElementById('btnAddStatus');
      const cancelButton = document.getElementById('btnCancelEdit');
      
      // Restaurar estado original do botão
      addButton.textContent = 'Adicionar';
      addButton.className = 'px-4 py-2 rounded-xl bg-purple-600 text-white hover:bg-purple-700 transition';
      addButton.removeAttribute('data-editing');
      
      // Esconder indicador de modo edição
      document.getElementById('editModeIndicator').classList.add('hidden');
      
      // Esconder botão cancelar
      if (cancelButton) {
        cancelButton.style.display = 'none';
      }
      
      // Limpar formulário
      document.getElementById('newStatusName').value = '';
      document.getElementById('newStatusColor').value = 'bg-slate-200 text-slate-800';
    }

    // Função para salvar alterações no status (modificação do addNewStatus)
    function saveStatusChanges(oldName, newName, newColor) {
      if (!newName || !newName.trim()) {
        alert('Nome do status é obrigatório');
        return false;
      }

      const trimmedName = newName.trim();
      
      // Se o nome mudou, verificar se já existe outro com esse nome
      if (oldName !== trimmedName && getAllStatusNames().includes(trimmedName)) {
        alert('Já existe um status com este nome');
        return false;
      }

      // Encontrar e atualizar o status
      const statusIndex = customStatusList.findIndex(status => status.name === oldName);
      if (statusIndex !== -1) {
        const oldStatusName = customStatusList[statusIndex].name;
        customStatusList[statusIndex] = {
          name: trimmedName,
          color: newColor || 'bg-slate-200 text-slate-800'
        };

        // Se o nome mudou, atualizar todas as tarefas que usam este status
        if (oldStatusName !== trimmedName) {
          tasks.forEach(task => {
            if (task.status === oldStatusName) {
              task.status = trimmedName;
            }
          });
          
          // Salvar tarefas atualizadas
          save();
          
          // Sincronizar com Supabase se necessário
          supabaseBulkInsertTasks(tasks);
        }

        saveCustomStatus();
        updateStatusSelects();
        renderStatusList();
        refreshViews();
        
        showStatusMessage(`Status "${trimmedName}" atualizado com sucesso!`, 'success');
        return true;
      }
      
      return false;
    }

    // Mostrar mensagem de status
    function showStatusMessage(message, type = 'info') {
      // Remover notificação anterior se existir
      const existingNotification = document.getElementById('statusNotification');
      if (existingNotification) {
        existingNotification.remove();
      }
      
      // Criar nova notificação
      const notification = document.createElement('div');
      notification.id = 'statusNotification';
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: -400px;
        padding: 12px 16px;
        border-radius: 8px;
        color: white;
        font-size: 14px;
        font-weight: 500;
        z-index: 9999;
        transition: right 0.3s ease-in-out;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        max-width: 300px;
        word-wrap: break-word;
        cursor: pointer;
      `;
      
      // Definir cor baseada no tipo
      const colors = {
        success: '#10b981', // Verde
        error: '#ef4444',   // Vermelho
        info: '#3b82f6'     // Azul
      };
      
      // Aplicar cor de fundo
      notification.style.backgroundColor = colors[type] || colors.info;
      
      // Definir ícone baseado no tipo
      const icons = {
        success: '✓',
        error: '⚠',
        info: 'ℹ'
      };
      
      notification.innerHTML = `
        <div style="display: flex; align-items: center; justify-content: space-between; gap: 8px;">
          <div style="display: flex; align-items: center; gap: 8px;">
            <span style="font-size: 16px;">${icons[type] || icons.info}</span>
            <span>${message}</span>
          </div>
          <span style="font-size: 18px; opacity: 0.7; line-height: 1;">×</span>
        </div>
      `;
      
      // Função para esconder e remover notificação
      function hideNotification() {
        notification.style.right = '-400px';
        setTimeout(() => {
          if (notification.parentNode) {
            notification.remove();
          }
        }, 300);
      }
      
      // Permitir fechar clicando na notificação
      notification.addEventListener('click', hideNotification);
      
      // Adicionar ao DOM
      document.body.appendChild(notification);
      
      // Mostrar notificação (animar para dentro)
      setTimeout(() => {
        notification.style.right = '20px';
      }, 50);
      
      // Esconder após 4 segundos
      setTimeout(hideNotification, 4000);
    }

    // Renderizar lista de status no modal
    function renderStatusList() {
      const statusList = document.getElementById('statusList');
      const allStatus = getAllStatus();
      
      statusList.innerHTML = '';
      
      Object.keys(allStatus).forEach(statusName => {
        const statusColor = allStatus[statusName];
        const isDefault = defaultStatusMap[statusName];
        
        const statusItem = document.createElement('div');
        statusItem.className = 'flex items-center justify-between p-3 bg-white border border-slate-200 rounded-xl';
        
        statusItem.innerHTML = `
          <div class="flex items-center gap-3">
            <span class="px-2 py-1 rounded-full text-xs ${statusColor}">${statusName}</span>
            <span class="text-sm text-slate-600">${isDefault ? '(Padrão)' : '(Personalizado)'}</span>
          </div>
          <div class="flex gap-2">
            ${!isDefault ? `
              <button onclick="editCustomStatus('${statusName}')" class="px-3 py-1 text-xs bg-blue-100 text-blue-800 rounded-lg hover:bg-blue-200 transition">Editar</button>
              <button onclick="deleteCustomStatus('${statusName}')" class="px-3 py-1 text-xs bg-red-100 text-red-800 rounded-lg hover:bg-red-200 transition">Excluir</button>
            ` : ''}
          </div>
        `;
        
        statusList.appendChild(statusItem);
      });
    }

    // Salvar status personalizados no Supabase
    async function saveStatusToSupabase() {
      try {
        // Primeiro, verificar se a tabela existe e criar se necessário
        const testQuery = await supabaseClient.from('custom_status').select('id').limit(1);
        
        if (testQuery.error && testQuery.error.message.includes('does not exist')) {
          // Tabela não existe, vamos criar através de uma inserção
          console.log('Tabela custom_status será criada automaticamente');
        }
        
        // Limpar registros existentes de status personalizados
        const { error: deleteError } = await supabaseClient.from('custom_status').delete().gte('id', '00000000-0000-0000-0000-000000000000');
        
        if (deleteError && !deleteError.message.includes('does not exist')) {
          console.warn('Aviso ao limpar status existentes:', deleteError);
        }
        
        // Inserir status personalizados
        if (customStatusList.length > 0) {
          const statusData = customStatusList.map(status => ({
            id: window.crypto ? crypto.randomUUID() : Math.random().toString(36),
            name: status.name,
            color: status.color,
            created_at: new Date().toISOString()
          }));
          
          const { error } = await supabaseClient.from('custom_status').insert(statusData);
          if (error) {
            console.error('Erro ao salvar status no Supabase:', error);
            showStatusMessage('Erro ao salvar status no Supabase. Verifique se a tabela existe.', 'error');
          } else {
            showStatusMessage('Status salvos no Supabase com sucesso!', 'success');
          }
        } else {
          showStatusMessage('Status personalizados removidos do Supabase!', 'success');
        }
      } catch (error) {
        console.error('Erro ao conectar com Supabase:', error);
        showStatusMessage('Erro ao conectar com Supabase: ' + error.message, 'error');
      }
    }

    // Carregar status personalizados do Supabase
    async function loadStatusFromSupabase() {
      try {
        const { data, error } = await supabaseClient.from('custom_status').select('*');
        if (error) {
          // Se a tabela não existir, será criada automaticamente pelo Supabase quando inserirmos dados
          if (error.message.includes('relation "public.custom_status" does not exist')) {
            console.log('Tabela custom_status não existe ainda. Será criada quando necessário.');
          } else {
            console.error('Erro ao carregar status do Supabase:', error);
          }
        } else if (data && data.length > 0) {
          customStatusList = data.map(item => ({
            name: item.name,
            color: item.color
          }));
          saveCustomStatus();
          updateStatusSelects();
        }
      } catch (error) {
        console.error('Erro ao conectar com Supabase para carregar status:', error);
      }
    }

    // ====== State & Persistência ======
    const STORAGE_KEY = 'taskBoard_v1';
  let tasks = [];
  console.log('Tarefas carregadas ao iniciar:', tasks);
    let editingId = null;
    let anexosTemp = []; // {name, dataURL}

    function uuidv4() {
      if (window.crypto && window.crypto.randomUUID) return window.crypto.randomUUID();
      // Fallback para navegadores antigos
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        var r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }

    // Função para gerar ID sequencial no formato ID001, ID002, etc.
    function generateSequentialId() {
      const maxId = tasks.reduce((max, task) => {
        if (task.sequential_id) {
          const num = parseInt(task.sequential_id.replace('ID', ''));
          return Math.max(max, num);
        }
        return max;
      }, 0);
      return `ID${String(maxId + 1).padStart(3, '0')}`;
    }
    // Carregar tarefas do Supabase ao iniciar
    async function loadTasksFromSupabase() {
      const { data, error } = await supabaseClient.from('tasks').select('*');
      if (error) {
        console.error('Erro ao carregar tarefas do Supabase:', error);
        tasks = [];
      } else {
        tasks = data || [];
        // Migrar tarefas existentes sem sequential_id
        await migrateExistingTasks();
      }
    }

    // Função para migrar tarefas existentes e atribuir IDs sequenciais
    async function migrateExistingTasks() {
      let needsUpdate = false;
      let counter = 1;
      
      for (let task of tasks) {
        if (!task.sequential_id) {
          task.sequential_id = `ID${String(counter).padStart(3, '0')}`;
          needsUpdate = true;
          counter++;
          
          // Atualizar no Supabase
          const { error } = await supabaseClient
            .from('tasks')
            .update({ sequential_id: task.sequential_id })
            .eq('id', task.id);
            
          if (error) {
            console.error('Erro ao migrar tarefa:', error);
          }
        } else {
          // Se já tem sequential_id, extrair o número para continuar a sequência
          const num = parseInt(task.sequential_id.replace('ID', ''));
          if (num >= counter) {
            counter = num + 1;
          }
        }
      }
      
      if (needsUpdate) {
        console.log('Migração de IDs sequenciais concluída');
      }
    }
    function save() { localStorage.setItem(STORAGE_KEY, JSON.stringify(tasks)); }
  console.log('Tarefas salvas:', tasks);

    // ====== Utilitários ======
    function formatDate(iso) {
      if (!iso) return '-';
      const d = new Date(iso + 'T00:00:00');
      return d.toLocaleDateString('pt-BR');
    }
    function daysDiffFromToday(iso) {
      if (!iso) return null;
      const d1 = new Date(); d1.setHours(0,0,0,0);
      const d2 = new Date(iso + 'T00:00:00');
      return Math.round((d2 - d1) / (1000*60*60*24));
    }
    function badgePriority(p) {
      const map = { 'Baixa':'bg-emerald-100 text-emerald-800', 'Média':'bg-sky-100 text-sky-800', 'Alta':'bg-amber-100 text-amber-800', 'Crítica':'bg-rose-100 text-rose-800' };
      return `<span class="px-2 py-1 rounded-full text-xs ${map[p]||'bg-slate-100 text-slate-800'}">${p||'-'}</span>`;
    }
    function badgeStatus(s) {
      const statusMap = getAllStatus();
      return `<span class="px-2 py-1 rounded-full text-xs ${statusMap[s]||'bg-slate-100 text-slate-800'}">${s||'-'}</span>`;
    }

    // ====== Dashboard (KPIs & Charts) ======
    const kpi = {
      render() {
        const total = tasks.length;
        const done = tasks.filter(t=>t.status==='Concluído').length;
        const doing = tasks.filter(t=>t.status==='Em andamento').length;
        const blocked = tasks.filter(t=>t.status==='Bloqueado').length;
        const backlog = tasks.filter(t=>t.status==='Backlog').length;
        const overdue = tasks.filter(t=> t.due_date && daysDiffFromToday(t.due_date) < 0 && t.status !== 'Concluído').length;
        const soon = tasks.filter(t=> t.due_date && daysDiffFromToday(t.due_date) >= 0 && daysDiffFromToday(t.due_date) <= 7 && t.status!=='Concluído').length;
        const pct = total? Math.round((done/total)*100):0;
        const cards = [
          {label:'Total', val: total, icon:`<svg width='22' height='22' fill='none' stroke='currentColor' stroke-width='2' viewBox='0 0 24 24'><circle cx='12' cy='12' r='10'/></svg>`, color:'bg-white'},
          {label:'Concluídas', val: done, icon:`<svg width='22' height='22' fill='none' stroke='currentColor' stroke-width='2' viewBox='0 0 24 24'><path d='M5 13l4 4L19 7'/></svg>`, color:'bg-white'},
          {label:'Em andamento', val: doing, icon:`<svg width='22' height='22' fill='none' stroke='currentColor' stroke-width='2' viewBox='0 0 24 24'><circle cx='12' cy='12' r='10'/><path d='M12 6v6l4 2'/></svg>`, color:'bg-white'},
          {label:'Bloqueadas', val: blocked, icon:`<svg width='22' height='22' fill='none' stroke='currentColor' stroke-width='2' viewBox='0 0 24 24'><rect x='3' y='11' width='18' height='7' rx='2'/><path d='M7 11V7a5 5 0 0 1 10 0v4'/></svg>`, color:'bg-white'},
          {label:'Backlog', val: backlog, icon:`<svg width='22' height='22' fill='none' stroke='currentColor' stroke-width='2' viewBox='0 0 24 24'><rect x='3' y='7' width='18' height='13' rx='2'/><path d='M16 3v4M8 3v4'/></svg>`, color:'bg-white'},
          {label:'Vencidas', val: overdue, icon:`<svg width='22' height='22' fill='none' stroke='currentColor' stroke-width='2' viewBox='0 0 24 24'><circle cx='12' cy='12' r='10'/><path d='M12 8v4l3 3'/></svg>`, color:'bg-white'},
        ];
        const el = document.getElementById('kpiCards');
        el.innerHTML = '';
        cards.forEach((c) => {
          const div = document.createElement('div');
          div.className = `${c.color} rounded-2xl shadow p-4 flex flex-col gap-2 items-start`;
          div.innerHTML = `
            <div class="flex items-center gap-2">
              <span class="inline-flex items-center justify-center rounded-full bg-white/80 p-1">${c.icon}</span>
              <span class="text-xs font-medium text-slate-500">${c.label}</span>
            </div>
            <div class="text-2xl font-bold text-slate-800">${c.val}</div>
          `;
          el.appendChild(div);
        });
        // Extra: porcentagem concluída
        const extra = document.createElement('div');
        extra.className = 'col-span-2 lg:col-span-2 flex flex-col md:flex-row items-center justify-between gap-2 bg-white dark:bg-slate-900 rounded-2xl shadow-sm p-4 border border-slate-100 dark:border-slate-800';
        extra.innerHTML = `
          <div>
            <div class="text-sm text-slate-500 dark:text-slate-400">% Concluído</div>
            <div class="text-2xl font-bold text-emerald-600 dark:text-emerald-400">${pct}%</div>
            <div class="text-xs text-slate-500 dark:text-slate-400">${soon} atividades com prazo nos próximos 7 dias</div>
          </div>
          <div class="flex-1 ml-4 h-3 bg-slate-100 dark:bg-slate-800 rounded-full overflow-hidden">
            <div class="h-full bg-emerald-500 dark:bg-emerald-600 transition-all duration-200" style="width:${pct}%"></div>
          </div>`;
        extra.setAttribute('tabindex','0');
        extra.setAttribute('role','region');
        extra.setAttribute('aria-label','Porcentagem concluída');
        el.appendChild(extra);
      }
    };

    let statusChart, priorityChart;
    function refreshCharts() {
      const byStatus = ['Backlog','Em andamento','Bloqueado','Concluído'].map(s=> tasks.filter(t=>t.status===s).length);
      const byPriority = ['Baixa','Média','Alta','Crítica'].map(p=> tasks.filter(t=>t.priority===p).length);

      const ctx1 = document.getElementById('statusChart');
      if (statusChart) statusChart.destroy();
      // UI: Cores dinâmicas Chart.js via CSS
      const cs = getComputedStyle(document.documentElement);
      const chartColors = {
        bg: cs.getPropertyValue('--chart-bg').trim(),
        fg: cs.getPropertyValue('--chart-fg').trim(),
        emerald: cs.getPropertyValue('--chart-emerald').trim(),
        sky: cs.getPropertyValue('--chart-sky').trim(),
        amber: cs.getPropertyValue('--chart-amber').trim(),
        rose: cs.getPropertyValue('--chart-rose').trim(),
        slate: cs.getPropertyValue('--chart-slate').trim(),
      };
      statusChart = new Chart(ctx1, {
        type: 'bar',
        data: {
          labels: ['Backlog','Em andamento','Bloqueado','Concluído'],
          datasets: [{
            label: 'Qtde',
            data: byStatus,
            backgroundColor: [
              '#00C853', // Verde vivo
              '#FFD600', // Amarelo vivo
              '#2962FF', // Azul vivo
              '#D50000'  // Vermelho vivo
            ],
            borderRadius: 6,
            borderSkipped: false
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: chartColors.bg,
              titleColor: chartColors.fg,
              bodyColor: chartColors.fg,
              borderColor: chartColors.slate,
              borderWidth: 1
            },
            datalabels: { display: false }
          },
          animation: false,
          layout: { padding: 0 },
          scales: {
            x: {
              beginAtZero: true,
              grid: { color: chartColors.slate+"22" },
              ticks: { color: chartColors.fg }
            },
            y: {
              beginAtZero: true,
              max: Math.max(...byStatus, 5),
              grid: { color: chartColors.slate+"22" },
              ticks: { color: chartColors.fg }
            }
          }
        },
        plugins: []
      });

      const ctx2 = document.getElementById('priorityChart');
      if (priorityChart) priorityChart.destroy();
      priorityChart = new Chart(ctx2, {
        type: 'doughnut',
        data: {
          labels: ['Baixa','Média','Alta','Crítica'],
          datasets: [{
            data: byPriority,
            backgroundColor: [
              '#00C853', // Verde vivo
              '#FFD600', // Amarelo vivo
              '#2962FF', // Azul vivo
              '#D50000'  // Vermelho vivo
            ],
            borderColor: chartColors.bg,
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                color: chartColors.fg,
                font: { size: 13, family: 'inherit' }
              }
            },
            tooltip: {
              backgroundColor: chartColors.bg,
              titleColor: chartColors.fg,
              bodyColor: chartColors.fg,
              borderColor: chartColors.slate,
              borderWidth: 1
            },
            datalabels: { display: false }
          },
          animation: false,
          layout: { padding: 0 }
        },
        plugins: []
      });
    }

    // ====== Render Lista ======
    function applyFilters(list) {
      const q = document.getElementById('search').value.toLowerCase().trim();
      const tagsOnly = document.getElementById('searchTagsOnly').checked;
      const fs = document.getElementById('filterStatus').value;
      const fp = document.getElementById('filterPriority').value;
      const fa = document.getElementById('filterAssignee').value.toLowerCase().trim();
      return list.filter(t=>{
        let condQ;
        if (tagsOnly) {
          condQ = q ? (t.tags||[]).some(tag => tag.toLowerCase().includes(q)) : true;
        } else {
          // Incluir sequential_id na busca
          const text = [t.title, t.assignee, (t.tags||[]).join(','), t.description, t.sequential_id].join(' ').toLowerCase();
          condQ = q ? text.includes(q) : true;
        }
        const condS = fs? t.status===fs: true;
        const condP = fp? t.priority===fp: true;
        const condA = fa? (t.assignee||'').toLowerCase().includes(fa): true;
        return condQ && condS && condP && condA;
      });
    }

    function renderList() {
      let list = applyFilters(tasks);
      // Ordena pelo prazo mais próximo do vencimento (ascendente), tarefas sem prazo vão para o final
      list = list.slice().sort((a, b) => {
        const pa = a.due_date || a.due;
        const pb = b.due_date || b.due;
        if (!pa && !pb) return 0;
        if (!pa) return 1;
        if (!pb) return -1;
        return new Date(pa) - new Date(pb);
      });
      const tbody = document.getElementById('taskTable');
      tbody.innerHTML = '';
      document.getElementById('emptyList').classList.toggle('hidden', list.length!==0);
      list.forEach((t, idx) => {
        const tr = document.createElement('tr');
        // Zebra: linhas pares com leve fundo
        tr.className = 'hover:bg-slate-100' + (idx % 2 === 1 ? ' bg-slate-50' : '');
        const prazo = t.due_date || t.due;
        const overdue = prazo && daysDiffFromToday(prazo) < 0 && t.status !== 'Concluído';
        const thumbCount = (t.attachments||[]).length;
        let soon = false;
        let soonText = '';
        if (prazo && !overdue) {
          const diff = daysDiffFromToday(prazo);
          if (diff >= 0 && diff <= 7) {
            soon = true;
            soonText = `<div class='flex justify-center'><span class='inline-block mt-1 px-2 py-0.5 rounded bg-black text-red-500 font-bold text-xs'>D-${diff}</span></div>`;
          }
        }
        tr.innerHTML = `
          <td class="px-4 py-3 font-mono text-sm font-semibold text-slate-600">${t.sequential_id || '-'}</td>
          <td class="px-4 py-3">
            <div class="font-medium">${t.title}</div>
            <div class="text-xs text-slate-500">${t.description? t.description.slice(0,80)+(t.description.length>80?'…':''):'-'}</div>
          </td>
          <td class="px-4 py-3">${t.assignee||'-'}</td>
          <td class="px-4 py-3 ${overdue?'text-rose-600 font-semibold':''}">
            ${formatDate(prazo)}
            ${soonText}
          </td>
          <td class="px-4 py-3">${badgePriority(t.priority)}</td>
          <td class="px-4 py-3">${badgeStatus(t.status)}</td>
          <td class="px-4 py-3">${(t.tags||[]).map(x=>`<span class='text-xs bg-slate-100 rounded px-2 py-0.5 mr-1'>${x}</span>`).join('')}</td>
          <td class="px-4 py-3">${thumbCount>0? thumbCount+' img':''}</td>
          <td class="px-4 py-3 text-right">
            <div class="flex justify-end gap-2">
              <button class="px-3 py-1 rounded-xl bg-slate-200" data-act="view" data-id="${t.id}">Ver</button>
              <button class="px-3 py-1 rounded-xl bg-amber-200" data-act="edit" data-id="${t.id}">Editar</button>
              <button class="px-3 py-1 rounded-xl bg-rose-200" data-act="del" data-id="${t.id}">Excluir</button>
            </div>
          </td>`;
        tbody.appendChild(tr);
      });
    }

    // ====== Render Kanban ======
    const columns = ['Backlog','Em andamento','Bloqueado','Concluído'];
    function renderKanban() {
      const container = document.getElementById('viewKanban');
      container.innerHTML='';
      // Cores e ícones para colunas
      const colMeta = {
        'Backlog':   { color: 'bg-slate-50', icon: `<svg width='18' height='18' fill='none' stroke='currentColor' stroke-width='2' viewBox='0 0 24 24'><rect x='3' y='7' width='18' height='13' rx='2'/><path d='M16 3v4M8 3v4'/></svg>` },
        'Em andamento': { color: 'bg-sky-50', icon: `<svg width='18' height='18' fill='none' stroke='currentColor' stroke-width='2' viewBox='0 0 24 24'><circle cx='12' cy='12' r='10'/><path d='M12 6v6l4 2'/></svg>` },
        'Bloqueado': { color: 'bg-rose-50', icon: `<svg width='18' height='18' fill='none' stroke='currentColor' stroke-width='2' viewBox='0 0 24 24'><rect x='3' y='11' width='18' height='7' rx='2'/><path d='M7 11V7a5 5 0 0 1 10 0v4'/></svg>` },
        'Concluído': { color: 'bg-emerald-50', icon: `<svg width='18' height='18' fill='none' stroke='currentColor' stroke-width='2' viewBox='0 0 24 24'><path d='M5 13l4 4L19 7'/></svg>` },
      };
      columns.forEach(col => {
        const colDiv = document.createElement('div');
        colDiv.className = `${colMeta[col].color} rounded-2xl shadow-sm p-3 flex flex-col min-h-[260px]`;
        // Contagem de cards na coluna
        const count = applyFilters(tasks).filter(t => t.status === col).length;
        colDiv.innerHTML = `
          <div class='flex items-center gap-2 mb-2 sticky top-0 z-10'>
            <span class='inline-flex items-center justify-center rounded-full bg-white p-1 border border-slate-200'>${colMeta[col].icon}</span>
            <span class='font-semibold text-black'>${col}</span>
            <span class='ml-auto text-xs font-bold bg-slate-100 text-black rounded-full px-2 py-0.5'>${count}</span>
          </div>
          <div class='space-y-3 overflow-auto' style='min-height:200px; max-height:60vh' data-col='${col}'></div>`;
        container.appendChild(colDiv);
      });

      const list = applyFilters(tasks);
      list.forEach(t => {
        const card = document.createElement('div');
        card.className = 'rounded-xl border border-slate-200 p-3 bg-white shadow-sm flex flex-col gap-2 text-black';
        const prazo = t.due_date || t.due;
        const overdue = prazo && daysDiffFromToday(prazo) < 0 && t.status !== 'Concluído';
        const soon = prazo && daysDiffFromToday(prazo) >= 0 && daysDiffFromToday(prazo) <= 7 && t.status !== 'Concluído';
        // Chip de prazo
        let prazoChip = '';
        if (overdue) prazoChip = `<span class='ml-2 inline-block px-2 py-0.5 rounded-full text-xs font-semibold bg-rose-50 text-rose-700 border border-rose-100' aria-label='Vencida'>Vencida</span>`;
        else if (soon) prazoChip = `<span class='ml-2 inline-block px-2 py-0.5 rounded-full text-xs font-semibold bg-amber-50 text-amber-700 border border-amber-100' aria-label='D-${daysDiffFromToday(prazo)}'>D-${daysDiffFromToday(prazo)}</span>`;
        else if (prazo && daysDiffFromToday(prazo) === 0) prazoChip = `<span class='ml-2 inline-block px-2 py-0.5 rounded-full text-xs font-semibold bg-sky-50 text-sky-700 border border-sky-100' aria-label='Hoje'>Hoje</span>`;
        const imgs = (t.attachments||[]).slice(0,2).map(a=>`<img src='${a.dataURL}' alt='Miniatura do anexo da tarefa ${t.title}' class='h-8 w-8 object-cover rounded-lg border border-slate-200' loading='lazy'/>`).join('');
        card.innerHTML = `
          <div class='flex items-start justify-between gap-2'>
            <div class='flex-1 min-w-0'>
              <div class='flex items-center gap-2 mb-1'>
                <span class='text-xs font-mono bg-slate-200 px-2 py-0.5 rounded text-slate-600'>${t.sequential_id || '-'}</span>
              </div>
              <div class='font-medium text-black truncate'>${t.title}</div>
              <div class='text-xs text-slate-700 truncate'>${t.assignee||'-'} • ${formatDate(prazo)}${prazoChip}</div>
            </div>
            <div class='text-xs'>${badgePriority(t.priority)}</div>
          </div>
          <div class='flex flex-wrap items-center gap-2 mt-1'>${(t.tags||[]).map(x=>`<span class='text-xs font-medium bg-slate-100 border border-slate-200 rounded px-2 py-0.5 mr-1'>${x}</span>`).join('')}${imgs}</div>
          <div class='flex justify-end gap-2 mt-2'>
            <button class='px-2 py-1 rounded-xl bg-slate-200 text-xs' data-act='view' data-id='${t.id}' aria-label='Ver detalhes'><svg width='14' height='14' fill='none' stroke='currentColor' stroke-width='2' viewBox='0 0 24 24'><circle cx='12' cy='12' r='10'/><circle cx='12' cy='12' r='4'/></svg></button>
            <button class='px-2 py-1 rounded-xl bg-amber-200 text-xs' data-act='edit' data-id='${t.id}' aria-label='Editar'><svg width='14' height='14' fill='none' stroke='currentColor' stroke-width='2' viewBox='0 0 24 24'><path d='M12 20h9'/><path d='M16.5 3.5a2.121 2.121 0 1 1 3 3L7 19l-4 1 1-4 12.5-12.5z'/></svg></button>
            <button class='px-2 py-1 rounded-xl bg-rose-200 text-xs' data-act='del' data-id='${t.id}' aria-label='Excluir'><svg width='14' height='14' fill='none' stroke='currentColor' stroke-width='2' viewBox='0 0 24 24'><path d='M3 6h18M8 6v12a2 2 0 0 0 2 2h4a2 2 0 0 0 2-2V6'/></svg></button>
          </div>`;
        container.querySelector(`[data-col='${t.status}']`).appendChild(card);
      });
    }

    // ====== Modais ======
    const modal = document.getElementById('taskModal');
    const form = document.getElementById('taskForm');
    const detailModal = document.getElementById('detailModal');

    document.getElementById('btnNew').addEventListener('click', ()=>{
      editingId = null; anexosTemp = []; renderThumbs();
      form.reset();
      document.getElementById('modalTitle').textContent = 'Nova Atividade';
      modal.showModal();
    });
    document.getElementById('btnCloseModal').addEventListener('click', ()=> modal.close());

    // ====== Anexos ======
    function renderThumbs() {
  const wrap = document.getElementById('thumbs');
  wrap.innerHTML = '';
  anexosTemp.forEach((a,idx)=>{
    const d = document.createElement('div');
    d.className = 'relative';
    d.innerHTML = `
      <img src='${a.dataURL}' class='h-20 w-20 object-cover rounded-xl border'/>
      <button type='button' class='absolute -top-2 -right-2 bg-rose-600 text-white rounded-full h-6 w-6 text-xs' data-rm='${idx}'>×</button>`;
    wrap.appendChild(d);
  });
}

    const dropArea = document.getElementById('dropArea');
    ;['dragenter','dragover'].forEach(evt=> dropArea.addEventListener(evt, (e)=>{ e.preventDefault(); dropArea.classList.add('dragover'); }));
    ;['dragleave','drop'].forEach(evt=> dropArea.addEventListener(evt, (e)=>{ e.preventDefault(); dropArea.classList.remove('dragover'); }));
    dropArea.addEventListener('drop', async (e)=>{
      const files = [...e.dataTransfer.files].filter(f=> f.type.startsWith('image/'));
      for (const f of files) { anexosTemp.push({ name: f.name, dataURL: await fileToDataURL(f) }); }
      renderThumbs();
    });

    function fileToDataURL(file) {
      return new Promise((res, rej)=>{
        const fr = new FileReader();
        fr.onload = ()=> res(fr.result);
        fr.onerror = rej; fr.readAsDataURL(file);
      });
    }

    document.getElementById('btnClearAnexos').addEventListener('click', ()=>{ anexosTemp = []; renderThumbs(); });

    // ====== Salvar / Editar ======
    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const fd = new FormData(form);
      const data = Object.fromEntries(fd.entries());
      const tags = (data.tags||'').split(',').map(x=>x.trim()).filter(Boolean);
      if (editingId) {
          const idx = tasks.findIndex(t=>t.id===editingId);
          let editTask = { ...tasks[idx], ...data, tags, attachments: [...anexosTemp] };
          // Corrige nome do campo de data para Supabase
          if (editTask.due) {
            editTask.due_date = editTask.due;
            delete editTask.due;
          }
          // Remove anexos antigos do Supabase antes de salvar novos
          await supabaseClient.from('task_attachments').delete().eq('task_id', editTask.id);
          await supabaseInsertTask(editTask);
        } else {
          const sequentialId = generateSequentialId();
          const nova = { 
            id: uuidv4(), 
            sequential_id: sequentialId,
            title: data.title, 
            assignee: data.assignee||'', 
            due: data.due||'', 
            priority: data.priority||'Média', 
            status: data.status||'Backlog', 
            description: data.description||'', 
            tags, 
            attachments: [...anexosTemp], 
            createdAt: new Date().toISOString() 
          };
          await supabaseInsertTask(nova);
        }
  modal.close();
  await loadTasksFromSupabase();
  await refreshAll();
    });

    // ====== Ações da Lista/Kanban ======
    document.getElementById('taskTable').addEventListener('click', onActionClick);
    document.getElementById('viewKanban').addEventListener('click', onActionClick);

    async function onActionClick(e) {
      const btn = e.target.closest('button');
      if (!btn) return;
      const act = btn.getAttribute('data-act');
      const id = btn.getAttribute('data-id');
      const t = tasks.find(x=>x.id===id);
      if (!t) return;
        if (act==='del') {
            if (confirm('Excluir esta atividade?')) {
              const { error } = await supabaseDeleteTask(id);
              if (error) {
                alert('Erro ao excluir no Supabase!');
                console.error('Erro ao excluir no Supabase:', error);
                return;
              }
              await refreshAll();
            }
        }
  if (act==='edit') { openEdit(t); }
  if (act==='view') { openDetail(t); }
    }

    function openEdit(t) {
      editingId = t.id;
      anexosTemp = [...(t.attachments||[])];
      renderThumbs();
      form.title.value = t.title || '';
      form.assignee.value = t.assignee || '';
  form.due.value = t.due_date || t.due || '';
      form.priority.value = t.priority || 'Média';
      form.status.value = t.status || 'Backlog';
      form.description.value = t.description || '';
      form.tags.value = (t.tags||[]).join(', ');
      document.getElementById('modalTitle').textContent = 'Editar Atividade';
      modal.showModal();
    }

    function openDetail(t) {
      const body = document.getElementById('detailBody');
      body.innerHTML = `
        <div class='flex items-center gap-2 mb-3'>
          <span class='text-xs font-mono bg-slate-200 px-2 py-1 rounded text-slate-600'>${t.sequential_id || '-'}</span>
          <span class='text-slate-500'>ID:</span>
        </div>
        <div><span class='text-slate-500'>Título:</span> <span class='font-medium'>${t.title}</span></div>
        <div class='grid grid-cols-2 gap-2'>
          <div><span class='text-slate-500'>Responsável:</span> ${t.assignee||'-'}</div>
          <div><span class='text-slate-500'>Prazo:</span> ${formatDate(t.due_date || t.due)}</div>
          <div><span class='text-slate-500'>Prioridade:</span> ${badgePriority(t.priority)}</div>
          <div><span class='text-slate-500'>Status:</span> ${badgeStatus(t.status)}</div>
        </div>
        <div><span class='text-slate-500'>Descrição:</span><div class='mt-1'>${t.description||'-'}</div></div>
        <div><span class='text-slate-500'>Tags:</span> ${(t.tags||[]).map(x=>`<span class='text-xs bg-slate-100 rounded px-2 py-0.5 mr-1'>${x}</span>`).join('') || '-'}</div>
        <div>
          <span class='text-slate-500'>Anexos:</span>
          <div class='mt-2 flex flex-wrap gap-2'>
            ${(t.attachments||[]).map(a=>`<a href='${a.dataURL}' target='_blank' class='block'><img src='${a.dataURL}' class='h-24 w-24 object-cover rounded-xl border' alt='Anexo da tarefa ${t.title}' loading='lazy'/></a>`).join('') || '<span>-</span>'}
          </div>
        </div>`;
      detailModal.showModal();
    }

    document.getElementById('btnCloseDetail').addEventListener('click', ()=> detailModal.close());
    document.getElementById('btnCloseDetail2').addEventListener('click', ()=> detailModal.close());

    // ====== Filtros & Tabs ======
    ['search','filterStatus','filterPriority','filterAssignee'].forEach(id=> document.getElementById(id).addEventListener('input', refreshViews));
  document.getElementById('tabList').addEventListener('click', ()=> switchTab('list'));
  document.getElementById('tabKanban').addEventListener('click', ()=> switchTab('kanban'));
    function switchTab(which) {
      document.getElementById('viewList').classList.toggle('hidden', which!=='list');
      document.getElementById('viewKanban').classList.toggle('hidden', which!=='kanban');
      refreshViews();
    }

    // ====== Import/Export/Reset ======
    document.getElementById('btnExport').addEventListener('click', ()=>{
      const blob = new Blob([JSON.stringify(tasks, null, 2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `atividades_${new Date().toISOString().slice(0,10)}.json`;
      a.click();
      URL.revokeObjectURL(a.href);
    });

    document.getElementById('inputImport').addEventListener('change', async (e)=>{
      const file = e.target.files[0]; if (!file) return;
      const text = await file.text();
      let importOk = false;
      try {
        const data = JSON.parse(text);
        if (Array.isArray(data)) {
          // Garante que cada atividade tenha um id UUID válido e tags/attachments como array
          const importTasks = data.map((t) => {
            let validId = t.id;
            const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;
            if (!validId || !uuidRegex.test(validId)) validId = uuidv4();
            
            // Se não tem sequential_id, gera um novo
            let sequentialId = t.sequential_id;
            if (!sequentialId) {
              sequentialId = generateSequentialId();
            }
            
            return {
              ...t,
              id: validId,
              sequential_id: sequentialId,
              tags: Array.isArray(t.tags) ? t.tags : (typeof t.tags === 'string' ? t.tags.split(',').map(x=>x.trim()).filter(Boolean) : []),
              attachments: Array.isArray(t.attachments) ? t.attachments : []
            };
          });
          await supabaseBulkInsertTasks(importTasks);
          alert('Importado com sucesso!');
          importOk = true;
          await refreshAll();
        } else {
          alert('Arquivo inválido.');
        }
      } catch {
        if (!importOk) alert('JSON inválido.');
      }
      e.target.value = '';
    });

    document.getElementById('btnReset').addEventListener('click', async ()=>{
      if (confirm('Apagar todas as atividades e limpar o armazenamento local?')) {
        const senha = prompt('Digite a senha para confirmar o reset:');
        if (senha === '0000') {
          // Deleta todas as tarefas e anexos do Supabase
          // Buscar todos os ids das tarefas
          const { data: tasksData, error: errGetTasks } = await supabaseClient.from('tasks').select('id');
          const { data: attachData, error: errGetAttach } = await supabaseClient.from('task_attachments').select('id');
          let errTasks = null, errAttach = null;
          if (tasksData && tasksData.length > 0) {
            const ids = tasksData.map(t => t.id);
            const res = await supabaseClient.from('tasks').delete().in('id', ids);
            errTasks = res.error;
          }
          if (attachData && attachData.length > 0) {
            const ids = attachData.map(a => a.id);
            const res = await supabaseClient.from('task_attachments').delete().in('id', ids);
            errAttach = res.error;
          }
          if (errTasks || errAttach) {
            alert('Erro ao deletar dados do Supabase!');
            console.error('Erro ao deletar tasks:', errTasks);
            console.error('Erro ao deletar anexos:', errAttach);
            return;
          }
          tasks = []; save(); refreshAll();
        } else {
          alert('Senha incorreta. Operação cancelada.');
        }
      }
    });

    // ====== Event Listeners do Modal de Status ======
    const statusModal = document.getElementById('statusModal');
    
    // Abrir modal de status
    document.getElementById('btnManageStatus').addEventListener('click', ()=>{
      renderStatusList();
      statusModal.showModal();
    });
    
    // Fechar modal de status
    document.getElementById('btnCloseStatusModal').addEventListener('click', ()=> statusModal.close());
    document.getElementById('btnCloseStatusModal2').addEventListener('click', ()=> statusModal.close());
    
    // Adicionar novo status
    document.getElementById('btnAddStatus').addEventListener('click', ()=>{
      const name = document.getElementById('newStatusName').value;
      const color = document.getElementById('newStatusColor').value;
      
      if (addNewStatus(name, color)) {
        document.getElementById('newStatusName').value = '';
        document.getElementById('newStatusColor').value = 'bg-slate-200 text-slate-800';
        refreshViews();
      }
    });
    
    // Salvar status no Supabase
    document.getElementById('btnSaveStatusToSupabase').addEventListener('click', saveStatusToSupabase);
    
    // Permitir adicionar status com Enter
    document.getElementById('newStatusName').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        document.getElementById('btnAddStatus').click();
      }
    });
    
    // Tornar funções globais para uso no HTML
    window.deleteCustomStatus = deleteCustomStatus;
    window.editCustomStatus = editCustomStatus;

    // ====== Refresh geral ======
    function refreshViews() {
      renderList();
      renderKanban();
    }
    function refreshAll() {
      kpi.render();
      refreshCharts();
      refreshViews();
      // Força exibir todas as tarefas se tasks estiver vazio
      if (!tasks || tasks.length === 0) {
        document.getElementById('emptyList').classList.remove('hidden');
      }
    }

    // Inicializar
    // Inicializar
    async function startApp() {
      document.getElementById('loadingList').classList.remove('hidden');
      document.getElementById('errorList').classList.add('hidden');
      document.getElementById('emptyList').classList.add('hidden');
      try {
        // Carregar status personalizados primeiro
        loadCustomStatus();
        await loadStatusFromSupabase();
        
        // Carregar tarefas
        await loadTasksFromSupabase();
        
        // Atualizar selects com status personalizados
        updateStatusSelects();
        
        await refreshAll();
        document.getElementById('loadingList').classList.add('hidden');
        if (!tasks || tasks.length === 0) {
          document.getElementById('emptyList').classList.remove('hidden');
        }
      } catch (e) {
        document.getElementById('loadingList').classList.add('hidden');
        document.getElementById('errorList').classList.remove('hidden');
        console.error('Erro na inicialização:', e);
      }
    }
    startApp();
    // Exportar PDF do Dashboard (restaurado e robusto)
    function setupPDFExportButton() {
      const btnExportPDF = document.getElementById('btnExportPDF');
      if (!btnExportPDF) return;
      btnExportPDF.onclick = function () {
        if (!window.html2pdf) {
          const script = document.createElement('script');
          script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js';
          script.onload = exportDashboardPDF;
          document.body.appendChild(script);
        } else {
          exportDashboardPDF();
        }
      };
    }

    function exportDashboardPDF() {
      // Ativa datalabels só para exportação
      const originalStatus = { ...statusChart.options.plugins.datalabels };
      const originalPriority = { ...priorityChart.options.plugins.datalabels };
      statusChart.options.plugins.datalabels = {
        ...originalStatus,
        anchor: 'end',
        align: 'top',
        color: '#0f172a',
        font: { weight: 'bold', size: 14 },
        formatter: function(value) { return value; },
        display: true
      };
      priorityChart.options.plugins.datalabels = {
        ...originalPriority,
        color: '#0f172a',
        font: { weight: 'bold', size: 14 },
        formatter: function(value, ctx) {
          const label = ctx.chart.data.labels[ctx.dataIndex];
          return value > 0 ? label + ': ' + value : '';
        },
        display: true
      };
      statusChart.update();
      priorityChart.update();

      // Monta o dashboard para PDF
      const dashboard = document.createElement('div');
      dashboard.style.background = getComputedStyle(document.body).backgroundColor;
      dashboard.style.color = getComputedStyle(document.body).color;
      dashboard.style.padding = '24px';
      dashboard.className = 'bg-slate-50 text-slate-800';
      // Título
      const titulo = document.createElement('h1');
      titulo.textContent = 'Implantação de Controles de Fechamento';
      titulo.style.fontSize = '2rem';
      titulo.style.fontWeight = 'bold';
      titulo.style.marginBottom = '24px';
      dashboard.appendChild(titulo);
      // KPIs
      const kpi = document.getElementById('kpiCards').cloneNode(true);
      dashboard.appendChild(kpi);
      // Charts: copiar os títulos e os CANVAS renderizados
      const chartsSection = document.createElement('section');
      chartsSection.className = 'grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6';
      // Status das Atividades
      const chart1Div = document.createElement('div');
      chart1Div.className = 'bg-white rounded-2xl shadow p-4';
      const chart1Title = document.createElement('h2');
      chart1Title.className = 'font-semibold mb-2';
      chart1Title.textContent = 'Status das Atividades';
      chart1Div.appendChild(chart1Title);
      // Copia o canvas renderizado
      const statusCanvas = document.getElementById('statusChart');
      const statusImg = document.createElement('img');
      statusImg.src = statusCanvas.toDataURL('image/png');
      statusImg.style.width = '100%';
      statusImg.style.maxHeight = '280px';
      chart1Div.appendChild(statusImg);
      chartsSection.appendChild(chart1Div);
      // Prioridade
      const chart2Div = document.createElement('div');
      chart2Div.className = 'bg-white rounded-2xl shadow p-4';
      const chart2Title = document.createElement('h2');
      chart2Title.className = 'font-semibold mb-2';
      chart2Title.textContent = 'Prioridade';
      chart2Div.appendChild(chart2Title);
      const priorityCanvas = document.getElementById('priorityChart');
      const priorityImg = document.createElement('img');
      priorityImg.src = priorityCanvas.toDataURL('image/png');
      priorityImg.style.width = '100%';
      priorityImg.style.maxHeight = '280px';
      chart2Div.appendChild(priorityImg);
      chartsSection.appendChild(chart2Div);
      dashboard.appendChild(chartsSection);
      html2pdf().set({
        margin: 0.5,
        filename: 'dashboard_atividades.pdf',
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2, backgroundColor: null },
        jsPDF: { unit: 'in', format: 'a4', orientation: 'landscape' }
      }).from(dashboard).save().then(()=>{
        // Restaura o estado original dos gráficos
        statusChart.options.plugins.datalabels = originalStatus;
        priorityChart.options.plugins.datalabels = originalPriority;
        statusChart.update();
        priorityChart.update();
      });
    }

    // Garante que os handlers dos botões de relatório sejam sempre aplicados após o carregamento
    window.addEventListener('DOMContentLoaded', function() {
      setupPDFExportButton();
      // Handler para Lista PDF
      const btnExportListPDF = document.getElementById('btnExportListPDF');
      if (btnExportListPDF) {
        btnExportListPDF.onclick = function () {
          if (!window.html2pdf) {
            const script = document.createElement('script');
            script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js';
            script.onload = exportListPDF;
            document.body.appendChild(script);
          } else {
            exportListPDF();
          }
        };
      }
    });

    // Função para exportar a lista filtrada em PDF usando jsPDF autotable
    function exportListPDF() {
      let list = applyFilters(tasks);
      // Ordena pelo prazo mais próximo do vencimento (ascendente), tarefas sem prazo vão para o final
      list = list.slice().sort((a, b) => {
        const pa = a.due_date || a.due;
        const pb = b.due_date || b.due;
        if (!pa && !pb) return 0;
        if (!pa) return 1;
        if (!pb) return -1;
        return new Date(pa) - new Date(pb);
      });

      // Cabeçalhos da tabela
      const headers = [
        'ID',
        'Título',
        'Responsável',
        'Prazo',
        'Prioridade',
        'Status',
        'Tags'
      ];

      // Dados da tabela
      const data = list.map(t => [
        t.sequential_id || '-',
        t.title || '-',
        t.assignee || '-',
        formatDate(t.due_date || t.due),
        t.priority || '-',
        t.status || '-',
        (t.tags || []).join(', ') || '-'
      ]);

      // Cria o PDF
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation: 'landscape', unit: 'pt', format: 'a4' });

      doc.setFontSize(16);
      doc.text('Lista de Atividades Filtradas', 40, 40);

      doc.autoTable({
        head: [headers],
        body: data,
        startY: 60,
        margin: { left: 20, right: 20 },
        styles: { fontSize: 9, cellPadding: 3 },
        headStyles: { fillColor: [30, 64, 175], textColor: 255, fontStyle: 'bold' },
        alternateRowStyles: { fillColor: [241, 245, 249] },
        didDrawPage: function (data) {
          doc.setFontSize(10);
          doc.setTextColor(150);
          doc.text('Gerado em: ' + new Date().toLocaleString('pt-BR'), data.settings.margin.left, doc.internal.pageSize.height - 10);
        }
      });

      doc.save('lista_atividades.pdf');
    }
  </script>
</body>
</html>